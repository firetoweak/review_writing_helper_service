<!DOCTYPE html>
<html>

{% include "admin/base.html" %}
<body class="skin-blue">
<style>
    .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2002;
        background-color: rgba(0, 0, 0, 0.7);
    }
    .image-modal-container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        max-width: 90%;
        max-height: 90%;
        z-index: 2002;
    }

    .btn-close {
        width: 24px;
        height: 24px;
        background: transparent;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: transparent;
        z-index: 2001;
        display: none;
    }
    .image-modal .btn-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        cursor: pointer;
        z-index: 2;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .image-modal-content {
        overflow: auto;
        max-height: 80vh;
        text-align: center;
    }
    #ai-val-tr img{
        width: 50px;
        height: 50px;
    }
    .shake_show{
        color: #0a53be;
        cursor: pointer;
    }
</style>
<!-- header logo: style can be found in header.less -->
{% include "admin/header.html" %}

<div class="wrapper row-offcanvas row-offcanvas-left">
    <aside class="left-side sidebar-offcanvas">
        <!-- sidebar: style can be found in sidebar.less -->
        <section class="sidebar">
            <!-- Sidebar user panel -->
            <!-- search form -->
            <!-- /.search form -->
            <!-- sidebar menu: : style can be found in sidebar.less -->
            {% include "admin/menu.html" %}
        </section>
        <!-- /.sidebar -->
    </aside>

    <!-- Right side column. Contains the navbar and content of the page -->
    <aside class="right-side">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                评估列表
                <small>Preview page</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i> 登录页</a></li>
                <li class="active">文档列表</li>
            </ol>
        </section>
        <section class="content">
            <div style="float: left;width: 100%;margin-bottom: 5px">
                <div style="float: left;width: 5%;margin-top: 5px"> <input type="checkbox"  class="icheck-me"><a  id="delete_all" url="/admin/aiVal_batch_delete" style="cursor: pointer">删除选中</a></div>
                <div  style="float: left;width: 10%">
<!--                    <select id="type" class="form-control">-->
<!--                        <option value="-1">全部类型</option>-->
<!--                        <option value="0" {% if type==0 %} selected {% endif %}>缺陷管理</option>-->
<!--                        <option value="1"  {% if type==1 %} selected {% endif %}>需求管理</option>-->
<!--                    </select>-->
                </div>
                <div style="float: left;width: 15%;margin-left: 10px">
                    <input id="search" name="search" class="form-control" placeholder="用户名:邮件/手机号码/缺陷ID号" value="{{search}}">
                </div>
                <div style="float: left;width: 20%; margin-left: 5px">
                    <button id="sub" type="button" class="btn btn-primary">搜索</button>
                    <button id="batchExport" type="button" class="btn btn-warning">批量导出</button>
                </div>
            </div>
        </section>

        <section class="content"  id="tb">
            {% for item in items %}
            {% if item[0].type==0 %}
            <div class="box-body" id="ai-val-tr">
                <input type="checkbox" name="ids" value="{{item[0].id}}">
                ID: {{item[0].id}} &nbsp;&nbsp;&nbsp;  &nbsp;用户: {% if item[1].admin_user_id==0 %} {{item[1].mobile}} {%else %} {{item[1].email}} {% endif %}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;类型:  缺陷
                &nbsp;&nbsp;创建时间：{{item[0].create_time}}&nbsp;&nbsp;模型：{{item[0].model_name}} &nbsp; <a class="shake_show" data-id="{{item[0].id}}">评分日志</a>
                <div style="float: left;width: 100%;display: none" id="shake_log_{{item[0].id}}">

                    <b style="color: red">评分日志</b><br>{{item[0].log_content|safe}}{% if item[0].log_content==""  %} 无 {% endif %}
                </div>
                <table class="table table-bordered">
                    <tbody>
                    <tr>
                        <th style="width: 5%">评估项</th>
                        <th style="width: 45%">内容</th>
                        <th  style="width: 45%">AI建议</th>
                        <th>评分(满分10分)</th>
                    </tr>
                    <tr>
                        <td>产品缺陷描述</td>
                        <td>{{item[0].step1|safe}}</td>
                        <td>
                            {{item[0].ai_step1|safe}}
                        </td>
                        <td><span class="badge bg-red">{{item[0].step1_score}}</span></td>
                    </tr>
                    <tr>
                        <td>原因分析 </td>
                        <td>{{item[0].step2|safe}}</td>
                        <td>
                            {{item[0].ai_step2|safe}}
                        </td>
                        <td><span class="badge bg-yellow">{{item[0].step2_score}}</span></td>
                    </tr>
                    <tr>
                        <td>解决措施实施</td>
                        <td>{{item[0].step3|safe}}</td>
                        <td>
                            {{item[0].ai_step3|safe}}
                        </td>
                        <td><span class="badge bg-light-blue">{{item[0].step3_score}}</span></td>
                    </tr>
                    <tr>
                        <td>回归测试</td>
                        <td>{{item[0].step4|safe}}</td>
                        <td>
                            {{item[0].ai_step4|safe}}
                        </td>
                        <td><span class="badge bg-green">{{item[0].step4_score}}</span></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="box-body" id="ai-val-tr">
                <input type="checkbox" name="ids" value="{{item[0].id}}">
                ID: {{item[0].id}} &nbsp;&nbsp;&nbsp;  &nbsp;用户:{% if item[1].admin_user_id==0 %} {{item[1].mobile}} {%else %} {{item[1].email}} {% endif%}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;类型: 需求
                &nbsp;&nbsp;&nbsp;创建时间：{{item[0].create_time}}&nbsp;&nbsp;模型：{{item[0].model_name}} &nbsp; <a class="shake_show" data-id="{{item[0].id}}">评分日志</a>
                <div style="float: left;width: 100%;display: none" id="shake_log_{{item[0].id}}">
                    <b style="color: red">评分日志</b><br>{{item[0].log_content|safe}}{% if item[0].log_content==""  %} 无 {% endif %}
                </div>
                <table class="table table-bordered" style="margin-bottom: 0px">
                    <tbody>
                    <tr>
                        <th style="width: 5%">评估项</th>
                        <th style="width: 45%">内容</th>
                        <th  style="width: 45%">AI建议 </th>
                        <th>评分(满分10分)</th>
                    </tr>
                    <tr>
                        <td>需求描述</td>
                        <td>{{item[0].step1|safe}}</td>
                        <td>
                            {{item[0].ai_step1|safe}}
                        </td>
                        <td><span class="badge bg-red"> {{item[0].step1_score}}</span></td>
                    </tr>
                    <tr>
                        <td>需求分析 </td>
                        <td>{{item[0].step2|safe}}</td>
                        <td>
                            {{item[0].ai_step2|safe}}
                        </td>
                        <td><span class="badge bg-yellow">{{item[0].step2_score}}</span></td>
                    </tr>
                    <tr>
                        <td>需求决策</td>
                        <td>{{item[0].step3|safe}}</td>
                        <td>
                            {{item[0].ai_step3|safe}}
                        </td>
                        <td><span class="badge bg-light-blue">{{item[0].step3_score}}</span></td>
                    </tr>
                    <tr>
                        <td>验证结果</td>
                        <td>{{item[0].step4|safe}}</td>
                        <td>
                            {{item[0].ai_step4|safe}}
                        </td>
                        <td><span class="badge bg-green">{{item[0].step4_score}}</span></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            {% endif %}
            {% endfor %}
            <ul class="pagination pagination-sm no-margin pull-right">
                {{ pagination.links }}
            </ul>
        </section>
    </aside>
</body>
<!-- 登录弹框背景遮罩 -->
<div class="modal-overlay" id="modalOverlay"  ></div>
<!-- 图片放大模态框 -->
<div class="image-modal" id="imageModal">
    <div class="image-modal-container">
        <button type="button" class="btn-close" id="closeImageModal">
            X
        </button>
        <div class="image-modal-content">
            <img src="" alt="放大图片">
        </div>
    </div>
</div>
</html>

<script src="{{ url_for('static', filename='admin/js/common.js')}}" type="text/javascript"></script>
<script>
    $(function () {
        $('#sub').click(function () {
            location.href = "/admin/usersDocs?search=" + $('#search').val()+"&type={{type}}&menu_pid={{ request.values.get('menu_pid')}}&menu_id={{ request.values.get('menu_pid')}}";
        })

        $('#ai-val-tr img').css('cursor', 'pointer').click(function() {
            const imgSrc = $(this).attr('src');
            $('#imageModal img').attr('src', imgSrc);
            $('#imageModal').fadeIn(300);
            $('body').css('overflow', 'hidden');
        });

        // $('.btn-close, #modalOverlay').on('click', function() {
        //     $('#imageModal, #modalOverlay').fadeOut(300);
        //     $('body').css('overflow', '');
        // });

        const $modal = $('#imageModal');
        const $modalContainer = $('.image-modal-container');
        const $closeButton = $('#closeImageModal');

        // 点击关闭按钮时关闭模态框
        $closeButton.on('click', function() {
            $modal.hide();
        });

        // 点击模态框外部时关闭模态框
        $(document).on('click', function(event) {
            if (!$modalContainer.is(event.target) && $modalContainer.has(event.target).length === 0 && $modal.is(event.target)) {
                $modal.hide();
            }
        });

        $('#batchExport').click(
            function () {
                layer.open({
                    type: 1, // page 层类型
                    area: ['500px', '200px'],
                    title: '批量导出',
                    shade: 0.6, // 遮罩透明度
                    shadeClose: true, // 点击遮罩区域，关闭弹层
                    maxmin: true, // 允许全屏最小化
                    anim: 0, // 0-6 的动画形式，-1 不开启
                    content: `
                              <div style="padding: 32px;text-align: center;">
                                    <input type="text" class="layui-input" id="ID-laydate-shortcut-range-datetime" style="width: 70%;display: block;margin: 0 auto;  " placeholder="请填写时间范围，不填写则导出全部数据">
                              </div>
                               <div style="padding: 32px;text-align: center;padding: 0px">
                                    <button id="exportDone" type="button" class="btn btn-danger" >批量导出</button>
                               </div>
                                `
                });

                var laydate = layui.laydate;
                laydate.render({
                    elem: "#ID-laydate-shortcut-range-datetime",
                    range: '~',
                    format: 'yyyy-MM-dd',
                    shortcuts: [
                        {
                            text: "上个月",
                            value: function(){
                                var date = new Date();
                                var year = date.getFullYear();
                                var month = date.getMonth();
                                return [
                                    new Date(year, month - 1, 1),
                                    new Date(year, month, 0)
                                ];
                            }
                        },
                        {
                            text: "这个月",
                            value: function(){
                                var date = new Date();
                                var year = date.getFullYear();
                                var month = date.getMonth();
                                return [
                                    new Date(year, month, 1),
                                    new Date(year, month + 1, 0)
                                ];
                            }
                        },
                        {
                            text: "下个月",
                            value: function(){
                                var date = new Date();
                                var year = date.getFullYear();
                                var month = date.getMonth();
                                return [
                                    new Date(year, month + 1, 1),
                                    new Date(year, month + 2, 0)
                                ];
                            }
                        }
                    ]
                });

                $('#exportDone').on('click', function() {
                    var date = $('#ID-laydate-shortcut-range-datetime').val()
                    window.open('/admin/export_ai_sug_score?type={{type}}&date='+date)
                    layer.closeAll()
                })
            }
        )

        $('.shake_show').click(function (){
            if($('#shake_log_'+$(this).attr("data-id")).css('display') === 'none'){
                $('#shake_log_'+$(this).attr("data-id")).show()
            }else{
                $('#shake_log_'+$(this).attr("data-id")).hide()
            }
        })




    })
</script>