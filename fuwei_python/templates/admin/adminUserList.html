<!DOCTYPE html>
<html>

<style>
    .input-box{
        width:95%;
        padding:5px;
        margin-top:10px;
        height:40px
    }
    .label-box{
        width: 100%;
        float: left;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .checkbox-item {
        display: flex;
        align-items: center;
        width: 120px;
    }
    .checkbox-item input {
        margin-right: 5px;
    }
</style>
    {% include "admin/base.html" %}
    <body class="skin-blue">
        <!-- header logo: style can be found in header.less -->
        {% include "admin/header.html" %}

        <div class="wrapper row-offcanvas row-offcanvas-left">
            <aside class="left-side sidebar-offcanvas">
                <!-- sidebar: style can be found in sidebar.less -->
                <section class="sidebar">
                    <!-- Sidebar user panel -->
                    <!-- search form -->
                    <!-- /.search form -->
                    <!-- sidebar menu: : style can be found in sidebar.less -->
                       {% include "admin/menu.html" %}
                </section>
                <!-- /.sidebar -->
            </aside>

            <!-- Right side column. Contains the navbar and content of the page -->
            <aside class="right-side">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>
                        后台用户管理
                        <small>Preview page</small>
                    </h1>
                    <ol class="breadcrumb">
                        <li><a href="#"><i class="fa fa-dashboard"></i> 登录页</a></li>
                        <li class="active">后台用户列表</li>
                    </ol>
                </section>
                <section class="content">
                    <div style="float: left;width: 100%;margin-bottom: 5px">
                        <div style="float: left;width: 5%;margin-top: 5px"> <a  id="delete_all" url="/admin/del_mobile_users" style="cursor: pointer">删除选中</a></div>
                        <div style="float: left;width: 15%;margin-left: 10px">
                            <input id="search" name="search" class="form-control" placeholder="手机号/真实姓名" value="{{search}}">
                        </div>
                        <div style="float: left;width: 3%; margin-left: 5px">
                            <button id="sub" type="button" class="btn btn-primary">搜索</button>
                        </div>
                        <div style="float: left;width: 10%; margin-left: 5px">
                            <button id="add_show" type="button" class="btn btn-danger">新增</button>
                        </div>
                    </div>
                </section>

                <section class="content">
                    <table id="example1" class="table table-bordered table-striped">
                        <thead>
                        <tr>
                            <th style="width: 3%">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox"    class="icheck-me">
                                    </label>
                                </div>
                            </th>
                            <th>用户id</th>
                            <th>用户名</th>
                            <th>手机号</th>
                            <th>真实姓名</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="tb">
                        {% for item in items %}
                            <tr>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input row-checkbox"  value="{{item.user_id}}" type="checkbox"  name="id">
                                    </div>
                                </td>
                                <td>{{item.user_id}}</td>
                                <td>{{item.user_name}}</td>
                                <td>{{item.mobile}}</td>
                                <td>{{item.real_name}}</td>
                                <td>
                                    {% if item.user_id!=1  %}
                                    <a style="cursor: pointer"  class="edit_show"  rights="{{item.rights}}" user_id="{{item.user_id}}" user_name="{{item.user_name}}" mobile="{{item.mobile}}" real_name="{{item.real_name}}" >编辑</a>|
                                    <a style="cursor: pointer"  onclick="confirm('你确认要删除吗？')?location.href='/admin/admin_user?act=delete&user_id={{item.user_id}}':''">删除</a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                       </tbody>
                    </table>
                    <ul class="pagination pagination-sm no-margin pull-right">
                        {{ pagination.links }}
                    </ul>
                </section>
            </aside>
    </body>
</html>

<script src="{{ url_for('static', filename='admin/js/common.js')}}" type="text/javascript"></script>
<script>
    $(function () {
        $('#sub').click(function () {
            location.href = "/admin/admin_user?search=" + $('#search').val();
        })
    })

    let html = `
        <form id ="user_profile">
        <div class="input-box">
            <div style="width: 20%;text-align: right;float: left;padding: 5px">
                用户名：
            </div>
            <div style="width: 80%;float: left">
                   <input type="text" id="user_name" name="user_name" class="form-control" placeholder=""  maxlength="11"/>
                   <input type="hidden" id="user_id" name="user_id" placeholder="" />
            </div>
        </div>
        <div class="input-box">
            <div style="width: 20%;text-align: right;float: left;padding: 5px">
                手机号：
            </div>
            <div style="width: 80%;float: left">
                   <input type="text" id="mobile" name="mobile" class="form-control" placeholder="11位手机号码"  maxlength="11"/>
            </div>
        </div>
        <div class="input-box">
            <div style="width: 20%;text-align: right;float: left;padding: 5px">
                真实姓名：
            </div>
            <div style="width: 80%;float: left">
                   <input type="text" id="real_name" name="real_name" class="form-control" placeholder="真实姓名"  maxlength="11"/>
            </div>
        </div>
        <div class="input-box">
            <div style="width: 20%;text-align: right;float: left;padding: 5px">
                密码：
            </div>
            <div style="width: 80%;float: left">
                   <input type="password" id="password" name="password" class="form-control" placeholder="密码：至少6位,不修改则置空"/>
            </div>
        </div>
        <div  class="input-box">
            <div style="width: 20%;text-align: right;float: left;padding: 5px">
                确认密码：
            </div>
            <div style="width: 80%;float: left">
                  <input type="password" id="password2" name="password2" class="form-control" placeholder="确认密码：至少6位,不修改则置空"/>
            </div>
        </div>
        <div  class="input-box" style="height: 170px">
            <div style="width: 20%;text-align: right;float: left;height: 70px;padding-top: 5px">
               <div style="margin-top: ;float: right"><a style="cursor: pointer" id="right_select_all">(全选)</a>权限控制：</div>
            </div>

            <div style="width: 80%;float: left">
                   {% for right in menuRights %}
                        {% if right['child']|length > 0 %}
                         <div style="padding-top: 5px;width: 100%;float: left;color: #6f42c1"><b>{{right.name}}</b></div>
                         <div class="label-box">
                            {% for child in right['child'] %}
                                <label class="checkbox-item">
                                    <input type="checkbox"    style="width: 18px;height:18px" value="{{child.id}}" name="right_id">
                                    <span style="padding-top: 5px;width: 100%">{{child.name}}</span>
                                </label>
                             {% endfor %}
                         </div>
                        {% endif %}
                  {% endfor %}
                   <div class="label-box" style="margin-top: 15px">
                      {% for right in menuRights %}
                           {% if right['child']|length == 0 %}
                                <label class="checkbox-item">
                                    <input type="checkbox"    style="width: 18px;height:18px" value="{{right.id}}" name="right_id">
                                    <span style="padding-top: 5px;width: 100%">{{right.name}}</span>
                                </label>
                           {% endif %}
                      {% endfor %}
                  </div>



            </div>



        </div>
        </form>
        <div  class="input-box" style="text-align: center;width: 100%" id="div-button">
             <button id="add_do" type="button" class="btn btn-danger">确认新增</button>
        </div>
        `

    $('.edit_show').click(function () {
        layer.open({
            type: 1, // page 层类型
            area: ['750px', '540px'],
            title: '添加后台管理用户',
            shade: 0.6, // 遮罩透明度
            shadeClose: true, // 点击遮罩区域，关闭弹层
            maxmin: true, // 允许全屏最小化
            anim: 0, // 0-6 的动画形式，-1 不开启
            content: html
        });
        $('#div-button').html('<button id="edit_do" type="button" class="btn btn-danger">确认修改</button>')

        $('#user_name').val($(this).attr('user_name'));
        $('#mobile').val($(this).attr('mobile'))
        $('#real_name').val($(this).attr('real_name'))
        $('#user_id').val($(this).attr('user_id'))
        var rights = $(this).attr('rights')
        var right_arr = rights.split(',');
        $('input[type="checkbox"][name="right_id"]').each(function () {
             if(right_arr.includes($(this).val())){
                 $(this).prop('checked', true);
             }
        })
        $('#edit_do').click(function () {
            var formData = {};
            $('#user_profile').serializeArray().forEach(function(item) {
                formData[item.name] = item.value;
            });
            var arr = []
            $('input[type="checkbox"][name="right_id"]').each(function () {
                  if(this.checked == true){
                      arr.push(this.value);
                  }
            })

            formData['right_ids'] = arr
            console.log(formData)
            $.ajax({
                type: "POST",
                url: "/admin/admin_user?act=edit",
                contentType: 'application/json',
                data: JSON.stringify(formData),
                async:false,
                success: function (data) {
                    if(data.code<0){
                        alert(data.msg)
                    }else{
                        location.reload()
                    }
                }
            })
        })
        $('#right_select_all').click(function () {
            console.log($('input[type="checkbox"][name="right_id"]')[0].checked)
            if(!$('input[type="checkbox"][name="right_id"]')[0].checked) {
                $('input[type="checkbox"][name="right_id"]').prop('checked', true);
            }else{
                $('input[type="checkbox"][name="right_id"]').prop('checked', false);
            }
        })
    })



    $('#add_show').click(function () {
        layer.open({
            type: 1, // page 层类型
            area: ['750px', '540px'],
            title: '添加后台管理用户',
            shade: 0.6, // 遮罩透明度
            shadeClose: true, // 点击遮罩区域，关闭弹层
            maxmin: true, // 允许全屏最小化
            anim: 0, // 0-6 的动画形式，-1 不开启
            content: html
        });
        $('#div-button').html('<button id="add_do" type="button" class="btn btn-danger">确认新增</button>')
        $('#add_do').click(function () {
            var formData = {};
            $('#user_profile').serializeArray().forEach(function(item) {
                formData[item.name] = item.value;
            });
            var arr = []
            $('input[type="checkbox"][name="right_id"]').each(function () {
                if(this.checked == true){
                    arr.push(this.value);
                }
            })

            formData['right_ids'] = arr
            console.log(formData)
            $.ajax({
                type: "POST",
                url: "/admin/admin_user?act=add",
                contentType: 'application/json',
                data: JSON.stringify(formData),
                async:false,
                success: function (data) {
                    if(data.code<0){
                        alert(data.msg)
                    }else{
                        location.reload()
                    }
                }
            })
        })
        $('#right_select_all').click(function () {
            console.log($('input[type="checkbox"][name="right_id"]')[0].checked)
            if(!$('input[type="checkbox"][name="right_id"]')[0].checked) {
                $('input[type="checkbox"][name="right_id"]').prop('checked', true);
            }else{
                $('input[type="checkbox"][name="right_id"]').prop('checked', false);
            }
        })
    })



</script>