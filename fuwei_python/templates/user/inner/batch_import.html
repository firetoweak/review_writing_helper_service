<style>
  .wrong-input{
    height: 20px;
    width: 100px;
    border-width:0px 0px 1px 0px; /* å»é™¤è¾¹æ¡† */
    background-color: #ffffff; /* è®¾ç½®èƒŒæ™¯é¢œè‰² */
  }
</style>

<!-- æ‰¹é‡å¯¼å…¥æˆå‘˜ -->
<div class="modal fade" id="batchImportModal" tabindex="-1" aria-hidden="true" >
  <div class="modal-dialog modal-dialog-centered" style="max-width:800px;">
    <div class="modal-content" style="border-radius:16px;height: 700px;">
      <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
        <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 114px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
          <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">ğŸš€æ‰¹é‡å¯¼å…¥æˆå‘˜</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
      </div>
      <div style="width: 100%;height:auto;display: grid;place-items: center;"><img src="/static/images/user-management/batch_state1.svg" style="width: 378px;height: 46px;"></div>
      <div style="font-size:14px;color:#9CA7BB;margin:16px 24px 10px 24px;">
        <div style="width: 50%;float: left;margin-top: 20px;"><img src="/static/images/user-management/batch_font1.svg" style="width: 100%;height: 100%;"></div>
        <div style="width: 30%;float: right; cursor: pointer" onclick="window.open('/static/download/æ‰¹é‡å¯¼å…¥ç”¨æˆ·.xlsx')"><img src="/static/images/user-management/batch_download_button.svg"></div>
      </div>
      <div class="d-flex align-items-center justify-content-between" style="background:#F6FAFF;border:1px dashed #D5E8FF;border-radius:8px;padding:5px 16px;margin:0px 24px">
        <div style="font-size:15px;color:#9CA7BB;">
          1.è¯·ä¸‹è½½"ç©ºçš„å¯¼å…¥æ¨¡æ¿"å¯¼å…¥<br>
          2.è¯·å‹¿ä¿®æ”¹å¯¼å…¥æ¨¡æ¿çš„çš„è¡¨å¤´ï¼Œå¦åˆ™å°†å¯¼è‡´å¯¼å…¥å¤±è´¥<br>
          3.å¦‚æœ‰ç©ºçš„æ•°æ®åˆ—ï¼Œåˆ™ç›¸åº”å­—æ®µä¿¡æ¯ä¼šè¢«æ¸…ç©ºï¼Œè¯·è°¨æ…å¡«å†™<br>
        </div>
      </div>
      <div style="font-size:14px;color:#9CA7BB;margin:16px 24px 10px 24px;" >
        <div style="width: 31%;float: left;margin-top: 10px;"><img src="/static/images/user-management/batch_font2.svg" style="width: 100%;height: 100%;"></div>
      </div>

      <div id="wait-upload-div">
          <img src="/static/images/user-management/batch_upload_pic.svg" style="width: 100%;height: 100%;">
      </div>

      <div class="uploading-box" style="display: none" >
        <div class="uploading-box-inner">
          <div class="circle-progress-box">
            <svg class="circle-progress" width="120" height="120">
              <defs>
                <linearGradient id="circle-gradient" x1="0%" y1="10%" x2="100%" y2="10%">
                  <stop offset="0%" stop-color="#2D8CFF"/>
                  <stop offset="100%" stop-color="#A259FF"/>
                </linearGradient>
              </defs>
              <circle class="circle-bg" cx="60" cy="60" r="54" stroke-width="12" fill="none"/>
              <circle class="circle-bar" cx="60" cy="60" r="54" stroke-width="12" fill="none"/>
            </svg>
            <img src="/static/images/user-management/batch_file.svg" class="circle-center-icon" />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- ç¡®è®¤æ•°æ®å¯¼å…¥ -->
<div class="modal fade" id="batchImportModal2" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false" >
  <div class="modal-dialog modal-dialog-centered" style="max-width:800px;">
    <div class="modal-content" style="border-radius:16px;height: 700px;">
      <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
        <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 114px;background-image:url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
          <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">ğŸš€æ‰¹é‡å¯¼å…¥æˆå‘˜</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
      </div>
      <div style="width: 100%;height:auto;display: grid;place-items: center;"><img src="/static/images/user-management/batch_state2.svg" style="width: 378px;height: 46px;"></div>
      <div style="height:60%;place-items: center;margin:16px 24px 10px 24px;  border-radius: 8px;overflow-y: auto;" >
        <table class="table">
          <thead>
          <tr class="table-header">

            <th width="80">ID</th>
            <th width="290">çœŸå®å§“å</th>
            <th width="200">ç”µå­é‚®ä»¶</th>
            <th width="200">éƒ¨é—¨</th>
            <th width="200">èŒä½</th>
          </tr>
          </thead>
          <tbody id="batchImportConfirmTable">

          </tbody>
        </table>
      </div>
      <div style="width: 100%;height: 100px;display: flex;justify-content: center;align-items: center;">
        <div class="drawer-buttons" style="width: 40%;height: 100px;display: flex;justify-content: center;align-items: center;">
          <button class="btn-batch mr-3">é‡æ–°ä¸Šä¼ </button>
          <button class="btn-submit-continue" id="submitAndImport">ç¡®è®¤æ— è¯¯,å¼€å§‹å¯¼å…¥</button>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- é”™è¯¯æ•°æ®ä¿®æ­£ -->
<div class="modal fade" id="WrongDataImportModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false" >
  <div class="modal-dialog modal-dialog-centered" style="max-width:950px;">
    <div class="modal-content" style="border-radius:16px;height: 700px;">
      <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
        <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 114px;background-image:url(/static/images/user-management/batch_header.png);background-size: 100% 120%;background-repeat: no-repeat;">
          <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">ğŸš€æ‰¹é‡å¯¼å…¥æˆå‘˜</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
      </div>
      <div style="width: 100%;height:auto;display: grid;place-items: center;"><img src="/static/images/user-management/batch_state2.svg" style="width: 378px;height: 46px;"></div>
      <div style="width: 100%;height:auto;display: grid;text-align: left;margin-left: 24px;color:red">ä»¥ä¸‹æ˜¯æ•°æ®ä¸Šä¼ åæ ¡éªŒå‡ºçš„é”™è¯¯æ•°æ®ï¼Œè¯·ä¿®æ­£</div>

      <div style="height:60%;place-items: center;margin:0px 24px 10px 24px;  border-radius: 8px;overflow-y: auto;" >
        <table class="table">
          <thead>
          <tr class="table-header">
            <th width="50">ID</th>
            <th width="200">çœŸå®å§“å</th>
            <th width="200">ç”µå­é‚®ä»¶</th>
            <th width="200">éƒ¨é—¨</th>
            <th width="200">èŒä½</th>
            <th width="350">é”™è¯¯åŸå› </th>
            <th width="100">æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="WrongDataConfirmTable">

          </tbody>
        </table>
      </div>
      <div style="width: 100%;height: 100px;display: flex;justify-content: center;align-items: center;">
        <div class="drawer-buttons" style="width: 40%;height: 100px;display: flex;justify-content: center;align-items: center;">
          <button class="btn-batch mr-3">é‡æ–°ä¸Šä¼ </button>
          <button class="btn-submit-continue" id="confirmUpdate">ç¡®è®¤ä¿®æ”¹</button>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- å¯¼å…¥è¿›åº¦æ¡ -->
<div class="modal fade" id="batchImportModal3" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width:800px;">
    <div class="modal-content" style="border-radius:16px;height: 700px;">
      <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
        <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 114px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
          <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">ğŸš€æ‰¹é‡å¯¼å…¥æˆå‘˜</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
      </div>
      <div style="width: 100%;height:auto;display: grid;place-items: center;"><img src="/static/images/user-management/batch_state3.svg" style="width: 378px;height: 46px;"></div>
      <div id="progressBarLine" style="height:60%;display: grid;place-items: center;margin:16px 24px 10px 24px;  border-radius: 8px;overflow-y: auto;">
        <div style="width: 90%; text-align: center;">
          <!-- ç™¾åˆ†æ¯”å’Œåˆ·æ–°å›¾æ ‡ -->
          <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
            <img src="/static/images/user-management/refresh-icon.gif" alt="åˆ·æ–°" style="width: 24px; height: 24px; margin-right: 8px;">
            <span style="font-size: 18px; font-weight: 500; color: #217EFD;" id="progress-percent">0%</span>
          </div>

          <!-- è¿›åº¦æ¡ -->
          <div style="width: 100%; height: 10px; background-color: #EAF2FF; border-radius: 5px; overflow: hidden; margin-bottom: 20px;">
            <div id="progressBar" style="width: 50%; height: 100%; background: linear-gradient(90deg, #2D8CFF 0%, #A259FF 100%); border-radius: 5px;"></div>
          </div>

          <!-- æç¤ºæ–‡å­— -->
          <div style="font-size: 14px; color: #9CA7BB;">
            <span id="progressText">æ•°æ®å¯¼å…¥ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- æ‰¹é‡å¯¼å…¥ç»“æœ-->
<div class="modal fade" id="batchImportModal4" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width:800px;">
    <div class="modal-content" style="border-radius:16px;height: 700px;">
      <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
        <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 114px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
          <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">ğŸš€æ‰¹é‡å¯¼å…¥æˆå‘˜</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
      </div>
      <div style="width: 100%;height:auto;display: grid;place-items: center;"><img src="/static/images/user-management/batch_state3.svg" style="width: 378px;height: 46px;"></div>
      <div style="height:60%;place-items: center;margin:16px 24px 10px 24px;  border-radius: 8px;overflow-y: auto;">
        <div style="width: 55px;height: 65px;display: grid;place-items: center;margin-top: 100px;">
          <!--
                              <img src="/static/images/user-management/batch_finish_icon.svg" style="width: 100%;height: 100%;">

          -->
          <img src="/static/images/user-management/batch_sucess_icon.svg" style="width: 100%;height: 100%;">

        </div>
        <div style="height: auto;display: grid;place-items: center;font-weight: 600;font-size: 20px;color: #222;margin-top: 20px;">
          å¯¼å…¥å®Œæˆ
        </div>
        <div style="height: auto;display: grid;place-items: center;font-size: 15px;color: #6b6868;margin-top: 20px;" id="result_num">

        </div>
      </div>
      <div style="width: 100%;height: 100px;display: flex;justify-content: center;align-items: center;">
        <div class="drawer-buttons" style="width: 40%;height: 100px;display: flex;justify-content: center;align-items: center;">
          <!--
          <button class="btn-batch mr-3"><img src="/static/images/user-management/down_icon.svg" alt="ä¸‹è½½" style="width: 15px; height: 15px;">ä¸‹è½½å¤±è´¥æ•°æ®</button>
          -->
          <button class="btn-batch mr-3" id="reflash"><img src="/static/images/user-management/refresh_icon.svg" alt="åˆ·æ–°" style="width: 15px; height: 15px;">åˆ·æ–°</button>

          <button class="btn-submit-continue" id="finish">å®Œæˆ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

  layui.use(['jquery', 'layer','upload'], function(){
    var $ = layui.$ //é‡ç‚¹å¤„
            ,layer = layui.layer;

      var upload = layui.upload;
      //$('#batchImportModal4').modal('show')
      //æ‰§è¡Œå®ä¾‹
      var wrongData = []
      var importRightData = []
      var canInviteNum = 0
      var uploadInst = upload.render({
        elem: '#wait-upload-div' //ç»‘å®šå…ƒç´ 
        ,url: '/user/inner/batchCheckExcel?type={{g.type}}' //ä¸Šä¼ æ¥å£
        ,accept: 'file'
        ,exts: 'xls|xlsx',
         progress: function(n, elem, res, index){
          if (parseInt(n)>20){
            setCircleProgress(50);
          }
        },
        choose: function(obj){
          console.log("choose")
          $('#wait-upload-div').hide()
          $('.uploading-box').show();
          setCircleProgress(10);
        },
        before: function(obj){ //objå‚æ•°åŒ…å«çš„ä¿¡æ¯ï¼Œè·Ÿ chooseå›è°ƒå®Œå…¨ä¸€è‡´ï¼Œå¯å‚è§ä¸Šæ–‡ã€‚
          console.log("before")
          setCircleProgress(20);
        },
        done: function(res){
          if(res.code==1) {
            var percent = 50
            setCircleProgress(percent)
            const interval = setInterval(function () {
              setCircleProgress(percent)
              percent = percent + 5
              if (percent >= 100) {
                clearInterval(interval);
              }
            }, 500)
            canInviteNum = res.rest_num
            setTimeout(function(){
              whichShow(res)
            },5000)
          }else{
            showToast("warning",res.msg)
          }
          // if(res.wrong_data.length>0){
          //   $('#batchImportModal').modal('hide')
          //   $('#WrongDataImportModal').modal('show')
          //   setTimeout(() => setTableWrongData(res.wrong_data), 1000)
          //   }else {
          //     $('#WrongDataImportModal').modal('hide')
          //     $('#batchImportModal').modal('hide')
          //     $('#batchImportModal2').modal('show')
          //     setTimeout(() =>  setTableData(res.data), 1000)
          //   }
        }
        ,error: function(){
          //è¯·æ±‚å¼‚å¸¸å›è°ƒ
        }
      });

    function whichShow(res){
      importRightData = res.data
      if(res.wrong_data.length>0){
        showToast("warning","æ•°æ®æ ¡éªŒåæœ‰é”™è¯¯")
        $('#batchImportModal').modal('hide')
        $('#WrongDataImportModal').modal('show')
        setTableWrongData(res.wrong_data)
      }else {
        $('#WrongDataImportModal').modal('hide')
        $('#batchImportModal').modal('hide')
        $('#batchImportModal2').modal('show')
         setTableData(res.data)
      }
    }

    function setTableData(data){
        if(data.length>0) {
          var html = ""
          for(var i=0;i<data.length;i++){
            html =html+ `
                          <tr>
                            <td>${(i+1)}</td>
                            <td>
                               ${data[i].real_name}
                            </td>
                            <td> ${data[i].email}</td>
                            <td> ${data[i].dept}</td>
                            <td> ${data[i].position}</td>
                          </tr>
                    `
          }
          $('#batchImportConfirmTable').html(html)
        }
    }
    $('#confirmUpdate').click(function(){
         let data = $('#WrongDataConfirmTable input')
         let l = data.length
         let arr = []
         for(var i=1;i<=l;i=i+4){
            var tag = i-1
            arr.push({"real_name":data[tag].value,"email":data[tag+1].value,"dept":data[tag+2].value,"position":data[tag+3].value})
         }
        console.log(arr)
        importRightData =importRightData.concat(arr)
        $.ajax({
          url: "/user/inner/batchCheckJson?type={{g.type}}",
          type: "POST",
          contentType: "application/json;charset=UTF-8",
          data: JSON.stringify({"users":importRightData}),
          async: false,
          success: function (data) {
            canInviteNum = data.rest_num
            whichShow(data)
          }
        })
    })

    function setTableWrongData(data){
        if(data.length>0) {
          var html = ""
          for(var i=0;i<data.length;i++){
            html =html+ `
                            <tr>
                              <td>${(i+1)}</td>
                            <td>
                                <input value="${data[i].real_name}" class="wrong-input" >
                            </td>
                            <td> <input value="${data[i].email}" class="wrong-input" ></td>
                            <td> <input value="${data[i].dept}" class="wrong-input"></td>
                            <td> <input value="${data[i].position}" class="wrong-input"></td>
                            <td>${data[i].wrongMess}</td>
                              <td><a style="cursor: pointer" class="wrong-input-del">åˆ é™¤</a></td>
                            </tr>
                      `
          }
          $('#WrongDataConfirmTable').html(html)
          $('.wrong-input-del').click(function(){
            $(this).parent().parent().remove();
          })
        }
    }


    $('.btn-batch:contains("é‡æ–°ä¸Šä¼ ")').click(function(){
        $('#batchImportModal2').modal('hide')
        $('#WrongDataImportModal').modal('hide')
        $('.btn-batch:contains("æ‰¹é‡å¯¼å…¥")').click()
    });
    // æ§åˆ¶è¿›åº¦æ¡å‡½æ•°
    function updateProgress(percent, text) {
      // æ›´æ–°è¿›åº¦æ¡å®½åº¦
      $('#progressBar').css('width', percent + '%');

      // æ›´æ–°ç™¾åˆ†æ¯”æ–‡å­—
      $('#progress-percent').text(percent + '%');

      // æ›´æ–°æç¤ºæ–‡å­—ï¼ˆå¦‚æœæä¾›ï¼‰
      if (text) {
        $('#progressText').text(text);
      }
    }


    // æ¨¡æ‹Ÿè¿›åº¦å¢é•¿
    function simulateProgressImport() {
      let progress = 0;
      const interval = setInterval(function() {
        progress += 5;
        updateProgress(progress);

        // ä¿®æ”¹æç¤ºæ–‡å­—
        if (progress < 30) {
          $('#progressText').text('æ­£åœ¨è§£æExcelæ–‡ä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…...');
        } else if (progress < 60) {
          $('#progressText').text('æ­£åœ¨éªŒè¯æ•°æ®æ ¼å¼ï¼Œè¯·è€å¿ƒç­‰å¾…...');
        } else if (progress < 90) {
          $('#progressText').text('æ­£åœ¨å¯¼å…¥æ•°æ®ï¼Œè¯·è€å¿ƒç­‰å¾…...');
        } else {
          $('#progressText').text('å¯¼å…¥å³å°†å®Œæˆï¼Œè¯·è€å¿ƒç­‰å¾…...');
        }

        // å®Œæˆæ—¶
        if (progress >= 100) {
          clearInterval(interval);
          $('#progressText').text('æ•°æ®å¯¼å…¥å®Œæˆï¼');
          setTimeout(function() {
            $('#batchImportModal3').modal('hide');
            showToast('success', 'æ‰¹é‡å¯¼å…¥æˆåŠŸ');
          }, 1000);
        }
      }, 500); // æ¯500æ¯«ç§’å¢åŠ 5%
    }

    // ç¬¬äºŒä¸ªç¡®è®¤å¯¼å…¥æŒ‰é’®äº‹ä»¶
    $('#confirmImport2Btn').click(function(){
      $('#batchImport2Modal').modal('hide');
      showToast('success', 'æ‰¹é‡å¯¼å…¥æˆåŠŸ');
    });

    // ç¡®è®¤å¯¼å…¥æŒ‰é’®äº‹ä»¶
    $('#submitAndImport').click(function() {
      // é‡ç½®è¿›åº¦ä¸º0å¹¶å¯åŠ¨æ¨¡æ‹Ÿ
      if (parseInt(canInviteNum) < importRightData.length) {
          $('#NoInvite').modal('show')
          return ""
      }
      $('#batchImportModal2').modal('hide');
      $('#batchImportModal3').modal('show');

      updateProgress(0, 'å¼€å§‹å¯¼å…¥æ•°æ®ï¼Œè¯·è€å¿ƒç­‰å¾…...');
      var i = 0
      const interval = setInterval(function() {
            $.ajax({
              url: "/user/inner/add?type={{g.type}}&is_batch=1",
              type: "POST",
              contentType: "application/json;charset=UTF-8",
              data: JSON.stringify(importRightData[i]),
              async: false,
              success: function (data) {
                var percent = (i+1)/importRightData.length
                percent =percent.toFixed(2) *100
                updateProgress(percent, 'å¼€å§‹å¯¼å…¥æ•°æ®ï¼Œè¯·è€å¿ƒç­‰å¾…...');
                if(percent >=100){
                  clearInterval(interval);
                  $('#progressText').text('æ•°æ®å¯¼å…¥å®Œæˆï¼');
                  setTimeout(function() {
                    $('#batchImportModal3').modal('hide');
                    $('#batchImportModal4').modal('show');
                    $('#result_num').html(' å¯¼å…¥æ•°æ®ï¼š'+importRightData.length +'  å¯¼å…¥æˆåŠŸï¼š'+importRightData.length +'  å¯¼å…¥å¤±è´¥ï¼š0')
                  }, 1000);
                }
              }
            })
            i = i +1
      }, 1000);

    });

    $('#reflash,#finish').click(function(){
        location.reload();
    })
  })
</script>