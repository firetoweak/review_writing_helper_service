    <style>
        .responsible-person-container {
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        .responsible-person-container:hover {
            background-color: #f8f9fa;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .edit-icon {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .edit-icon:hover {
            color: #0d6efd;
            transform: scale(1.1);
        }
        .responsible-person {
            padding: 10px 15px;
            border-radius: 6px;
            background-color: #f8f9fa;
        }

        .floating-buttons {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .floating-btn {
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            color: white;
            font-weight: 500;
        }
    </style>

     <!-- 1、缺陷信息 -->
    {% include "components/create_simplified2.html" %}

    <!--设置编辑或只读-->
    {% set is_description_editor = description_user and description_user.user_id == current_user.user_id %}
    {% set is_analysis_editor = cause_analysis_user and cause_analysis_user.user_id == current_user.user_id %}
    {% set is_solution_editor = developer_solution_user and developer_solution_user.user_id == current_user.user_id %}
    {% set is_regression_editor = tester_regression_user and tester_regression_user.user_id == current_user.user_id %}

    <!-- 方式1：data属性 - 包含所有编辑权限 -->
    <div id="app-data"
         data-is-description-editor="{{ 'true' if is_description_editor else 'false' }}"
         data-is-analysis-editor="{{ 'true' if is_analysis_editor else 'false' }}"
         data-is-solution-editor="{{ 'true' if is_solution_editor else 'false' }}"
         data-is-regression-editor="{{ 'true' if is_regression_editor else 'false' }}"
         data-current-user-id="{{ current_user.user_id }}">
    </div>

    <!-- 缺陷评估与操作 -->
    <div class="container-main defect-evaluation-section">
        <div class="section-header">
            <div class="section-title">
                <img src="/static/images/fengchi_tag.svg" alt="">
                缺陷操作与评估
            </div>
        </div>

        <div class="evaluation-table-container">
            <table class="ai-val-detail-tb-content">
            <thead>
            <tr>
                <th style="width: 10%;">流程阶段</th>
                <th style="width: 40%;">
                    <div class="flex justify-content-between">
                        <span>内容</span>
                    </div>
                </th>
                <th style="width: 40%;">AI 建议 <img src="/static/images/aival/start.svg" alt="AI" class="ai-icon" style="width: 14px; height: 14px; margin-left: 4px;"></th>
                <th style="width: 10%;">评分 (满分10分)</th>
            </tr>
            </thead>
            <tbody class="ai-val-tr">
            <tr>
                <td id="content_type1">缺陷描述</td>

                <td id="defect_description">
                    <div class="responsible-person-container d-flex justify-content-between align-items-center p-1 mb-2">
                        <span>责任人：</span>
                        <div class="responsible-person flex-grow-1 me-1">
                            {{ description_user.real_name if description_user else '未分配' }} /
                            {{ description_user.email if description_user.email else '无Email' }}
                        </div>
                        {% if (is_project_manager or is_description_editor) and (defect and defect.status=='DefectStatus.OPEN')%}
                        <i id="inviteDescriptionUserButton" class="bi config-button" title="配置责任人，包括缺陷基本信息、缺陷描述和提出人确认" data-bs-toggle="modal" data-bs-target="#assignDescriptionUserModal"></i>
                        {% endif %}
                    </div>

                    <div class="title-description">
                        <!-- 单一编辑器容器 -->
                        <div class="editor-container" id="single-editor-container-description">
                            {% if not is_description_editor or (defect and defect.status=='DefectStatus.CLOSED')%}
                                <!-- 只读模式下显示只读内容 -->
                                <div class="view-mode-content img-width" id="view-mode-content-description">
                                    {% if description_data and description_data[0].content and description_data[0].content.description %}
                                        {% set description_items = description_data[0].content.description %}
                                        {% if description_items is string %}
                                            {{ description_items | safe }}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">无描述内容</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <!-- 编辑模式下显示编辑器 -->
                                <div class="editor-toolbar" id="toolbar-container-description"></div>
                                <div class="editor-content" id="editor-content-description"></div>
                                <textarea class="d-none table-description-text"
                                          name="description"
                                          placeholder="请输入缺陷描述">
                                    {% if description_data and description_data[0].content and description_data[0].content.description %}
                                        {% set description_items = description_data[0].content.description %}
                                        {% if description_items is string %}
                                            {{ description_items | safe }}
                                        {% endif %}
                                    {% endif %}
                                </textarea>
                            {% endif %}
                        </div>
                    </div>
                </td>

                <td id="AI_advice_for_description">
                    {% if description_data|length > 0 %}
                        {{ description_data[0].ai_suggestion|default('未评估', true)|safe }}
                    {% endif %}
                </td>

                <td id="description_score" class="score {% if description_data and description_data[0] and description_data[0].ai_score is not none %}{% if description_data[0].ai_score >= 8 %}score-green{% elif description_data[0].ai_score >= 6 %}score-blue{% else %}score-red{% endif %}{% else %}score-red{% endif %}">
                    {% if description_data and description_data[0] and description_data[0].ai_score is not none %}
                    {{ description_data[0].ai_score}}
                    {% endif %}
                </td>
            </tr>

            <!-- 原因分析行 -->
            <tr>
                <td id="content_type2">原因分析</td>
                <td id="cause_analysis">
                    <div class="responsible-person-container d-flex justify-content-between align-items-center p-1 mb-2">
                        <span>责任人：</span>
                        <div class="responsible-person flex-grow-1 me-1">
                            {{cause_analysis_user.real_name if cause_analysis_user else '未分配' }} /
                            {{ cause_analysis_user.email if cause_analysis_user.email else '无Email' }}
                        </div>
                        {% if (is_project_manager or is_analysis_editor) and (defect and defect.status=='DefectStatus.OPEN')%}
                        <i id="inviteAnalysisUserButton" class="bi config-button" title="配置责任人"></i>
                        {% endif %}
                    </div>
                    {% if is_regression_editor and (defect and defect.status=='DefectStatus.OPEN')%}
                    <button type="button" class="btn-batch m-2 p-2" id="loadAnalysisTemplate">加载原因分析模板</button>
                    {% endif %}
                    <div class="title-description">
                        <!-- 单一编辑器容器 -->
                        <div class="editor-container" id="single-editor-container-analysis">
                            {% if not is_analysis_editor or (defect and defect.status!='DefectStatus.OPEN')%}
                                <!-- 只读模式下显示只读内容 -->
                                <div class="view-mode-content img-width" id="view-mode-content-analysis">
                                    {% if cause_analysis_data|length > 0 and cause_analysis_data[0].content and cause_analysis_data[0].content.analyses %}
                                        {% for analysis in cause_analysis_data[0].content.analyses %}
                                            {% if analysis and not analysis.strip() == '<p>&nbsp;</p>' and not analysis.strip() == '<p><br></p>' %}
                                                {{ analysis | safe }}
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">暂无内容</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <!-- 编辑模式下显示编辑器 -->
                                <div class="editor-toolbar" id="toolbar-container-analysis"></div>
                                <div class="editor-content" id="editor-content-analysis"></div>
                                <textarea class="d-none table-analysis-text"
                                              name="analysis-invitation-id }}"
                                              placeholder="请输入原因分析">
                                    {% if cause_analysis_data|length > 0 and cause_analysis_data[0].content and cause_analysis_data[0].content.analyses %}
                                        {% for analysis in cause_analysis_data[0].content.analyses %}
                                            {% if analysis and not analysis.strip() == '<p>&nbsp;</p>' and not analysis.strip() == '<p><br></p>' %}
                                                {{ analysis | safe }}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}

                                </textarea>
                            {% endif %}
                        </div>
                    </div>
                </td>
                <td id="AI_advice_for_analysis" >
                {% if cause_analysis_data|length > 0 %}
                   {% if cause_analysis_data[0].ai_suggestion != None %}
                        {{ cause_analysis_data[0].ai_suggestion|safe }}
                   {% endif %}
                {% endif %}
                </td>
                <td id="analysis_score" class="score {% if  cause_analysis_data|length > 0 and cause_analysis_data[0].ai_score is not none %}{% if cause_analysis_data[0].ai_score >= 8 %}score-green{% elif cause_analysis_data[0].ai_score >= 6 %}score-blue{% else %}score-red{% endif %}{% else %}score-red{% endif %}">
                   {% if  cause_analysis_data|length > 0 and cause_analysis_data[0].ai_score is not none  %}
                        {{ cause_analysis_data[0].ai_score  }}
                   {% endif %}
                </td>
            </tr>

            <!-- 解决措施行 -->
            <tr>
                <td id="content_type3">解决措施</td>

                <td id="solution_content">
                    <div class="responsible-person-container d-flex justify-content-between align-items-center p-1 mb-2">
                        <span>责任人：</span>
                        <div class="responsible-person flex-grow-1 me-1">
                            {{ developer_solution_user.real_name if developer_solution_user else '未分配' }} /
                            {{ developer_solution_user.email if developer_solution_user.email else '无Email' }}
                        </div>
                        {% if (is_project_manager or is_solution_editor) and (defect and defect.status=='DefectStatus.OPEN')%}
                        <i id="inviteDevelopersButton" class="bi config-button" title="配置责任人"></i>
                        {% endif %}
                    </div>
                    {% if is_solution_editor and (defect and defect.status=='DefectStatus.OPEN')%}
                    <button type="button" class="btn-batch m-2 p-2" id="loadSolutionTemplate">加载解决措施模板</button>
                    {% endif %}
                    <div class="title-description">
                        <!-- 单一编辑器容器 -->
                        <div class="editor-container" id="single-editor-container-solution">
                            {% if not is_solution_editor or (defect and defect.status!='DefectStatus.OPEN')%}
                                <!-- 只读模式下显示只读内容 -->
                                <div class="view-mode-content img-width" id="view-mode-content-solution">
                                    {% if solution_data|length > 0 %}
                                        {% for item in solution_data %}
                                            {% if item['content']['solutions']|length > 0 %}
                                                <div class="solution-item">
                                                    {% for su in item['content']['solutions'] %}
                                                        {% if su and not su.strip() == '<p>&nbsp;</p>' and not su.strip() == '<p><br></p>' %}
                                                            {{ su | safe }}<br>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <br>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">暂无内容</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <!-- 编辑模式下显示编辑器 -->
                                <div class="editor-toolbar" id="toolbar-container-solution"></div>
                                <div class="editor-content" id="editor-content-solution"></div>
                                <textarea class="d-none table-solution-text"
                                          name="solution"
                                          placeholder="请输入解决方案">
                                    {% if solution_data|length > 0 %}
                                        {% for item in solution_data %}
                                            {% for su in item['content']['solutions'] %}
                                                {% if su and not su.strip() == '<p>&nbsp;</p>' and not su.strip() == '<p><br></p>' %}
                                                    {{ su | safe }}
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    {% endif %}
                                </textarea>
                            {% endif %}
                        </div>
                    </div>
                </td>

                <td id="AI_advice_for_solution">
                            {% if solution_data|length > 0 %}
                                    {% for item in solution_data %}
                                        {% if item['ai_suggestion']!=None %}
                                            {{ item['ai_suggestion'] | safe }}
                                        {% endif %}
                                    {% endfor %}
                            {% endif %}
                </td>
                <td id="solution_score" class="score {% if solution_data|length > 0 and solution_data[0]['ai_score']!=None  %}{% if solution_data[0]['ai_score']>=8 %}score-green{% elif solution_data[0]['ai_score'] >= 6 %}score-blue{% else %}score-red{% endif %}{% endif %}">
                        {% if solution_data|length > 0 %}
                            {% for item in solution_data %}
                               {% if item['ai_score']!=None %}
                                    {{ item['ai_score'] }}
                                {% endif  %}
                            {% endfor %}
                        {% endif %}
                </td>
            </tr>

            <!-- 回归测试行 -->
            <tr>
                <td id="content_type4">回归测试</td>
                <td id="result_content">
                    <div class="responsible-person-container d-flex justify-content-between align-items-center p-1 mb-2">
                        <span>责任人：</span>
                        <div class="responsible-person flex-grow-1 me-1">
                            {{ tester_regression_user.real_name if tester_regression_user else '未分配' }} /
                            {{ tester_regression_user.email if tester_regression_user.email else '无Email' }}
                        </div>
                        {% if (is_project_manager or is_regression_editor) and (defect and defect.status=='DefectStatus.OPEN')%}
                        <i id="configRegressionUser" class="bi config-button" title="配置责任人" data-bs-toggle="modal" data-bs-target="#assignRegressionTesterModal"></i>
                        {% endif %}
                    </div>
                    {% if is_regression_editor and (defect and defect.status=='DefectStatus.OPEN')%}
                    <button type="button" class="btn-batch m-2 p-2" id="loadRegressionTemplate">加载回归测试模板</button>
                    {% endif %}
                    <div class="title-description">
                        <!-- 单一编辑器容器 -->
                        <div class="editor-container" id="single-editor-container-regression">
                            {% if not is_regression_editor or (defect and defect.status!='DefectStatus.OPEN')%}
                                <!-- 只读模式下显示只读内容 -->
                                <div class="view-mode-content img-width" id="view-mode-content-regression">
                                    {% if test_result_data and test_result_data[0].content and test_result_data[0].content.description %}
                                        {% set result_items = test_result_data[0].content.description %}
                                        {% if result_items is string %}
                                            <div class="result-item">
                                                {{ result_items | safe }}
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">暂无内容</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <!-- 编辑模式下显示编辑器 -->
                                <div class="editor-toolbar" id="toolbar-container-regression"></div>
                                <div class="editor-content" id="editor-content-regression"></div>
                                <textarea class="d-none table-result-text"
                                          name="result_content"
                                          placeholder="请输入测试结果">
                                    {% if test_result_data and test_result_data[0].content and test_result_data[0].content.description %}
                                        {% set result_items = test_result_data[0].content.description %}
                                        {% if result_items is string %}
                                            {{ result_items | safe }}
                                        {% endif %}
                                    {% endif %}
                                </textarea>
                            {% endif %}
                        </div>
                    </div>
                </td>
                <td id="AI_advice_for_test_result">
                        {% if test_result_data|length > 0 and test_result_data[0] and test_result_data[0].ai_suggestion!=None%}
                                {{ test_result_data[0].ai_suggestion|safe }}
                        {% endif %}
                </td>
                <td id="test_result_score" class="score {% if test_result_data and test_result_data[0] and test_result_data[0].ai_score is not none %}{% if test_result_data[0].ai_score >= 8 %}score-green{% elif test_result_data[0].ai_score >= 6 %}score-blue{% else %}score-red{% endif %}{% else %}score-red{% endif %}">
                   {% if test_result_data and test_result_data[0] and test_result_data[0].ai_score is not none %}
                   {{ test_result_data[0].ai_score }}
                   {% endif %}
                </td>
            </tr>

            <tr>
                <td id="confirmClose">提出人确认</td>

                <td id="confirmOperation" colspan="3">
                    <div class="responsible-person-container d-flex justify-content-between align-items-center p-1 mb-2">
                        <span>责任人：</span>
                        <div class="responsible-person flex-grow-1 me-1">
                            {{ description_user.real_name if description_user else '未分配' }} /
                            {{ description_user.email if description_user.email else '无Email' }}
                        </div>

                    </div>
                    <span class="p-2">请单击“关闭缺陷”按钮进行缺陷单的确认</span>
                </td>
            </tr>



            </tbody>
        </table>
        </div>
    </div>

    <!-- 悬浮按钮 -->
{% if is_description_editor or is_analysis_editor or is_solution_editor or is_regression_editor%}
    {% if defect and defect.status=='DefectStatus.OPEN' or defect.status=='DefectStatus.SUSPEND_TRACKING'%}
    <div class="floating-buttons">
        {% if is_description_editor and defect.status=='DefectStatus.SUSPEND_TRACKING'%}
        <button type="button" class="btn-batch mr-3" style="width: 120px;" id="reOpenDefectBtn" data-bs-toggle="modal" data-bs-target="#reopenModal">重新开启</button>
        {% endif %}
        {% if is_description_editor and (defect and defect.status=='DefectStatus.OPEN')%}
        <button type="button" class="btn-batch mr-3" style="width: 120px;" id="closeDefectBtn" data-bs-toggle="modal" data-bs-target="#terminateModal">关闭缺陷</button>
        {% endif %}
        {% if defect and defect.status=='DefectStatus.OPEN'%}
        <button type="button" class="btn-batch mr-3" style="display:none; width: 120px;"  id="saveDraftBtn">暂存</button>
        <div class="floating-btn" style="">
            <button type="button" class="ok-btn btn-outline-dark me-2 ai-review-multi" style="width: 120px;" >AI自评 <img src="/static/images/start-pic.svg" alt="刷新"> </button>
        </div>
        <div class="floating-btn" style="">
            <button id="submitAll" type="button" class="ok-btn" style="width: 120px;">提交</button>
        </div>
        {% endif %}
        <div class="button-group">
            <a href="/defect/?defect_type=simplified2" class="ok-btn" style="width: 120px;" >返回列表</a>
        </div>
    </div>
    {% endif %}
{% endif %}
    <!--5、右侧导航 -->
    <div class="right-menu" style="position: fixed; top: 50px;">
        <div class="right-menu-active"></div>
        <div data-target="content_type1">
            <img class="right-menu-active-img" src="/static/images/aival/left-tag.svg" alt="">
            缺陷描述
        </div>
        <div data-target="content_type2">
            原因分析
        </div>
        <div data-target="content_type3">
            解决措施
        </div>
        <div data-target="content_type4">
            回归测试
        </div>
        <div data-target="confirmClose">
            提出人确认
        </div>
    </div>

<!-- 指定缺陷描述人员 -->
<div class="modal fade" id="assignDescriptionUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:16px;">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                    <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                        <div class="flex items-center justify-center">
                            <img src="/static/images/defect/p2_03.png" alt="测试图标" class="test-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;">
                            <span style="margin-top: 2px;">指定缺陷描述人员</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>

            <form id="assignDescriptionUserForm">
                <div class="modal-body" style="padding: 0 40px;margin-top: 24px;">
                    <!-- 人员搜索区域和姓名显示区域（同一行） -->
                    <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1; margin-right: 20px;">
                            <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">
                                <span style="color: red;">*</span> 请选择处理人的 Email 账号，平台将会通知他
                            </label>
                            <div style="position: relative;">
                                <input type="text" class="form-control assignee-search" placeholder="搜索成员" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                                <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                                <!-- 下拉框 -->
                                <div class="assignee-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;">
                                    <!-- 动态生成搜索结果 -->
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="width: 50%;">
                            <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">姓名</label>
                            <div class="selected-assignee-name" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;color: #999;display: flex;align-items: center;">
                                通过Email账号搜索成员，此处将会自动填充姓名
                            </div>
                        </div>
                    </div>

                    <!-- 原因输入区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label-style"><span style="color: red;">*</span> 审核意见</label>
                        <textarea class="invitee-reason text-area-border" name="review_notes" placeholder="请输入审核意见..." style="display:block" required></textarea>
                    </div>
                    <input type="hidden" class="assignee-id" name="tester_id" required>
                    <input type="hidden" class="assignee-email">
                    <input type="hidden" class="assignee-name">
                    <input type="hidden" name="approved" value="false">
                </div>

                <div class="modal-footer" style="width: 100%;height: 100px;display: flex;justify-content: center;align-items: center;">
                    <div class="drawer-buttons" style="width: 60%;height: 40px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="button" class="ok-btn" id="submitAssignDescriptionUser" style="width: 140px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">提交</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 指定缺陷分析人员 -->
<div class="modal fade" id="inviteDevelopersLocateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:16px;">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                    <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                        <div class="flex items-center justify-center">
                            <img src="/static/images/defect/p2_03.png" alt="邀请图标" class="invite-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;">
                            <span style="margin-top: 2px;">指定分析人员</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>

            <form id="inviteDevelopersForm">
                <input type="hidden" name="invitees_data" id="inviteesData">

                <div class="modal-body" style="padding: 0 40px;margin-top: 24px;">
                    <!-- 邀请人员列表容器 -->
                    <div id="inviteeMembersContainer">
                        <div class="invitee-item" data-item-index="1">
                            <!-- 人员搜索区域和姓名显示区域（同一行） -->
                            <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                                <div class="form-group" style="flex: 1; margin-right: 20px;">
                                    <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">
                                        <span style="color: red;">*</span> 请选择处理人的 Email 账号，平台将会通知他
                                        <button type="button" class="remove-invitee-btn" style="float: right;color: #FE6380;border: 1px solid #FE6380;background: #fff;border-radius: 4px;padding: 2px 8px;font-size: 12px;cursor: pointer;display: none;">移除</button>
                                    </label>
                                    <div style="position: relative;">
                                        <input type="text" class="form-control assignee-search" placeholder="搜索成员" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                                        <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                                        <!-- 下拉框 -->
                                        <div class="assignee-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;">
                                            <!-- 动态生成搜索结果 -->
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group" style="width: 50%;">
                                    <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">姓名</label>
                                    <div class="selected-assignee-name" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;color: #999;display: flex;align-items: center;">
                                        通过Email账号搜索成员，此处将会自动填充姓名
                                    </div>
                                </div>
                            </div>

                            <!-- 原因输入区域 -->
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label class="label-style"><span style="color: red;">*</span> 原因</label>
                                <textarea class="invitee-reason text-area-border" placeholder="请输入"></textarea>
                            </div>
                            <input type="hidden" class="assignee-id">
                            <input type="hidden" class="assignee-email">
                            <input type="hidden" class="assignee-name">
                        </div>
                    </div>

                    <!-- 添加被邀请人按钮 -->
                    <div id="addInvitee" class="add-invitee-section flex items-center justify-center" style="display:none; border: 1px dashed #217efd;border-radius: 8px;padding:6px 15px;text-align: center;margin: 20px 0;cursor: pointer;transition: all 0.3s;">
                        <div class="addicon">
                            <img src="/static/images/defect/news_add.png">
                        </div>
                        <div class="add-text">添加被邀请人</div>
                </div>
                </div>
                <div class="modal-footer" style="width: 100%;height: 100px;display: flex;justify-content: center;align-items: center;">
                    <div class="drawer-buttons" style="width: 60%;height: 40px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="button" class="ok-btn" id="sendInviteDevelopersLocateBtn" style="width: 140px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">提交</button> <span id="inviteeCount" style="display:none; ">1</span>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 指定解决人员 -->
<div class="modal fade" id="inviteDevelopersSolutionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:16px;">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                    <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                        <div class="flex items-center justify-center">
                            <img src="/static/images/defect/p2_03.png" alt="邀请图标" class="invite-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;">
                            <span style="margin-top: 2px;">指定解决人员</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>

            <form id="inviteDevelopersSolutionForm">
                <div class="modal-body" style="padding: 0 40px;margin-top: 24px;">
                    <!-- 分工列表容器 -->
                    <div id="divisionSolutionContainer">
                        <div class="division-item" data-item-index="1">
                            <!-- 分工基本信息区域 -->
                            <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                                <div class="form-group" style="display:none; flex: 1; margin-right: 20px;">
                                    <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">
                                        <span style="color: red;">*</span> 修改模块
                                    </label>
                                    <input type="text" class="form-control division-module" placeholder="请输入修改模块" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;">
                                </div>

                                <div class="form-group" style="display:none; flex: 1; margin-right: 20px;">
                                    <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">
                                        <span style="color: red;">*</span> 完成时间
                                    </label>
                                    <input type="date" class="form-control division-due-date" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;">
                                </div>

                                <div class="form-group" style="flex: 1;">
                                    <button type="button" class="remove-division-btn" style="float: right;color: #FE6380;border: 1px solid #FE6380;background: #fff;border-radius: 4px;padding: 2px 8px;font-size: 12px;cursor: pointer;margin-top: 24px;display: none;">移除</button>
                                </div>
                            </div>

                            <!-- 人员选择区域 -->
                            <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                                <div class="form-group" style="flex: 1; margin-right: 20px;">
                                    <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">
                                        <span style="color: red;">*</span> 请选择处理人的 Email 账号，平台将会通知他
                                    </label>
                                    <div style="position: relative;">
                                        <input type="text" class="form-control assignee-search" placeholder="搜索成员" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                                        <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                                        <!-- 下拉框 -->
                                        <div class="assignee-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;">
                                            <!-- 动态生成搜索结果 -->
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group" style="width: 50%;">
                                    <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">姓名</label>
                                    <div class="selected-assignee-name" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;color: #999;display: flex;align-items: center;">
                                        通过Email账号搜索成员，此处将会自动填充姓名
                                    </div>
                                </div>
                            </div>

                            <!-- 解决措施输入区域 -->
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label class="label-style"><span style="color: red;">*</span>审核意见</label>
                                <textarea class="division-action-plan text-area-border" placeholder="请输入审核意见..." rows="3"></textarea>
                            </div>
                            <input type="hidden" class="assignee-id">
                            <input type="hidden" class="assignee-email">
                            <input type="hidden" class="assignee-name">
                        </div>
                    </div>

                    <!-- 添加分工按钮 -->
                    <div id="addDivisionSolution" class="add-division-section flex items-center justify-center" style="display:none; border: 1px dashed #217efd;border-radius: 8px;padding:6px 15px;text-align: center;margin: 20px 0;cursor: pointer;transition: all 0.3s;">
                        <div class="addicon">
                            <img src="/static/images/defect/news_add.png">
                        </div>
                        <div class="add-text">添加分工</div>
                    </div>
                </div>
                <div class="modal-footer" style="width: 100%;height: 100px;display: flex;justify-content: center;align-items: center;">
                    <div class="drawer-buttons" style="width: 60%;height: 40px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="button" class="ok-btn" id="sendInviteSolutionBtn" style="width: 140px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">提交</button> <span style="display:none" id="divisionSolutionCount">1</span>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 指定回归测试人员 -->
<div class="modal fade" id="assignRegressionTesterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:16px;">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                    <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                        <div class="flex items-center justify-center">
                            <img src="/static/images/defect/p2_03.png" alt="测试图标" class="test-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;">
                            <span style="margin-top: 2px;">指定回归测试人员</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>

            <form id="reviewSolutionForm" method="POST" action="{{ url_for('defect.dev_lead_review_solution', defect_id=defect.id) }}">
                <div class="modal-body" style="padding: 0 40px;margin-top: 24px;">
                    <!-- 人员搜索区域和姓名显示区域（同一行） -->
                    <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1; margin-right: 20px;">
                            <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">
                                <span style="color: red;">*</span> 请选择处理人的 Email 账号，平台将会通知他
                            </label>
                            <div style="position: relative;">
                                <input type="text" id="regressionMemberSearch" class="form-control assignee-search" placeholder="搜索成员" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                                <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                                <!-- 下拉框 -->
                                <div id="regressionMemberDropdown" class="assignee-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;">
                                    <!-- 动态生成搜索结果 -->
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="width: 50%;">
                            <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">姓名</label>
                            <div id="selectedRegressionMemberName" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;color: #999;display: flex;align-items: center;">
                                通过Email账号搜索成员，此处将会自动填充姓名
                            </div>
                        </div>
                    </div>

                    <!-- 隐藏字段 -->
                    <input type="hidden" id="regressionMember_id" class="assignee-id" name="tester_id" required>
                    <input type="hidden" id="approved_in_review_solution_dialog" name="approved" value="false">

                    <!-- 审核意见区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label-style"><span style="color: red;">*</span> 审核意见</label>
                        <textarea class="invitee-reason text-area-border" id="review_notes_in_review_solution_dialog" name="review_notes" rows="4" placeholder="请输入审核意见..." style="display:block" required></textarea>
                    </div>
                </div>

                <div class="modal-footer" style="width: 100%;height: 100px;display: flex;justify-content: center;align-items: center;">
                    <div class="drawer-buttons" style="width: 60%;height: 40px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="button" class="ok-btn" style="width: 140px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;" onclick="submitSolutionReview(true)">提交</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 终止/关闭缺陷模态框 -->
<div class="modal fade" id="terminateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                    <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                        <img src="/static/images/defect/p2_02.png" alt="关闭图标" class="reject-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;"> 关闭缺陷
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>
            <form id="closeDefectForm">
                <div style="padding: 0 40px;margin-top: 24px;">
                    <!-- 关闭状态选择部分 -->
                    <div class="ms-2 mt-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="verificationStatus" class="form-label mb-0">关闭状态选择（选择后将根据选项限制流程阶段的编辑权限）</label>
                        </div>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="verificationStatus" id="verification-resolved" value="resolved"
                                    {% if current_stage and current_stage.stage_type == 'requester_confirm' %}checked{% else %}disabled{% endif %}>
                                <label class="form-check-label {% if not (current_stage and current_stage.stage_type == 'requester_confirm') %}text-muted{% endif %}" for="verification-resolved">
                                    问题已解决，正常关闭（不可再次开启）
                                    {% if not (current_stage and current_stage.stage_type == 'requester_confirm') %}
                                    <span class="text-muted small">（仅当缺陷处于"提出人确认"阶段可用）</span>
                                    {% endif %}
                                </label>
                            </div>

                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="verificationStatus" id="verification-suspended" value="suspended"
                                    {% if not (current_stage and current_stage.stage_type == 'requester_confirm') %}checked{% endif %}>
                                <label class="form-check-label" for="verification-suspended">暂时不解决，挂起（可再次开启）</label>
                            </div>

                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="verificationStatus" id="verification-terminated" value="terminated">
                                <label class="form-check-label" for="verification-terminated">终止跟踪（不可再次开启）</label>
                            </div>
                        </div>
                        <div id="status_error" class="error-message" style="color: red; margin-top: 5px; display: none;"></div>
                    </div>

                    <!-- 关闭原因部分 -->
                    <div class="form-group">
                        <label class="label-style">
                            <span style="color: red;">*</span>关闭原因
                        </label>
                        <textarea class="text-area-border" id="close_reason" name="reason" placeholder="请输入关闭原因" required></textarea>
                        <div id="reason_error" class="error-message" style="color: red; margin-top: 5px; display: none;"></div>
                    </div>
                </div>
                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line-dialog">
                        <button type="button" class="cance-button btn-batch mr-3" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="confirm-button ok-btn" id="confirmCloseBtn">确定</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 重新开启对话框 -->
<div class="modal fade" id="reopenModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                    <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                        重新开启
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>
            <form method="post">
                <div style="padding: 0 40px;margin-top: 24px;">
                    <div class="form-group">
                        <label class="label-style">
                            <span style="color: red;">*</span>重新开启原因
                        </label>
                        <textarea class="text-area-border" id="reopen_reason" name="reason" placeholder="请输入重新开启原因" required></textarea>
                    </div>
                </div>
                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line-dialog">
                        <button type="button" class="cance-button btn-batch mr-3 " data-bs-dismiss="modal">取消</button>
                        <button id="confirmReopenBtn" type="submit" class="confirm-button ok-btn">确定重新开启</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>



<!-- 底部区域 -->
{% include "user/footer.html" %}

    <!--获取是否可编辑-->
    <script>
        // 读取所有编辑权限数据
        const appData = document.getElementById('app-data').dataset;

        // 转换为布尔值
        const permissions = {
            isDescriptionEditor: appData.isDescriptionEditor === 'true',
            isAnalysisEditor: appData.isAnalysisEditor === 'true',
            isSolutionEditor: appData.isSolutionEditor === 'true',
            isRegressionEditor: appData.isRegressionEditor === 'true',
            currentUserId: parseInt(appData.currentUserId)
        };
        // 根据权限启用不同的功能
        if (permissions.isDescriptionEditor) {
            console.log('用户可以编辑描述');
        }

        if (permissions.isAnalysisEditor) {
            console.log('用户可以编辑原因分析');
        }

        if (permissions.isSolutionEditor) {
            console.log('用户可以编辑解决方案');
        }

        if (permissions.isRegressionEditor) {
            console.log('用户可以编辑回归测试');
        }

        // 清理编辑器内容 - 移除空段落和冗余空格
        function cleanEditorContent(content) {
            if (!content) return '';

            // 移除空段落和只有&nbsp;的段落
            let cleanedContent = content
                .replace(/<p>\s*(&nbsp;|\s)*\s*<\/p>/gi, '')  // 移除空段落
                .replace(/<p>(\s|&nbsp;)*<\/p>/gi, '')        // 移除只包含空格或&nbsp;的段落
                .replace(/(<p><br><\/p>)+/gi, '')             // 移除多个连续的<p><br></p>
                .replace(/<p>\s*<br>\s*<\/p>/gi, '')          // 移除<p><br></p>
                .trim();

            // 如果清理后内容为空，返回空字符串
            if (isEditorContentEmpty(cleanedContent)) {
                return '';
            }

            return cleanedContent;
        }
    </script>

    <!-- 公共方法 -->
    <script>
    // 判断富文本内容是否为空（包括默认的<p><br></p>情况）
    function isEditorContentEmpty(htmlContent) {
        if (!htmlContent) return true;

        // 替换所有&nbsp;为空格，移除所有HTML标签
        const plainText = htmlContent
            .replace(/&nbsp;/gi, ' ')
            .replace(/<[^>]*>/g, '');

        // 检查是否只包含空白字符
        return /^\s*$/.test(plainText);
    }

    </script>

    <!-- 1、指定缺陷描述人员 -->
    <script>
        // 验证指定缺陷描述人员表单
        function validateAssignDescriptionUserForm() {
            const form = document.getElementById('assignDescriptionUserForm');

            // 获取用户ID
            const testerId = form.querySelector('.assignee-id').value;
            if (!testerId) {
                showToast('warning', '请选择处理人员');
                return false;
            }

            // 获取审核意见
            const reviewNotes = form.querySelector('textarea[name="review_notes"]').value.trim();
            if (!reviewNotes) {
                showToast('warning', '请输入审核意见');
                return false;
            }

            return {
                tester_id: testerId,
                review_notes: reviewNotes
            };
        }

        // 提交指定缺陷描述人员
        async function submitAssignDescriptionUser() {
            try {
                // 1. 验证表单数据
                const formData = validateAssignDescriptionUserForm();
                if (!formData) return;

                // 2. 构建请求数据
                const requestData = {
                    invitees: [{
                        invitee_id: formData.tester_id,
                        review_notes: formData.review_notes
                    }]
                };

                // 3. 提交请求
                {% if defect %}
                const response = await fetch(`/defect/{{ defect.id|safe }}/assign-description-user-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.code === 0) {
                    showToast('success', result.message || '已成功设置缺陷描述人员');
                    $('#assignDescriptionUserModal').modal('hide');

                    // 可选：刷新页面或更新界面
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                    // 关闭对话框
                    $('#assignDescriptionUserModal').modal('hide');
                } else {
                    throw new Error(result.message || '设置缺陷描述人员失败');
                }
                {% else %}
                throw new Error('缺陷信息不存在');
                {% endif %}

            } catch (error) {
                console.error('提交指定缺陷描述人员失败:', error);
                showToast('error', error.message || '操作失败，请重试');
            }
        }

        // 为指定缺陷描述人员模态框初始化搜索功能
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化指定缺陷描述人员模态框的搜索功能
            const assignDescriptionModal = document.getElementById('assignDescriptionUserModal');
            if (assignDescriptionModal) {
                setupAssigneeSearchForDivisionItem(assignDescriptionModal);
            }

            // 为提交按钮添加事件监听
            document.getElementById('submitAssignDescriptionUser').addEventListener('click', function() {
                submitAssignDescriptionUser();
            });
        });
    </script>

    <!-- 2、指定原因分析人员 -->
    <script>
        // 配置按钮点击事件 - 显示确认弹窗
        if(document.getElementById('inviteAnalysisUserButton')!==null) {
            document.getElementById('inviteAnalysisUserButton').addEventListener('click', function () {
                // 重置表单状态
                $('#inviteeMembersContainer .invitee-item').each(function(index) {
                    if (index > 0) {
                        $(this).remove();
                    } else {
                        // 重置第一个邀请项
                        $(this).find('.assignee-search').val('');
                        $(this).find('.selected-assignee-name').text('通过Email账号搜索成员，此处将会自动填充姓名').css('color', '#999');
                        $(this).find('.assignee-id').val('');
                        $(this).find('.assignee-email').val('');
                        $(this).find('.assignee-name').val('');
                        $(this).find('.invitee-reason').val('');
                    }
                });

                // 重置计数
                inviteeCount = 1;
                $('#inviteeCount').text(inviteeCount);

                // 初始化搜索功能
                document.querySelectorAll('.invitee-item').forEach(setupAssigneeSearchForDivisionItem);

                // 显示对话框
                var submitConfirmModal = new bootstrap.Modal(document.getElementById('inviteDevelopersLocateModal'));
                submitConfirmModal.show()
            });
        }
        // 发送邀请功能
        function sendInvite() {
            // 收集邀请人员数据
            const invitees = [];
            let isValid = true;
            const selectedIds = new Set();

            $('.invitee-item').each(function(index) {
                const inviteeId = $(this).find('.assignee-id').val();
                const inviteeName = $(this).find('.assignee-name').val();
                const inviteeEmail = $(this).find('.assignee-email').val();
                const reviewNotes = $(this).find('.invitee-reason').val();

                if (!inviteeId || !inviteeName || !inviteeEmail) {
                    isValid = false;
                    showToast('warning', `请选择处理人员`);
                    return false; // 退出循环
                }

                // 检查重复邀请
                if (selectedIds.has(inviteeId)) {
                    isValid = false;
                    showToast('warning', `用户 ${inviteeName} (${inviteeEmail}) 已被重复邀请，请检查`);
                    return false; // 退出循环
                }
                selectedIds.add(inviteeId);

                if (!reviewNotes) {
                    isValid = false;
                    showToast('warning', `请填写原因`);
                    return false; // 退出循环
                }

                invitees.push({
                    invitee_id: inviteeId,
                    review_notes: reviewNotes,
                    defect_type: "simplified"
                });
            });

            if (!isValid) return false;

            return invitees;
        }

        // 发送邀请按钮点击事件
        $('#sendInviteDevelopersLocateBtn').click(async function() {
            try {
                // 1. 首先验证并收集邀请人员数据
                const invitees = sendInvite();
                if (!invitees) return;

                // 2. 提交邀请开发人员请求
                {% if defect  %}
                const inviteResponse = await fetch(`/defect/{{ defect.id|safe }}/invite-developer-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                    },
                    body: JSON.stringify({ invitees: invitees })
                });
                const inviteResult = await inviteResponse.json();

                if (inviteResult.code === 0) {
                    showToast('success', inviteResult.message || '缺陷创建成功，并已发送开发人员邀请');
                    $('#inviteDevelopersLocateModal').modal('hide');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    throw new Error(inviteResult.message || '邀请开发人员失败');
                }
                {% endif %}
            } catch (error) {
                console.error('提交失败:', error);
                showToast('error', error.message || '操作失败');
            }
        });
    </script>

    <!-- 3、指定解决措施人员 JS-->
    <script>
    // ==================== 分配开发人员解决功能 ====================

    // 获取所有已选择的执行人员ID
    function getSelectedAssigneeIds() {
        const selectedIds = [];
        document.querySelectorAll('.division-item').forEach(item => {
            const idInput = item.querySelector('.assignee-id');
            if (idInput && idInput.value) {
                selectedIds.push(idInput.value);
            }
        });
        return selectedIds;
    }

    // 搜索用户功能
    function searchUsers(searchTerm, excludeIds = []) {
        if (!searchTerm || searchTerm.length < 1) {
            return [];
        }

        const term = searchTerm.toLowerCase();
        return userList.filter(user => {
            // 检查是否在排除列表中
            if (excludeIds.includes(user.user_id.toString())) {
                return false;
            }

            // 检查是否匹配
            const emailMatch = user.email && user.email.toLowerCase().includes(term);
            const nameMatch = user.name && user.name.toLowerCase().includes(term);
            const realNameMatch = user.real_name && user.real_name.toLowerCase().includes(term);

            return emailMatch || nameMatch || realNameMatch;
        });
    }

    // 为分工项设置执行人员搜索功能——公共方法
    function setupAssigneeSearchForDivisionItem(divisionItem) {
        const searchInput = divisionItem.querySelector('.assignee-search');
        const dropdown = divisionItem.querySelector('.assignee-dropdown');
        const nameDisplay = divisionItem.querySelector('.selected-assignee-name');
        const assigneeId = divisionItem.querySelector('.assignee-id');
        const assigneeEmail = divisionItem.querySelector('.assignee-email');
        const assigneeName = divisionItem.querySelector('.assignee-name');

        // 获取当前已选择的ID（排除自己）
        const currentSelectedId = assigneeId ? assigneeId.value : '';
        const otherSelectedIds = getSelectedAssigneeIds().filter(id => id !== currentSelectedId);

        // 为搜索框添加自动完成功能
        if (!searchInput) {
            console.log('未找到 searchInput 的元素');
            return;
        }
        searchInput.addEventListener('input', function() {
            const value = this.value.trim();
            dropdown.innerHTML = '';

            // 补充：同步清空功能
            if (value.length === 0) {
                nameDisplay.textContent = '通过Email账号搜索成员，此处将会自动填充姓名';
                nameDisplay.style.color = '#999';
                if (assigneeId) assigneeId.value = '';
                if (assigneeEmail) assigneeEmail.value = '';
                if (assigneeName) assigneeName.value = '';
                dropdown.style.display = 'none';
                return;
            }

            if (value.length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            // 搜索匹配的用户
            const matches = searchUsers(value, otherSelectedIds);

            if (matches.length === 0) {
                dropdown.innerHTML = '<div style="padding: 8px 12px; color: #999;">未找到匹配的用户</div>';
                dropdown.style.display = 'block';
                return;
            }

            // 显示匹配结果
            matches.forEach(user => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.style.padding = '8px 12px';
                item.style.cursor = 'pointer';
                item.style.borderBottom = '1px solid #f0f0f0';
                item.style.transition = 'background-color 0.2s';

                item.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });

                const displayName = user.real_name || user.name || '未知用户';
                const displayEmail = user.email || '无邮箱';

                item.innerHTML = `
                    <div style="font-weight: 500; color: #222;">${displayName}</div>
                    <small style="color: #666;">${displayEmail}</small>
                `;

                item.addEventListener('click', function() {
                    searchInput.value = displayEmail;
                    nameDisplay.textContent = displayName;
                    nameDisplay.style.color = '#222';
                    assigneeId.value = user.user_id;
                    assigneeEmail.value = displayEmail;
                    assigneeName.value = displayName;
                    dropdown.style.display = 'none';

                    // 更新所有下拉列表，排除已选择的用户
                    updateAllAssigneeDropdowns();
                });

                dropdown.appendChild(item);
            });

            dropdown.style.display = 'block';
        });

        // 点击外部时隐藏下拉框
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // 搜索框聚焦时显示下拉框（如果有内容）
        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length > 0) {
                const event = new Event('input');
                this.dispatchEvent(event);
            }
        });
    }

    // 更新所有执行人员下拉列表，排除已选择的用户
    function updateAllAssigneeDropdowns() {
        document.querySelectorAll('.division-item').forEach(item => {
            const searchInput = item.querySelector('.assignee-search');
            if (searchInput) {
                // 触发输入事件以刷新下拉列表
                const event = new Event('input', { bubbles: true });
                searchInput.dispatchEvent(event);
            }
        });
    }

    // 验证分工表单
    function validateDivisionForm() {
        const divisions = [];
        let isValid = true;
        const selectedIds = new Set();
        const errors = [];

        $('.division-item').each(function(index) {
            const module = $(this).find('.division-module').val().trim();
            const dueDate = $(this).find('.division-due-date').val();
            const assigneeId = $(this).find('.assignee-id').val();
            const assigneeName = $(this).find('.assignee-name').val();
            const assigneeEmail = $(this).find('.assignee-email').val();
            const actionPlan = $(this).find('.division-action-plan').val().trim();

            // 验证必填字段
            if (!assigneeId) {
                errors.push(`请选择处理人员`);
                isValid = false;
            }
            if (!actionPlan) {
                errors.push(`审核意见不能为空`);
                isValid = false;
            }

            // 检查重复分配
            if (assigneeId && selectedIds.has(assigneeId)) {
                errors.push(`用户 ${assigneeName} (${assigneeEmail}) 已被重复分配，请检查`);
                isValid = false;
            }
            if (assigneeId) {
                selectedIds.add(assigneeId);
            }

            divisions.push({
                module: module,
                due_date: dueDate,
                assignee_id: assigneeId,
                review_notes: actionPlan
            });
        });

        if (!isValid) {
            showToast('warning', errors.join(' | '));
            return null;
        }

        if (divisions.length === 0) {
            showToast('warning', '请至少添加一个分工');
            return null;
        }

        return divisions;
    }

    // DOM加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化已有的分工项的执行人员搜索
        document.querySelectorAll('.division-item').forEach(setupAssigneeSearchForDivisionItem);

        let divisionCount = 1;

        // 添加分工项
        $('#addDivisionSolution').click(function() {
            divisionCount++;
            const newItem = $(`
                <div class="division-item" data-item-index="${divisionCount}">
                    <!-- 分工基本信息区域 -->
                    <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1; margin-right: 20px;">
                            <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">
                                <span style="color: red;">*</span> 修改模块
                            </label>
                            <input type="text" class="form-control division-module" placeholder="请输入修改模块" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;">
                        </div>

                        <div class="form-group" style="flex: 1; margin-right: 20px;">
                            <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">
                                <span style="color: red;">*</span> 完成时间
                            </label>
                            <input type="date" class="form-control division-due-date" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;">
                        </div>

                        <div class="form-group" style="flex: 1;">
                            <button type="button" class="remove-division-btn" style="float: right;color: #FE6380;border: 1px solid #FE6380;background: #fff;border-radius: 4px;padding: 2px 8px;font-size: 12px;cursor: pointer;margin-top: 24px;">移除</button>
                        </div>
                    </div>

                    <!-- 人员选择区域 -->
                    <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1; margin-right: 20px;">
                            <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">
                                <span style="color: red;">*</span> 执行人员
                            </label>
                            <div style="position: relative;">
                                <input type="text" class="form-control assignee-search" placeholder="搜索成员" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                                <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                                <!-- 下拉框 -->
                                <div class="assignee-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;">
                                    <!-- 动态生成搜索结果 -->
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="width: 50%;">
                            <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">姓名</label>
                            <div class="selected-assignee-name" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;color: #999;display: flex;align-items: center;">
                                通过Email账号搜索成员，此处将会自动填充姓名
                            </div>
                        </div>
                    </div>

                    <!-- 解决措施输入区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label-style"><span style="color: red;">*</span> 解决措施</label>
                        <textarea class="division-action-plan text-area-border" placeholder="请输入解决措施" rows="3"></textarea>
                    </div>
                    <input type="hidden" class="assignee-id">
                    <input type="hidden" class="assignee-email">
                    <input type="hidden" class="assignee-name">
                </div>
            `);

            $('#divisionSolutionContainer').append(newItem);

            // 为新添加的分工项设置执行人员搜索
            setupAssigneeSearchForDivisionItem(newItem[0]);

            // 更新计数
            $('#divisionSolutionCount').text(divisionCount);
            updateRemoveDivisionButtons();
        });

        // 移除分工项
        $(document).on('click', '.remove-division-btn', function() {
            if ($('.division-item').length > 1) {
                $(this).closest('.division-item').remove();
                divisionCount--;
                $('#divisionSolutionCount').text(divisionCount);
                updateRemoveDivisionButtons();

                // 更新所有下拉列表，因为已选择的用户减少了
                updateAllAssigneeDropdowns();
            }
        });

        // 更新移除按钮状态
        function updateRemoveDivisionButtons() {
            if ($('.division-item').length === 1) {
                $('.remove-division-btn').hide();
            } else {
                $('.remove-division-btn').show();
            }
        }

        // 初始化移除按钮状态
        updateRemoveDivisionButtons();

        // 显示邀请开发人员解决模态框
        $('#inviteDevelopersButton').click(function() {
            // 重置表单状态
            $('#divisionSolutionContainer .division-item').each(function(index) {
                if (index > 0) {
                    $(this).remove();
                } else {
                    // 重置第一个分工项
                    $(this).find('.division-module').val('');
                    $(this).find('.division-due-date').val('');
                    $(this).find('.assignee-search').val('');
                    $(this).find('.selected-assignee-name').text('通过Email账号搜索成员，此处将会自动填充姓名').css('color', '#999');
                    $(this).find('.assignee-id').val('');
                    $(this).find('.assignee-email').val('');
                    $(this).find('.assignee-name').val('');
                    $(this).find('.division-action-plan').val('');
                }
            });

            // 重置计数
            divisionCount = 1;
            $('#divisionSolutionCount').text(divisionCount);
            updateRemoveDivisionButtons();

            // 初始化搜索功能
            document.querySelectorAll('.division-item').forEach(setupAssigneeSearchForDivisionItem);

            $('#inviteDevelopersSolutionModal').modal('show');
        });

        // 发送分配请求
        $('#sendInviteSolutionBtn').click(async function() {
            try {
                // 1. 验证并收集分工数据
                const divisions = validateDivisionForm();
                if (!divisions) return;

                // 2. 发送分配请求
                const defectId = {{ defect.id }};
                const url = `/defect/${defectId}/assign-for-solution-api`;

                // 显示加载状态
                const $btn = $('#sendInviteSolutionBtn');
                const originalText = $btn.html();
                $btn.prop('disabled', true).html('发送中...');

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                    },
                    body: JSON.stringify({
                        divisions: divisions
                    })
                });

                const result = await response.json();

                if (result.code === 0) {
                    showToast('success', result.message || '分配成功');
                    $('#inviteDevelopersSolutionModal').modal('hide');

                    // 刷新页面或更新界面
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    throw new Error(result.message || '分配失败');
                }
            } catch (error) {
                console.error('分配请求失败:', error);
                showToast('error', '分配失败: ' + error.message);
            } finally {
                // 恢复按钮状态
                const $btn = $('#sendInviteSolutionBtn');
                $btn.prop('disabled', false).html(`提交 <span style="display:none" id="divisionSolutionCount">${divisionCount}</span>`);
            }
        });
    });
    </script>


    <!-- 4、指定回归测试人员 JS -->
    <script>
        let selectedRegressionMember = null;
        // 提交审核函数
        function submitSolutionReview(isApproved) {
            // 验证审核意见是否填写
            const reviewNotes = document.getElementById('review_notes_in_review_solution_dialog').value.trim();
            if (!reviewNotes) {
                showToast('warning', '请填写审核意见');
                return;
            }

            if (isApproved) {
                // 如果是同意，需要验证是否选择了测试人员
                if (!selectedRegressionMember) {
                    showToast('warning', '请先搜索并选择一个测试人员');
                    document.getElementById('regressionMemberSearch').focus();
                    return;
                }

                // 设置审核结果和审核意见
                document.getElementById('approved_in_review_solution_dialog').value = "true";
                //document.getElementById('review_notes_in_review_solution_dialog').value = reviewNotes;

                // 提交表单
                document.getElementById('reviewSolutionForm').submit();
                showToast('info', '正在提交...', 2000);
            } else {
                // 设置审核结果
                $('#approved_in_review_solution_dialog').val("false");
                // 验证审核意见是否填写
                const reviewNotes = document.getElementById('review_notes_in_review_solution').value.trim();
                if (!reviewNotes) {
                    showToast('warning', '请填写审核意见');
                    return;
                }
                $('#review_notes_in_review_solution_dialog').val(reviewNotes);

                // 提交表单
                document.getElementById('reviewSolutionForm').submit();
            }
        }

        // 成员搜索功能
        document.getElementById('regressionMemberSearch').addEventListener('input', function() {
            const searchTerm = this.value.trim();
            const dropdown = document.getElementById('regressionMemberDropdown');

            // 同步清空功能：当搜索框为空时，清空姓名和隐藏字段
            if (searchTerm.length === 0) {
                selectedRegressionMember = null;
                document.getElementById('selectedRegressionMemberName').innerHTML = '通过Email账号搜索测试人员，此处将会自动填充姓名';
                document.getElementById('selectedRegressionMemberName').classList.remove('has-selection');
                document.getElementById('selectedRegressionMemberName').style.color = '#999';
                document.getElementById('regressionMember_id').value = '';
                dropdown.style.display = 'none';
                return;
            }

            const lowerSearchTerm = searchTerm.toLowerCase();
            // 搜索匹配的成员
            const matchedMembers = userList.filter(function(member) {
                return member.email.toLowerCase().includes(lowerSearchTerm) ||
                       member.name.toLowerCase().includes(lowerSearchTerm);
            });

            if (matchedMembers.length > 0) {
                // 生成下拉框内容
                let dropdownHtml = '';
                matchedMembers.forEach(function(member) {
                    dropdownHtml += `
                        <div class="member-dropdown-item"
                             data-userid="${member.user_id}"
                             data-email="${member.email}"
                             data-name="${member.name}"
                             data-department="${member.department}">
                            <div><strong>${member.name}</strong> / ${member.email}</div>
                            <small class="text-muted">${member.department}</small>
                        </div>`;
                });

                dropdown.innerHTML = dropdownHtml;
                dropdown.style.display = 'block';
            } else {
                selectedRegressionMember = null;
                document.getElementById('selectedRegressionMemberName').innerHTML = '未找到匹配的测试人员';
                document.getElementById('selectedRegressionMemberName').classList.remove('has-selection');
                document.getElementById('selectedRegressionMemberName').style.color = '#ff6b6b';
                document.getElementById('regressionMember_id').value = '';
                dropdown.style.display = 'none';
            }
        });

        // 下拉框选项点击事件
        document.addEventListener('click', function(e) {
            if (e.target.closest('.member-dropdown-item')) {
                const item = e.target.closest('.member-dropdown-item');
                const email = item.getAttribute('data-email');
                const name = item.getAttribute('data-name');
                const userID = item.getAttribute('data-userid');
                const department = item.getAttribute('data-department');

                // 设置选中的成员
                selectedRegressionMember = {
                    userID: userID,
                    email: email,
                    name: name,
                    department: department
                };

                // 填充输入框和姓名显示
                document.getElementById('regressionMemberSearch').value = email;
                document.getElementById('regressionMember_id').value = userID;
                const nameElement = document.getElementById('selectedRegressionMemberName');
                nameElement.innerHTML = `${name} (${department})`;
                nameElement.classList.add('has-selection');
                nameElement.style.color = '#222';

                // 隐藏下拉框
                document.getElementById('regressionMemberDropdown').style.display = 'none';

                // 显示成功消息
                showToast('success', `已选择人员: ${name}`);
            }

            // 点击其他地方隐藏下拉框
            if (!e.target.closest('#regressionMemberSearch') && !e.target.closest('#regressionMemberDropdown')) {
                document.getElementById('regressionMemberDropdown').style.display = 'none';
            }
        });

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 添加一些示例交互
            document.getElementById('regressionMemberSearch').addEventListener('focus', function() {
                if (this.value.length > 0) {
                    document.getElementById('regressionMemberDropdown').style.display = 'block';
                }
            });
        });
    </script>

    <!-- 5、提交整个页面的数据-->
    <script>
     async  function sendData(act='audit'){

            const descriptionContent = getDescriptionContent() || "";
            const analysisContent = getAnalysisContent() || "";
            const solutionContent = getSolutionContent() || "";
            const regressionContent = getRegressionContent() || "";
            console.log(solutionContent);
            console.log(regressionContent);
            if (descriptionContent === "" && analysisContent === "" && solutionContent === "" && regressionContent === "") {
                showToast('warning', '各评估项内容均为空，请填写后再提交。');
                return;
            }
            // 获取缺陷基本信息
            const title = $('#title').val();
            const severity = $('input[name="severity"]:checked').val();
            const defect_reproducibility = $('input[name="defect_reproducibility"]:checked').val();
            const project_version_id = $('#project_version_id').val();

            // 构造表单数据
            const formData = {
                descriptionContent: descriptionContent,
                analysisContent: analysisContent,
                solutionContent: solutionContent,
                regressionContent: regressionContent,
                // 新增缺陷基本信息
                title: title,
                severity: severity,
                defect_reproducibility: defect_reproducibility,
                project_version_id: project_version_id,
                act:act
            };
            const defectId = {{ defect.id }};

            try {
                // 第一步：提交回归测试结果
                const submitAllResponse = await fetch(`/defect/${defectId}/submit-all-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                    },
                    body: JSON.stringify(formData)
                });

                const submitAllResult = await submitAllResponse.json();
                console.log(submitAllResult);
                if (submitAllResult.code === 0) {
                    showToast('success', submitAllResult.message);
                    if(submitAllResult.data.changed_items.includes("确认关闭")){
                            setTimeout(function() {
                            showToast('success', "缺陷单已关闭");
                            location.href = "/defect/simplified2/{{ defect.id }}"
                        }, 2000);
                    }
                    if(submitAllResult.data.changed_items.includes("缺陷基本信息")
                        ||submitAllResult.data.changed_items.includes("缺陷描述")
                        ||submitAllResult.data.changed_items.includes("原因分析")
                        ||submitAllResult.data.changed_items.includes("解决措施")
                        ||submitAllResult.data.changed_items.includes("回归测试")
                    ){
                         return submitAllResult.data.changed_items.join(',');
                    }
                    else{
                        if(submitAllResult.need_val===true){
                            return "1"
                        }
                        return ""
                    }

                } else {
                    showToast('error', submitAllResult.message || '提交失败');
                    return "-1"
                }
            } catch (error) {
                console.error('提交过程中发生错误:', error);
                showToast('error', '网络错误，请稍后重试');
                return "-1"
            }
        }
        // 提交基本信息和各阶段信息
        $(document).on('click', '#submitAll', function() {
           sendData('audit').then((rs) => {
                let is_change = ""
                let changed_items = ""
                if(rs==="1"){
                    is_change = ""
                    changed_items = ""
                }else if (rs===""||rs ==="-1"){
                    return
                }else{
                    is_change = "1"
                    changed_items = rs
                }
                location.href = "/defect/simplified2/{{defect.id}}?stage_type=simplified2&ai_done_act=audit&is_change="+is_change+"&changed_items="+changed_items
           });
        });

        // 提交基本信息和各阶段信息——暂存
        $(document).on('click', '#saveDraftBtn', function() {
           sendData('draft').then((rs) => {
                let is_change = ""
                let changed_items = ""
                if(rs==="1"){
                    is_change = ""
                    changed_items = ""
                }else if (rs===""||rs ==="-1"){
                    return
                }else{
                    is_change = ""
                    changed_items = rs
                }
                //location.href = "/defect/simplified2/{{defect.id}}?stage_type=simplified2&is_change="+is_change+"&changed_items="+changed_items
           });
        });

        $(document).on('click','.ai-review-multi',function(){
            sendData('self').then((rs) => {
                if(rs!="-1"){
                    location.href = "/defect/simplified2/{{defect.id}}?ai_done_act=self&stage_type=simplified2&changed_items="+rs
                }
            });
        })
    </script>


    <!--右侧悬浮导航区域-->
    <script>
        // 右侧菜单双向联动功能（优化版）
        $(document).ready(function() {
            // 初始化右侧菜单项
            const menuItems = $('.right-menu div[data-target]');
            const sections = {};

            // 收集所有内容区域的位置信息
            menuItems.each(function() {
                const targetId = $(this).data('target');
                const section = document.getElementById(targetId);
                if (section) {
                    sections[targetId] = {
                        element: section,
                        menuItem: $(this)
                    };
                }
            });

            // 获取最后一个菜单项（确认关闭）
            const lastMenuItem = $('.right-menu div[data-target="confirmClose"]');
            const lastSectionId = 'confirmClose';

            // 点击右侧菜单滚动到对应区域
            function scrollToSection(targetId) {
                const sectionData = sections[targetId];
                if (sectionData) {
                    // 移除所有高亮
                    $('.right-menu div').each(function() {
                        $(this).find('.right-menu-active-img').remove();
                    });

                    // 高亮当前菜单项
                    sectionData.menuItem.prepend(
                        '<img class="right-menu-active-img" src="/static/images/aival/left-tag.svg" alt="">'
                    );

                    // 平滑滚动到目标位置
                    const headerOffset = 100; // 根据你的header高度调整
                    const elementPosition = sectionData.element.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            }

            // 更新右侧菜单的点击事件
            $('.right-menu div[data-target]').on('click', function() {
                const targetId = $(this).data('target');
                scrollToSection(targetId);
            });

            // 滚动时自动高亮对应的菜单项
            function updateActiveMenuOnScroll() {
                const scrollPosition = window.scrollY;
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;

                // 检查是否滚动到了页面底部
                const isBottom = (scrollPosition + windowHeight >= documentHeight - 50);

                if (isBottom && sections[lastSectionId]) {
                    // 如果滚动到底部，高亮"确认关闭"
                    const currentMenuItem = sections[lastSectionId].menuItem;
                    if (!currentMenuItem.find('.right-menu-active-img').length) {
                        // 移除所有高亮
                        $('.right-menu div').each(function() {
                            $(this).find('.right-menu-active-img').remove();
                        });

                        // 高亮"确认关闭"菜单项
                        currentMenuItem.prepend(
                            '<img class="right-menu-active-img" src="/static/images/aival/left-tag.svg" alt="">'
                        );
                    }
                    return; // 底部状态，直接返回
                }

                // 正常滚动状态：查找当前最接近视口顶部的section
                let currentSection = null;
                let minDistance = Infinity;

                for (const [sectionId, sectionData] of Object.entries(sections)) {
                    const rect = sectionData.element.getBoundingClientRect();
                    const sectionTop = rect.top + window.pageYOffset;

                    // 如果section在视口中，或者刚好在视口上方
                    if (scrollPosition >= sectionTop - 150) { // 添加150px的缓冲区域
                        const distance = scrollPosition - sectionTop;
                        if (distance < minDistance) {
                            minDistance = distance;
                            currentSection = sectionId;
                        }
                    }
                }

                // 如果没有找到，默认选择第一个
                if (!currentSection && Object.keys(sections).length > 0) {
                    currentSection = Object.keys(sections)[0];
                }

                // 更新菜单高亮
                if (currentSection && sections[currentSection]) {
                    const currentMenuItem = sections[currentSection].menuItem;
                    if (!currentMenuItem.find('.right-menu-active-img').length) {
                        // 移除所有高亮
                        $('.right-menu div').each(function() {
                            $(this).find('.right-menu-active-img').remove();
                        });

                        // 添加当前高亮
                        currentMenuItem.prepend(
                            '<img class="right-menu-active-img" src="/static/images/aival/left-tag.svg" alt="">'
                        );
                    }
                }
            }

            // 监听滚动事件
            $(window).on('scroll', function() {
                // Header滚动效果
                const header = $('.header');
                const scrollPosition = $(this).scrollTop();
                const scrollThreshold = 50;
                const scrollRightMenu = 400;

                if (header.length) {
                    if (scrollPosition > scrollThreshold) {
                        header.addClass('header-scrolled');
                    } else {
                        header.removeClass('header-scrolled');
                    }

                    if (scrollPosition > scrollRightMenu) {
                        $('.right-menu').css({
                            'position': 'fixed',
                            'top': '50px'
                        });
                    } else {
                        $('.right-menu').css({
                            'position': 'absolute',
                            'top': '400px'
                        });
                    }
                }

                // 更新菜单高亮
                updateActiveMenuOnScroll();
            });

            // 添加页面加载后的初始高亮
            $(window).on('load', function() {
                // 初始检查是否在底部
                const scrollPosition = window.scrollY;
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;
                const isBottom = (scrollPosition + windowHeight >= documentHeight - 50);

                if (isBottom && sections[lastSectionId]) {
                    // 页面加载时就在底部，高亮"确认关闭"
                    $('.right-menu div').each(function() {
                        $(this).find('.right-menu-active-img').remove();
                    });
                    sections[lastSectionId].menuItem.prepend(
                        '<img class="right-menu-active-img" src="/static/images/aival/left-tag.svg" alt="">'
                    );
                } else {
                    // 否则正常高亮
                    setTimeout(updateActiveMenuOnScroll, 100);
                }
            });

            // 防止滚动事件过于频繁触发，添加节流
            let scrollTimer = null;
            $(window).on('scroll', function() {
                if (scrollTimer) {
                    clearTimeout(scrollTimer);
                }
                scrollTimer = setTimeout(updateActiveMenuOnScroll, 150);
            });

            // 添加窗口大小变化时的重新计算
            $(window).on('resize', function() {
                setTimeout(updateActiveMenuOnScroll, 100);
            });
        });

        // 如果需要，可以保留原有的rightMenuLocation函数作为兼容
        function rightMenuLocation(id, obj) {
            const element = document.getElementById(id);
            if (element) {
                // 移除所有高亮
                $('.right-menu div').each(function() {
                    $(this).find('.right-menu-active-img').remove();
                });

                // 高亮当前菜单项
                $(obj).prepend('<img class="right-menu-active-img" src="/static/images/aival/left-tag.svg" alt="" >');

                // 平滑滚动
                const headerOffset = 100;
                const elementPosition = element.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }
        }
        </script>

    <!--图片放大 效果-->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 创建图片放大所需的DOM元素
            const overlay = document.createElement('div');
            overlay.className = 'image-modal-overlay';

            const content = document.createElement('div');
            content.className = 'image-modal-content';

            const img = document.createElement('img');
            img.className = 'image-modal-img';

            const closeBtn = document.createElement('div');
            closeBtn.className = 'image-modal-close';
            closeBtn.innerHTML = '&times;';

            const caption = document.createElement('div');
            caption.className = 'image-modal-caption';

            // 组装元素
            content.appendChild(img);
            content.appendChild(closeBtn);
            content.appendChild(caption);
            overlay.appendChild(content);

            // 添加到body
            document.body.appendChild(overlay);

            // 使用事件委托处理图片点击
            function handleImageClick(event) {
                // 检查点击的是否是图片
                if (event.target.tagName === 'IMG') {
                    // 检查图片是否在目标区域
                    const parentIds = ['defect_description', 'cause_analysis', 'solution_content', 'result_content'];
                    const targetId = event.target.closest('[id]')?.id;

                    if (parentIds.includes(targetId) ||
                        event.target.closest('.view-mode-content') ||
                        event.target.closest('.editor-content')) {

                        // 设置放大图片的src和alt
                        img.src = event.target.src;
                        caption.textContent = event.target.alt || '图片预览';

                        // 显示模态框
                        overlay.classList.add('active');

                        // 阻止事件冒泡
                        event.stopPropagation();
                    }
                }
            }

            // 绑定事件到文档，使用事件委托
            document.addEventListener('click', handleImageClick);

            // 监听编辑器内容变化（如果是富文本编辑器）
            function setupEditorListeners() {
                const editorElements = document.querySelectorAll('.editor-content, .view-mode-content');
                editorElements.forEach(element => {
                    // 如果编辑器使用MutationObserver来监听内容变化
                    if (typeof MutationObserver !== 'undefined') {
                        const observer = new MutationObserver(function(mutations) {
                            mutations.forEach(function(mutation) {
                                if (mutation.addedNodes.length) {
                                    // 新内容添加时，无需额外处理，因为事件委托已经处理
                                }
                            });
                        });

                        observer.observe(element, {
                            childList: true,
                            subtree: true
                        });
                    }
                });
            }

            // 初始设置编辑器监听
            setupEditorListeners();

            // 关闭模态框的事件
            closeBtn.addEventListener('click', function() {
                overlay.classList.remove('active');
                event.stopPropagation();
            });

            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    overlay.classList.remove('active');
                }
            });

            // 支持ESC键关闭
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && overlay.classList.contains('active')) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>

    <!--存储表格中缺陷描述编辑器实例-->
    <script>
        let editorInstanceDescription = null;

        // 初始化缺陷描述编辑器
        function initDescriptionEditorInTable(initialContent = '') {
            const { createEditor, createToolbar } = window.wangEditor;

            const editorConfig = {
                placeholder: '请输入缺陷描述...',
                onChange: (editor) => {
                    // 内容变化时更新隐藏的textarea字段
                    updateDescriptionField();
                },
                scroll: true,
                autoFocus: false,
                MENU_CONF: {}
            };

            // 配置上传图片
            editorConfig.MENU_CONF['uploadImage'] = {
                server: '/user/aiVal/upload_pic',
                fieldName: 'file',
                maxFileSize: 5 * 1024 * 1024,
                maxNumberOfFiles: 1,
                async customInsert(res, insertFn) {
                    if (res.code == 1) {
                        const imgNode = insertFn(res.url);

                        try {
                            const response = await fetch('/user/aiVal/create_evaluate_image', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    url: res.url
                                })
                            });

                            const result = await response.json();

                            if (result.success && result.id) {
                                console.log('保存图片信息成功:', result.id);
                            } else {
                                console.error('保存图片信息失败:', result.message);
                            }
                        } catch (error) {
                            console.error('保存图片失败:', error);
                        }
                    } else {
                        showToast('error', '上传失败');
                    }
                }
            };

            // 清理初始内容
            const cleanedInitialContent = cleanEditorContent(initialContent);

            const editor = createEditor({
                selector: '#editor-content-description',
                config: editorConfig,
                html: cleanedInitialContent || ''
            });

            // 创建工具栏
            createToolbar({
                editor,
                selector: '#toolbar-container-description',
                config: {
                    toolbarKeys: ['uploadImage'],
                    excludeKeys: [
                        'insertVideo',
                        'codeBlock',
                    ],
                    maxToolbarLength: 10
                }
            });

            return editor;
        }

        // 更新缺陷描述字段
        function updateDescriptionField() {
            if (editorInstanceDescription) {
                const content = editorInstanceDescription.getHtml();
                const textarea = document.querySelector('.table-description-text');
                if (textarea) {
                    textarea.value = content;
                }
            }
        }

        // 页面加载完成后初始化编辑器
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否在编辑模式（非只读模式）
            if (permissions.isDescriptionEditor) { // 可编辑
                // 获取初始内容
                const textarea = document.querySelector('.table-description-text');
                let initialContent = '';

                if (textarea) {
                    initialContent = textarea.value || '';
                } else {
                    // 如果没有textarea，从只读内容中获取
                    const viewContent = document.getElementById('view-mode-content-description');
                    if (viewContent) {
                        // 处理只读内容的复杂结构
                        const descriptionItems = viewContent.querySelectorAll('h4, div');
                        let content = '';

                        descriptionItems.forEach(element => {
                            if (element.tagName === 'H4') {
                                content += `<h4>${element.textContent}</h4>`;
                            } else if (element.tagName === 'DIV') {
                                content += `<div>${element.innerHTML}</div>`;
                            }
                        });

                        initialContent = content || viewContent.innerHTML;
                    }
                }

                // 初始化编辑器
                editorInstanceDescription = initDescriptionEditorInTable(initialContent);

                // 初始更新一次字段
                updateDescriptionField();
            }
        });

        // 获取缺陷描述内容(需要考虑编辑模式和查看模式)
        function getDescriptionContent() {
            if (editorInstanceDescription) {
                let retContent = editorInstanceDescription.getHtml();
                if (retContent === "<p><br></p>") {
                    retContent = "";
                }
                return retContent;
            } else {
                // 从 Flask 服务端参数 description_data 获取原始内容
                const descriptionData = {{ description_data | tojson | safe }};
                if (descriptionData &&
                    descriptionData[0] &&
                    descriptionData[0].content &&
                    descriptionData[0].content.description) {

                    const descriptionContent = descriptionData[0].content.description;

                    // 根据数据结构处理不同的格式
                    if (typeof descriptionContent === 'string') {
                        // 如果是字符串，直接返回
                        return descriptionContent;
                    }
                }
            }
            return '';
        }

        // 设置缺陷描述内容
        function setDescriptionContent(content) {
            if (editorInstanceDescription) {
                editorInstanceDescription.setHtml(content);
                updateDescriptionField();
            }
        }
    </script>

    <!--存储表格中原因分析编辑器实例-->
    <script>
        let editorInstanceAnalysis = null;

        // 初始化原因分析编辑器
        function initAnalysisEditorInTable(initialContent = '') {
            const { createEditor, createToolbar } = window.wangEditor;

            const editorConfig = {
                placeholder: '请输入原因分析...',
                onChange: (editor) => {
                    // 内容变化时更新隐藏的textarea字段
                    updateAnalysisField();
                },
                scroll: true,
                autoFocus: false,
                MENU_CONF: {}
            };

            // 配置上传图片
            editorConfig.MENU_CONF['uploadImage'] = {
                server: '/user/aiVal/upload_pic',
                fieldName: 'file',
                maxFileSize: 5 * 1024 * 1024,
                maxNumberOfFiles: 1,
                async customInsert(res, insertFn) {
                    if (res.code == 1) {
                        const imgNode = insertFn(res.url);

                        try {
                            const response = await fetch('/user/aiVal/create_evaluate_image', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    url: res.url
                                })
                            });

                            const result = await response.json();

                            if (result.success && result.id) {
                                console.log('保存图片信息成功:', result.id);
                            } else {
                                console.error('保存图片信息失败:', result.message);
                            }
                        } catch (error) {
                            console.error('保存图片失败:', error);
                        }
                    } else {
                        showToast('error', '上传失败');
                    }
                }
            };
            // 清理初始内容
            const cleanedInitialContent = cleanEditorContent(initialContent);

            const editor = createEditor({
                selector: '#editor-content-analysis',
                config: editorConfig,
                html: cleanedInitialContent || ''
            });

            // 创建工具栏
            createToolbar({
                editor,
                selector: '#toolbar-container-analysis',
                config: {
                    toolbarKeys: ['uploadImage'],
                    excludeKeys: [
                        'insertVideo',
                        'codeBlock',
                    ],
                    maxToolbarLength: 10
                }
            });

            return editor;
        }

        // 更新原因分析字段
        function updateAnalysisField() {
            if (editorInstanceAnalysis) {
                const content = editorInstanceAnalysis.getHtml();
                const textarea = document.querySelector('.table-analysis-text');
                if (textarea) {
                    textarea.value = content;
                }
            }
        }

        // 加载原因分析模板
        function loadAnalysisTemplate() {
            // 检查编辑器是否已初始化
            if (!editorInstanceAnalysis) {
                console.error('原因分析编辑器未初始化');
                showToast('error', '原因分析编辑器未初始化，请稍后重试');
                return;
            }

            // 显示加载状态
            const loadButton = document.getElementById('loadAnalysisTemplate');
            const originalText = loadButton.textContent;
            loadButton.textContent = '加载中...';
            loadButton.disabled = true;

            // 调用接口获取模板
            fetch('/template/原因分析')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取模板失败: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(templateData => {
                    if (templateData.items && templateData.items.length > 0) {
                        let templateHtml = '';

                        // 构建模板HTML内容
                        templateData.items.forEach((item) => {
                            const title = item.content.title || '';
                            const description = item.content.description || '';

                            // 将标题加粗并添加到模板中
                            templateHtml += `<p><strong>${title}</strong></p>`;

                            // 如果有描述内容，则添加描述
                            if (description) {
                                templateHtml += `<p>${description}</p>`;
                            }

                            // 每个项目之间添加换行
                            templateHtml += '<br>';
                        });

                        // 获取编辑器当前内容
                        const currentContent = editorInstanceAnalysis.getHtml();

                        // 判断当前编辑器是否有内容
                        if (cleanEditorContent(currentContent) !== '') {
                            // 如果有内容，则在后面追加模板内容
                            const newContent = currentContent + '<hr>' + templateHtml;
                            editorInstanceAnalysis.setHtml(newContent);
                        } else {
                            // 如果没有内容，直接设置模板内容
                            editorInstanceAnalysis.setHtml(templateHtml);
                        }

                        // 更新隐藏的textarea字段
                        updateAnalysisField();

                        // 滚动到编辑器位置
                        const editorContainer = document.getElementById('editor-content-analysis');
                        if (editorContainer) {
                            editorContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }

                        showToast('success', '原因分析模板加载成功');
                    } else {
                        showToast('warning', '原因分析模板内容为空');
                    }
                })
                .catch(error => {
                    console.error('加载原因分析模板失败:', error);
                    showToast('error', '加载原因分析模板失败: ' + error.message);
                })
                .finally(() => {
                    // 恢复按钮状态
                    loadButton.textContent = originalText;
                    loadButton.disabled = false;
                });
        }

        // 页面加载完成后初始化编辑器
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否在编辑模式（非只读模式）
            if (permissions.isAnalysisEditor) { // 可编辑
                // 获取初始内容
                const textarea = document.querySelector('.table-analysis-text');
                let initialContent = '';

                if (textarea) {
                    initialContent = textarea.value || '';
                } else {
                    // 如果没有textarea，从只读内容中获取
                    const viewContent = document.getElementById('view-mode-content-analysis');
                    if (viewContent) {
                        initialContent = viewContent.innerHTML;
                    }
                }

                // 初始化编辑器
                editorInstanceAnalysis = initAnalysisEditorInTable(initialContent);

                // 初始更新一次字段
                updateAnalysisField();

                // 为加载原因分析模板按钮添加点击事件
                const loadButton = document.getElementById('loadAnalysisTemplate');
                if (loadButton) {
                    loadButton.addEventListener('click', loadAnalysisTemplate);
                }
            }
        });

        // 获取原因分析内容(需要考虑编辑模式和查看模式)
        function getAnalysisContent() {
            if (editorInstanceAnalysis) {
                let retContent = editorInstanceAnalysis.getHtml();
                if (retContent === "<p><br></p>") {
                    retContent = "";
                }
                return retContent;
            } else {
                // 从 Flask 服务端参数 cause_analysis_data 获取原始内容
                const causeAnalysisData = {{ cause_analysis_data | tojson | safe }};
                if (causeAnalysisData &&
                    causeAnalysisData[0] &&
                    causeAnalysisData[0].content &&
                    causeAnalysisData[0].content.analyses) {

                    const analysisContent = causeAnalysisData[0].content.analyses;
                    if (analysisContent.length > 0) {
                        return analysisContent[0];
                    }
                }
            }
            return '';
        }

        // 设置编辑器内容
        function setAnalysisContent(content) {
            if (editorInstanceAnalysis) {
                editorInstanceAnalysis.setHtml(content);
                updateAnalysisField();
            }
        }

    </script>

    <!--存储表格中解决措施编辑器实例-->
    <script>
        // 存储表格中解决方案编辑器实例（单个实例）
        let editorInstanceSolution = null;

        // 初始化解决方案编辑器
        function initSolutionEditorInTable(initialContent = '') {
            const { createEditor, createToolbar } = window.wangEditor;

            const editorConfig = {
                placeholder: '请输入解决方案...',
                onChange: (editor) => {
                    // 内容变化时更新隐藏的textarea字段
                    updateSolutionField();
                },
                scroll: true,
                autoFocus: false,
                MENU_CONF: {}
            };

            // 配置上传图片
            editorConfig.MENU_CONF['uploadImage'] = {
                server: '/user/aiVal/upload_pic',
                fieldName: 'file',
                maxFileSize: 5 * 1024 * 1024,
                maxNumberOfFiles: 1,
                async customInsert(res, insertFn) {
                    if (res.code == 1) {
                        const imgNode = insertFn(res.url);

                        try {
                            const response = await fetch('/user/aiVal/create_evaluate_image', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    url: res.url
                                })
                            });

                            const result = await response.json();

                            if (result.success && result.id) {
                                console.log('保存图片信息成功:', result.id);
                            } else {
                                console.error('保存图片信息失败:', result.message);
                            }
                        } catch (error) {
                            console.error('保存图片失败:', error);
                        }
                    } else {
                        showToast('error', '上传失败');
                    }
                }
            };

            // 清理初始内容
            const cleanedInitialContent = cleanEditorContent(initialContent);

            // 创建编辑器
            const editor = createEditor({
                selector: '#editor-content-solution',
                config: editorConfig,
                html: cleanedInitialContent || ''
            });

            // 创建工具栏
            createToolbar({
                editor,
                selector: '#toolbar-container-solution',
                config: {
                    toolbarKeys: ['uploadImage'],
                    excludeKeys: [
                        'insertVideo',
                        'codeBlock',
                    ],
                    maxToolbarLength: 10
                }
            });

            return editor;
        }

        // 更新解决方案字段
        function updateSolutionField() {
            if (editorInstanceSolution) {
                const content = editorInstanceSolution.getHtml();
                const textarea = document.querySelector('.table-solution-text');
                if (textarea) {
                    textarea.value = content;
                }
            }
        }

        // 加载解决措施模板
        function loadSolutionTemplate() {
            // 检查编辑器是否已初始化
            if (!editorInstanceSolution) {
                console.error('解决措施编辑器未初始化');
                showToast('error', '解决措施编辑器未初始化，请稍后重试');
                return;
            }

            // 显示加载状态
            const loadButton = document.getElementById('loadSolutionTemplate');
            const originalText = loadButton.textContent;
            loadButton.textContent = '加载中...';
            loadButton.disabled = true;

            // 调用接口获取模板
            fetch('/template/解决措施')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取模板失败: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(templateData => {
                    if (templateData.items && templateData.items.length > 0) {
                        let templateHtml = '';

                        // 构建模板HTML内容
                        templateData.items.forEach((item) => {
                            const title = item.content.title || '';
                            const description = item.content.description || '';

                            // 将标题加粗并添加到模板中
                            templateHtml += `<p><strong>${title}</strong></p>`;

                            // 如果有描述内容，则添加描述
                            if (description) {
                                templateHtml += `<p>${description}</p>`;
                            }

                            // 每个项目之间添加换行
                            templateHtml += '<br>';
                        });

                        // 获取编辑器当前内容
                        const currentContent = editorInstanceSolution.getHtml();

                        // 判断当前编辑器是否有内容
                        if (cleanEditorContent(currentContent) !== '') {
                            // 如果有内容，则在后面追加模板内容
                            const newContent = currentContent + '<hr>' + templateHtml;
                            editorInstanceSolution.setHtml(newContent);
                        } else {
                            // 如果没有内容，直接设置模板内容
                            editorInstanceSolution.setHtml(templateHtml);
                        }

                        // 更新隐藏的textarea字段
                        updateSolutionField();

                        // 滚动到编辑器位置
                        const editorContainer = document.getElementById('editor-content-solution');
                        if (editorContainer) {
                            editorContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }

                        showToast('success', '解决措施模板加载成功');
                    } else {
                        showToast('warning', '解决措施模板内容为空');
                    }
                })
                .catch(error => {
                    console.error('加载解决措施模板失败:', error);
                    showToast('error', '加载解决措施模板失败: ' + error.message);
                })
                .finally(() => {
                    // 恢复按钮状态
                    loadButton.textContent = originalText;
                    loadButton.disabled = false;
                });
        }

        // 页面加载完成后初始化解决方案编辑器
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否在编辑模式（非只读模式）
            if (permissions.isSolutionEditor) {
                // 获取初始内容
                const textarea = document.querySelector('.table-solution-text');
                let initialContent = '';

                if (textarea) {
                    initialContent = textarea.value || '';
                } else {
                    // 如果没有textarea，从只读内容中获取
                    const viewContent = document.getElementById('view-mode-content-solution');
                    if (viewContent) {
                        initialContent = viewContent.innerHTML;
                    }
                }

                // 初始化编辑器
                editorInstanceSolution = initSolutionEditorInTable(initialContent);

                // 初始更新一次字段
                updateSolutionField();

                // 为加载解决措施模板按钮添加点击事件
                const loadButton = document.getElementById('loadSolutionTemplate');
                if (loadButton) {
                    loadButton.addEventListener('click', loadSolutionTemplate);
                }
            }
        });

        // 获取解决方案内容(需要考虑编辑模式和查看模式)
        function getSolutionContent() {
            if (editorInstanceSolution) {
                let retContent = editorInstanceSolution.getHtml();
                if (retContent === "<p><br></p>" || retContent === "<p>&nbsp;</p>") {
                    retContent = "";
                }
                return retContent;
            } else {
                // 从 Flask 服务端参数 solution_data 获取原始内容
                const solutionData = {{ solution_data | tojson | safe }};

                // 根据你的HTML模板，solution_data可能包含多个solution项
                if (solutionData &&
                    solutionData.length > 0 &&
                    solutionData[0] &&
                    solutionData[0].content &&
                    solutionData[0].content.solutions &&
                    Array.isArray(solutionData[0].content.solutions)) {

                    // 获取第一个solution项的solutions数组
                    const solutions = solutionData[0].content.solutions;

                    // 检查数组是否有内容
                    if (solutions.length > 0) {
                        // 返回第一个解决方案内容（根据你的HTML模板，这里只显示第一个）
                        const firstSolution = solutions[0];
                        return firstSolution;
                    }
                }
            }
            return '';
        }

        // 设置解决方案编辑器内容
        function setSolutionContent(content) {
            if (editorInstanceSolution) {
                editorInstanceSolution.setHtml(content);
                updateSolutionField();
            }
        }

        // 销毁解决方案编辑器
        function destroySolutionEditor() {
            if (editorInstanceSolution && editorInstanceSolution.destroy) {
                editorInstanceSolution.destroy();
                editorInstanceSolution = null;
            }
        }
    </script>

    <!--存储表格中回归测试编辑器实例-->
    <script>
        let editorInstanceRegression = null;

        // 初始化回归测试编辑器
        function initRegressionEditorInTable(initialContent = '') {
            const { createEditor, createToolbar } = window.wangEditor;

            const editorConfig = {
                placeholder: '请输入测试结果...',
                onChange: (editor) => {
                    // 内容变化时更新隐藏的textarea字段
                    updateRegressionField();
                },
                scroll: true,
                autoFocus: false,
                MENU_CONF: {}
            };

            // 配置上传图片
            editorConfig.MENU_CONF['uploadImage'] = {
                server: '/user/aiVal/upload_pic',
                fieldName: 'file',
                maxFileSize: 5 * 1024 * 1024,
                maxNumberOfFiles: 1,
                async customInsert(res, insertFn) {
                    if (res.code == 1) {
                        const imgNode = insertFn(res.url);

                        try {
                            const response = await fetch('/user/aiVal/create_evaluate_image', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    url: res.url
                                })
                            });

                            const result = await response.json();

                            if (result.success && result.id) {
                                console.log('保存图片信息成功:', result.id);
                            } else {
                                console.error('保存图片信息失败:', result.message);
                            }
                        } catch (error) {
                            console.error('保存图片失败:', error);
                        }
                    } else {
                        showToast('error', '上传失败');
                    }
                }
            };

            // 清理初始内容
            const cleanedInitialContent = cleanEditorContent(initialContent);

            const editor = createEditor({
                selector: '#editor-content-regression',
                config: editorConfig,
                html: cleanedInitialContent || ''
            });

            // 创建工具栏
            createToolbar({
                editor,
                selector: '#toolbar-container-regression',
                config: {
                    toolbarKeys: ['uploadImage'],
                    excludeKeys: [
                        'insertVideo',
                        'codeBlock',
                    ],
                    maxToolbarLength: 10
                }
            });

            return editor;
        }

        // 更新回归测试字段
        function updateRegressionField() {
            if (editorInstanceRegression) {
                const content = editorInstanceRegression.getHtml();
                const textarea = document.querySelector('.table-result-text');
                if (textarea) {
                    textarea.value = content;
                }
            }
        }

        // 加载回归测试模板
        function loadRegressionTemplate() {
            // 检查编辑器是否已初始化
            if (!editorInstanceRegression) {
                console.error('回归测试编辑器未初始化');
                showToast('error', '回归测试编辑器未初始化，请稍后重试');
                return;
            }

            // 显示加载状态
            const loadButton = document.getElementById('loadRegressionTemplate');
            const originalText = loadButton.textContent;
            loadButton.textContent = '加载中...';
            loadButton.disabled = true;

            // 调用接口获取模板
            fetch('/template/回归测试')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取模板失败: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(templateData => {
                    if (templateData.items && templateData.items.length > 0) {
                        let templateHtml = '';

                        // 构建模板HTML内容
                        templateData.items.forEach((item) => {
                            const title = item.content.title || '';
                            const description = item.content.description || '';

                            // 将标题加粗并添加到模板中
                            templateHtml += `<p><strong>${title}</strong></p>`;

                            // 如果有描述内容，则添加描述
                            if (description) {
                                templateHtml += `<p>${description}</p>`;
                            }

                            // 每个项目之间添加换行
                            templateHtml += '<br>';
                        });

                        // 获取编辑器当前内容
                        const currentContent = editorInstanceRegression.getHtml();

                        // 判断当前编辑器是否有内容
                        if (cleanEditorContent(currentContent) !== '') {
                            // 如果有内容，则在后面追加模板内容
                            const newContent = currentContent + '<hr>' + templateHtml;
                            editorInstanceRegression.setHtml(newContent);
                        } else {
                            // 如果没有内容，直接设置模板内容
                            editorInstanceRegression.setHtml(templateHtml);
                        }

                        // 更新隐藏的textarea字段
                        updateRegressionField();

                        // 滚动到编辑器位置
                        const editorContainer = document.getElementById('editor-content-regression');
                        if (editorContainer) {
                            editorContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }

                        showToast('success', '回归测试模板加载成功');
                    } else {
                        showToast('warning', '回归测试模板内容为空');
                    }
                })
                .catch(error => {
                    console.error('加载回归测试模板失败:', error);
                    showToast('error', '加载回归测试模板失败: ' + error.message);
                })
                .finally(() => {
                    // 恢复按钮状态
                    loadButton.textContent = originalText;
                    loadButton.disabled = false;
                });
        }

        // 页面加载完成后初始化编辑器和按钮事件
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否在编辑模式（非只读模式）
            if (permissions.isRegressionEditor) { // 可编辑
                // 获取初始内容
                const textarea = document.querySelector('.table-result-text');
                let initialContent = '';

                if (textarea) {
                    initialContent = textarea.value || '';
                } else {
                    // 如果没有textarea，从只读内容中获取
                    const viewContent = document.getElementById('view-mode-content-regression');
                    if (viewContent) {
                        // 处理只读内容的复杂结构
                        const resultItem = viewContent.querySelector('.result-item');
                        if (resultItem) {
                            initialContent = resultItem.innerHTML;
                        } else {
                            initialContent = viewContent.innerHTML;
                        }
                    }
                }

                // 初始化编辑器
                editorInstanceRegression = initRegressionEditorInTable(initialContent);

                // 初始更新一次字段
                updateRegressionField();

                // 为加载模板按钮添加点击事件
                const loadButton = document.getElementById('loadRegressionTemplate');
                if (loadButton) {
                    loadButton.addEventListener('click', loadRegressionTemplate);
                }
            }
        });

        // 获取回归测试内容(需要考虑编辑模式和查看模式)
        function getRegressionContent() {
            if (editorInstanceRegression) {
                let retContent = editorInstanceRegression.getHtml();
                if (retContent === "<p><br></p>") {
                    retContent = "";
                }
                return retContent;
            } else {
                // 从 Flask 服务端参数 test_result_data 获取原始内容
                const testResultData = {{ test_result_data | tojson | safe }};
                if (testResultData &&
                    testResultData[0] &&
                    testResultData[0].content &&
                    testResultData[0].content.description) {

                    const regressionContent = testResultData[0].content.description;
                    return regressionContent;
                }
            }
            return '';
        }

        // 设置回归测试内容
        function setRegressionContent(content) {
            if (editorInstanceRegression) {
                editorInstanceRegression.setHtml(content);
                updateRegressionField();
            }
        }
    </script>

    <!-- 关闭缺陷 -->
    <script>
        // 关闭缺陷功能
        $(document).ready(function() {
            // 确认关闭按钮点击事件
            $('#confirmCloseBtn').click(async function() {
                await handleCloseDefect();
            });

            // 监听模态框显示事件，重置表单
            $('#terminateModal').on('show.bs.modal', function() {
                resetCloseForm();
            });

            // 监听回车键提交
            $('#close_reason').keypress(function(e) {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();
                    $('#confirmCloseBtn').click();
                }
            });

            // 当选择"挂起"或"终止跟踪"时，可以更新模态框标题
            $('input[name="verificationStatus"]').change(function() {
                const status = $(this).val();
                let title = "关闭缺陷";

                switch(status) {
                    case 'suspended':
                        title = "挂起缺陷";
                        break;
                    case 'terminated':
                        title = "终止跟踪";
                        break;
                    case 'resolved':
                    default:
                        title = "关闭缺陷";
                        break;
                }

                // 更新模态框标题
                $('.modal-content .reject-icon').next().text(' ' + title);
            });
        });

        // 重置关闭表单
        function resetCloseForm() {
            $('#close_reason').val('');
            $('#status_error').hide();
            $('#reason_error').hide();
            $('#confirmCloseBtn').prop('disabled', false);

            // 根据条件设置默认选择
            const isRequesterConfirm = {{ 'true' if current_stage and current_stage.stage_type == 'requester_confirm' else 'false' }};

            if (isRequesterConfirm) {
                // 如果是确认阶段，选择"已解决"并启用
                $('#verification-resolved').prop('checked', true).prop('disabled', false);
                $('#verification-resolved').next().removeClass('text-muted');
                $('.modal-content .reject-icon').next().text(' 关闭缺陷');
            } else {
                // 如果不是确认阶段，禁用"已解决"选项，默认选择"挂起"
                $('#verification-resolved').prop('checked', false).prop('disabled', true);
                $('#verification-resolved').next().addClass('text-muted');
                $('#verification-suspended').prop('checked', true);
                $('.modal-content .reject-icon').next().text(' 挂起缺陷');
            }
        }

        // 处理关闭缺陷
        async function handleCloseDefect() {
            try {
                // 获取关闭状态和原因
                const verificationStatus = $('input[name="verificationStatus"]:checked').val();
                const reason = $('#close_reason').val().trim();

                // 验证输入
                let hasError = false;

                if (!verificationStatus) {
                    $('#status_error').text('请选择关闭状态');
                    $('#status_error').show();
                    hasError = true;
                } else {
                    $('#status_error').hide();
                }

                if (!reason) {
                    $('#reason_error').text('请输入关闭原因');
                    $('#reason_error').show();
                    hasError = true;
                } else {
                    $('#reason_error').hide();
                }

                if (hasError) {
                    return;
                }

                // 获取缺陷ID（根据实际情况调整）
                let defectId = {{ defect.id }};

                if (!defectId) {
                    console.error('Defect ID not found');
                    showToast('error', '无法获取缺陷信息');
                    $('#confirmCloseBtn').prop('disabled', false);
                    return;
                }

                // 检查是否尝试选择不可用的选项
                const isRequesterConfirm = {{ 'true' if current_stage and current_stage.stage_type == 'requester_confirm' else 'false' }};
                if (verificationStatus === 'resolved' && !isRequesterConfirm) {
                    showToast('error', '当前阶段无法选择"问题已解决，正常关闭"选项');
                    $('#confirmCloseBtn').prop('disabled', false);
                    return;
                }

                // 禁用按钮防止重复提交
                $('#confirmCloseBtn').prop('disabled', true);

                // 根据状态选择不同的API端点
                let apiEndpoint = '';
                let successMessage = '';

                switch(verificationStatus) {
                    case 'suspended':
                        apiEndpoint = `/defect/${defectId}/suspend-api`;
                        successMessage = '缺陷已成功挂起';
                        break;
                    case 'terminated':
                        apiEndpoint = `/defect/${defectId}/terminate-api`;
                        successMessage = '缺陷已成功终止跟踪';
                        break;
                    case 'resolved':
                    default:
                        apiEndpoint = `/defect/${defectId}/resolve-api`;
                        successMessage = '缺陷已成功关闭';
                        break;
                }

                // 调用API接口
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        verificationStatus: verificationStatus,
                        reason: reason
                    })
                });

                const result = await response.json();

                if (result.code === 0) {
                    // 成功
                    showToast('success', result.message || successMessage);

                    // 关闭模态框
                    $('#terminateModal').modal('hide');

                    // 延迟刷新页面，让用户看到成功提示
                    setTimeout(() => {
                        // 根据当前页面决定如何刷新
                        if (window.location.pathname.includes('/defect/')) {
                            location.reload();
                        } else {
                            location.reload();
                        }
                    }, 1500);
                } else {
                    // 失败
                    if (result.message.includes('状态')) {
                        $('#status_error').text(result.message);
                        $('#status_error').show();
                    } else if (result.message.includes('原因')) {
                        $('#reason_error').text(result.message);
                        $('#reason_error').show();
                    } else {
                        showToast('error', result.message || '操作失败');
                    }
                    $('#confirmCloseBtn').prop('disabled', false);

                    // 如果缺陷不存在，可能需要跳转
                    if (response.status === 404) {
                        setTimeout(() => {
                            window.location.href = '/defect/list';
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('操作失败:', error);
                $('#reason_error').text('网络错误，请稍后重试');
                $('#reason_error').show();
                $('#confirmCloseBtn').prop('disabled', false);
                showToast('error', '操作失败，请检查网络连接');
            }
        }

        // 如果你需要在其他位置触发关闭，可以调用这个函数
        function openCloseDefectModal(defectId, defaultStatus = 'resolved') {
            // 设置缺陷ID到按钮的data属性
            $('#closeDefectBtn').data('defect-id', defectId);

            // 根据条件设置默认选择
            const isRequesterConfirm = {{ 'true' if current_stage and current_stage.stage_type == 'requester_confirm' else 'false' }};
            let actualDefaultStatus = defaultStatus;

            if (defaultStatus === 'resolved' && !isRequesterConfirm) {
                actualDefaultStatus = 'suspended';
            }

            // 设置默认选择状态
            $(`#verification-${actualDefaultStatus}`).prop('checked', true).trigger('change');

            // 打开模态框
            $('#terminateModal').modal('show');
        }
    </script>

    <!-- 重新开启 -->
    <script>
        $(document).ready(function() {
            // 重新开启缺陷功能
            // 确定重新开启按钮点击事件
            $('#confirmReopenBtn').click(async function() {
                await handleReopenDefect();
            });

            // 监听模态框显示事件，重置表单
            $('#reopenModal').on('show.bs.modal', function() {
                resetReopenForm();
            });

            // 监听回车键提交（Shift+Enter换行，Enter提交）
            $('#reopen_reason').keypress(function(e) {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();
                    $('#confirmReopenBtn').click();
                }
            });

            // 阻止表单默认提交行为
            $('#reopenModal form').submit(function(e) {
                e.preventDefault();
                $('#confirmReopenBtn').click();
            });
        });

        // 重置重新开启表单
        function resetReopenForm() {
            $('#reopen_reason').val('');
            $('#reopen_error').remove(); // 移除可能存在的错误消息
            $('#confirmReopenBtn').prop('disabled', false);
        }

        // 处理重新开启缺陷
        async function handleReopenDefect() {
            try {
                // 获取重新开启原因
                const reason = $('#reopen_reason').val().trim();

                // 验证输入
                let hasError = false;

                // 移除旧的错误消息
                $('#reopen_error').remove();

                if (!reason) {
                    // 在文本域后面添加错误消息
                    const errorHtml = '<div id="reopen_error" class="error-message" style="color: red; margin-top: 5px;">请输入重新开启原因</div>';
                    $('#reopen_reason').after(errorHtml);
                    hasError = true;
                }

                if (hasError) {
                    return;
                }

                // 禁用按钮防止重复提交
                $('#confirmReopenBtn').prop('disabled', true);
                $('#confirmReopenBtn').text('处理中...');

                // 获取缺陷ID（根据实际情况调整）
                let defectId = {{ defect.id }};

                if (!defectId) {
                    console.error('Defect ID not found');
                    showToast('error', '无法获取缺陷信息');
                    resetReopenButton();
                    return;
                }

                // 调用重新开启API接口
                const response = await fetch(`/defect/${defectId}/reopen-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reason: reason,
                        verificationStatus: 'reopen'  // 明确指定操作类型
                    })
                });

                const result = await response.json();

                if (result.code === 0) {
                    // 成功
                    showToast('success', result.message || '缺陷已成功重新开启');

                    // 关闭模态框
                    $('#reopenModal').modal('hide');

                    // 延迟刷新页面，让用户看到成功提示
                    setTimeout(() => {
                        // 根据当前页面决定如何刷新
                        if (window.location.pathname.includes('/defect/')) {
                            location.reload();
                        } else {
                            location.reload();
                        }
                    }, 1500);
                } else {
                    // 失败
                    if (result.message.includes('状态')) {
                        // 添加状态错误消息
                        const errorHtml = '<div id="reopen_error" class="error-message" style="color: red; margin-top: 5px;">' + result.message + '</div>';
                        $('#reopen_reason').after(errorHtml);
                    } else if (result.message.includes('原因') || result.message.includes('必须')) {
                        // 添加原因错误消息
                        const errorHtml = '<div id="reopen_error" class="error-message" style="color: red; margin-top: 5px;">' + result.message + '</div>';
                        $('#reopen_reason').after(errorHtml);
                    } else if (result.message.includes('权限')) {
                        // 权限错误
                        showToast('error', result.message);
                    } else {
                        showToast('error', result.message || '操作失败');
                    }

                    resetReopenButton();

                    // 如果缺陷不存在，可能需要跳转
                    if (response.status === 404) {
                        setTimeout(() => {
                            window.location.href = '/defect/list';
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('操作失败:', error);
                const errorHtml = '<div id="reopen_error" class="error-message" style="color: red; margin-top: 5px;">网络错误，请稍后重试</div>';
                $('#reopen_reason').after(errorHtml);
                resetReopenButton();
                showToast('error', '操作失败，请检查网络连接');
            }
        }

        // 重置按钮状态
        function resetReopenButton() {
            $('#confirmReopenBtn').prop('disabled', false);
            $('#confirmReopenBtn').text('确定重新开启');
        }

        // 如果你需要在其他位置触发重新开启，可以调用这个函数
        function openReopenDefectModal(defectId) {
            // 设置缺陷ID（如果需要）
            // $('#reOpenDefectBtn').data('defect-id', defectId);

            // 打开模态框
            $('#reopenModal').modal('show');
        }
        </script>
