<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品缺陷管理 - 锋矢AI蓝军</title>
    {% include "defect/bases.html" %}
    <style>
        .button-add {
            opacity: 1;
            border-radius: 8px;
            padding: 5px 15px;
            background: linear-gradient(90deg, #9767FF 0%, #217EFD 50%);
            font-size: 14px;
            color: #fff;
            cursor: pointer;
            display: inline-block;
            line-height: 34px;
            height: 38px;
            font-weight: 600;
            width: 80px;
            margin-left: auto;
        }
        .search-group{
            margin-left: 0px;
        }
        /* 添加操作链接样式 */
        .action-link {
            color: blue;
            cursor: pointer;
            margin-right: 10px;
        }
        .action-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    {% include "components/header.html" %}
    <!-- 顶部横幅 -->
    {% include "components/defect_banner.html" %}

    <!-- 主要内容区域 -->
    <div class="container-fluid" style="max-width: 1280px; margin-top: 20px;">
        <!-- 面包屑导航 -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-custom">
                <li class="breadcrumb-item"><a href="/user/index">首页</a></li>
                <li class="breadcrumb-item">
                    {% if request.values.get('defect_type')=='simplified2' %}<a href="/defect/role_proxy?defect_type=simplified2">产品缺陷跟踪系统(DTS)-简化版</a> {% else %}<a href="/defect/role_proxy">产品缺陷跟踪系统(DTS)-标准版</a>{% endif %}
                </li>
                <li class="breadcrumb-item active">
                    异常处理
                </li>
            </ol>
        </nav>
    </div>

    <div class="container-main">
        <div class="role-selector">
            {% include "components/roles_menu.html" %}
            {% include "components/defect_message.html" %}
        </div>

        <!-- 操作栏 - 包含切换按钮和搜索区域 -->
        <div class="operation-bar" style="justify-content: space-between;">
            {{ get_right_style(0)|safe }}
            <!-- 切换按钮 -->
            {% include "components/user_menus.html" %}
        </div>

        <!-- 操作栏 - 包含切换按钮和搜索区域 -->
        <div class="operation-bar" style="margin-top: 10px;">
            <!-- 搜索区域 -->
            <div class="search-group">
                <div class="layui-input-inline">
                    <input type="text" style="width:250px" name="defectNo" placeholder="搜索缺陷单号/标题" value="{{ filters['search'] }}"
                        autocomplete="off" class="layui-input" id="searchInput">
                </div>

                {% include "components/layui_checkbox_tree.html" %}

                <div class="button" id="searchBtn" style="width: 102px;display: flex;justify-content: center;align-items: center;">
                    <i class="fa fa-search" aria-hidden="true"></i>
                    <span style="margin-left: 4px;">搜索</span>
                </div>
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="tab-content" style="margin-top: 25px;">
            <!-- 待处理缺陷 内容 -->
            <div class="tab-pane layui-show" id="processedContent">
                <!-- 缺陷列表表格 -->
                <div class="table-container">
                    {% if pagination.total>0 %}
                    <table class="layui-table" lay-size="sm" lay-filter="defectTable">
                        <thead>
                            <tr>
                                <th  style="width: 140px">
                                    缺陷单号
                                </th>
                                <th  style="width: 260px">
                                    <div class="sort-control">
                                        <span class="sort-label">所属产品</span>
                                        <span class="screening-icon dropdown-trigger" data-field="version_projects">
                                            <img src="/static/images/defect/imga1/sx.png">
                                        </span>
                                        <div class="sort-buttons">
                                            <div class="sort-btn up" data-field="version_projects" data-order="asc">
                                                <!-- <img src="/static/images/defect/imga1/up2.svg"> -->
                                            </div>
                                            <div class="sort-btn down" data-field="version_projects" data-order="desc">
                                                <!-- <img src="/static/images/defect/imga1/down2.svg"> -->
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th style="width: 260px">缺陷标题</th>
                                <th>
                                    <div class="sort-control">
                                        <span class="sort-label">流程状态</span>
                                        <span class="screening-icon dropdown-trigger" data-field="stage_types_name">
                                            <img src="/static/images/defect/imga1/sx.png">
                                        </span>
                                        <div class="sort-buttons">
                                            <div class="sort-btn up" data-field="stage_types_name" data-order="asc">
                                            </div>
                                            <div class="sort-btn down" data-field="stage_types_name" data-order="desc">
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th>处理人</th>
                                <th>
                                    <div class="sort-control">
                                        <span class="sort-label">处理人状态</span>
                                        <span class="screening-icon dropdown-trigger" data-field="severity">
                                            <img src="/static/images/defect/imga1/sx.png">
                                        </span>
                                        <div class="sort-buttons">
                                            <div class="sort-btn up" data-field="severity" data-order="asc">
                                            </div>
                                            <div class="sort-btn down" data-field="severity" data-order="desc">
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="defectTableBody">
                           {% for defect in defects %}
                             <tr>
                                <td>
                                    <a style="color: blue"  href="{{ url_for('defect.defect_detail', defect_id=defect.id) }}" target="_blank">{{ defect.defect_number }} </a>
                                </td>
                                <td title="{{ defect.product_or_version }}"  style="white-space: nowrap;overflow: hidden;text-overflow:ellipsis">
                                    {{ defect.product_or_version }}
                                </td>
                                <td title="{{ defect.title }}" style="white-space: nowrap;overflow: hidden;text-overflow:ellipsis;width: 260px">{{ defect.title }}</td>
                                <td>{{ defect.stage_name }}</td>
                                <td>{{ defect.current_stage.assignee.real_name }}</td>
                                <!-- 处理人状态 -->
                                <td>
                                    {% if defect.current_stage.assignee.status==1 %}
                                    <span class="status-tag status-active">已加入</span>
                                    {% else %}
                                    <span class="status-tag status-inactive">未加入</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if is_global_admin %}
                                        <!-- 修改链接 - 改为触发转处理模态框 -->
                                        <a class="btn option-button transfer-link" data-defect-id="{{ defect.id }}">修改</a>

                                        {% if defect.current_stage.assignee.status==0 %}
                                        <a class="btn option-button invite-link" data-defect-id="{{ defect.id }}">发送邀请</a>
                                        {% endif %}
                                    {% endif %}
                                </td>
                             </tr>
                           {% endfor %}
                        </tbody>
                    </table>

                    {% else %}
                    <div style="display: flex;align-items: center;justify-content: center;width: 100%;margin-top: 40px;" id="noData">
                        <img src="/static/images/aival/no_record.png">
                    </div>
                    {% endif %}
                </div>
                {% include "pages.html" %}
            </div>
        </div>
    </div>

<!-- 转处理模态框 -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
              <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                    <div class="flex items-center justify-center">
                        <img src="/static/images/defect/p2_03.png" alt="测试图标" class="test-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;">
                        <span style="margin-top: 2px;">修改处理人</span>
                    </div>
                </div>
            </div>
            <form id="transferForm" method="post">
                <input type="hidden" id="currentDefectId" value="">
                <div style="padding: 0 40px;margin-top: 24px;">
                    <!-- 人员搜索区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#666;margin-bottom: 12px;">
                            请选择处理人的 Email 账号，平台将会通知他
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="transferSearch" class="form-control" placeholder="搜索成员" style="width: 100%;height: 40px;border: 1px solid #D5E8FF;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                            <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                            <!-- 下拉框 -->
                            <div id="transferDropdown" class="member-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;">
                                <!-- 动态生成搜索结果 -->
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="transfer_to_user_id" id="transfer_to_user_id">
                    <!-- 姓名显示区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label-style">姓名</label>
                        <div id="selectedTransferName" style="width: 100%; height: 40px; border: 1px solid rgb(233, 239, 248); border-radius: 6px; padding: 12px; font-size: 14px; background-color: rgb(248, 249, 250); color: rgb(153, 153, 153); display: flex; align-items: center;">通过Email账号搜索成员，此处将会自动填充姓名</div>
                    </div>

                    <!-- 转处理原因 -->
                    <div class="form-group">
                        <label class="label-style">转处理原因</label>
                        <textarea id="transfer_reason" name="reason" class="text-area-border" placeholder="请输入"></textarea>
                    </div>
                </div>

                <div class="button-group-out">
                    <div class="drawer-buttons" style="width: 60%;height: 100px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="submit" class="ok-btn"  style="width: 120px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">提交</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- 底部区域 -->
    {% include "user/footer.html" %}

    <!-- JavaScript 引入 -->
    {% include "defect/base_js.html" %}

    <script>
        function showToast(message, type = 'info') {
            var icon = 0;
            switch(type) {
                case 'success': icon = 1; break;
                case 'error': icon = 2; break;
                case 'warning': icon = 0; break;
                case 'info': icon = 0; break;
            }

            layui.use('layer', function() {
                var layer = layui.layer;
                layer.msg(message, {icon: icon, time: 3000});
            });
        }

        var dropdownStates = {};

        // 初始化Layui模块
        layui.use(['element', 'form', 'layer','laypage','dropdown'], function() {
            var element = layui.element;
            var form = layui.form;
            var layer = layui.layer;
            var laypage = layui.laypage;
            var dropdown = layui.dropdown;

            // 全局变量
            var allDefects = []; // 存储所有缺陷数据
            var filteredDefects = []; // 存储筛选后的数据
            var activeTab = 'processed';
            var pageSize = 10;
            var currentPage = 1; // 添加当前页码变量
            var currentSort = {
                field: null,
                order: null
            };

            // 存储每个下拉菜单的状态

            // 关闭提醒信息
            $('#closeNote').on('click', function() {
                $('#roleNote').slideUp('fast');
            });

            // 树形结构筛选器数据
            // 定义图标路径
            var iconNormal = "/static/images/defect/imga1/sx.png";
            var iconActive = "/static/images/defect/imga1/sxActive.png";

            // 初始化所有下拉菜单
            function initAllDropdowns() {
                $('.dropdown-trigger').each(function() {
                    var field = $(this).data('field');
                    initDropdown($(this), field);
                });
            }

            let HttpChosenDropdownState = {{chosen_dropdown_states|safe}}

            // 初始化单个下拉菜单
            function initDropdown(elem, field) {
                var iconElement = elem.find('img');

                // 从localStorage加载之前保存的状态
                if(field in HttpChosenDropdownState){
                    dropdownStates[field] = HttpChosenDropdownState[field];
                } else {
                    // 默认状态：全部选中
                    // 获取选项数量
                    var options = getOptionsForField(field);

                    // 构建默认选中状态
                    var defaultItems = {};
                    if(field==='version_projects'){
                        console.log(options)
                        for (let key in options['project']) {
                            defaultItems['p3-'+key] = true;
                        }
                        for (let key in options['version']) {
                            defaultItems['v3-'+key] = true;
                        }
                        console.log(defaultItems);
                    }else{
                        for (var i = 0; i <= options.length; i++) {
                            defaultItems[options[i]] = true;
                        }
                    }
                    dropdownStates[field] = {
                        all: true,
                        items: defaultItems
                    };
                }
                // 判断当前筛选是否全选，如果是则使用iconNormal，如果不是则使用iconActive
                var currentState = dropdownStates[field];
                if (currentState && currentState.all) {
                    iconElement.attr('src', iconNormal);
                    elem.removeClass('active');
                } else {
                    iconElement.attr('src', iconActive);
                    elem.addClass('active');
                }
                // 渲染下拉菜单
                dropdown.render({
                    elem: elem[0],
                    align: 'center',
                    content: `<div class="tree-filter-buttons" style="flex-shrink: 0; padding: 10px; border-bottom: 1px solid #e6e6e6; text-align: right; background-color: #fafafa;height: 50px">
                                    <button type="button" class="layui-btn layui-btn-sm" style="margin-left: 10px;" data-field="${field}" >筛选刷新</button>
                              </div>`+buildDropdownContent(field),
                    className: 'demo-dropdown-tabs',
                    style: 'width: auto;max-height:300px;box-shadow: 1px 1px 30px rgba(0, 0, 0, 0.24); overflow-y: auto;',
                    ready: function() {
                        form.render('checkbox');
                        iconElement.attr('src', iconActive);
                        elem.addClass('active');

                        // 应用保存的状态
                        applyDropdownState(field);

                        // 绑定事件 - 简化版本
                        bindDropdownEventsSimplified(field);

                        $('.layui-btn').click(function() {
                            let currentState = dropdownStates[field];
                            let url_params = []
                            for(const key in currentState.items) {
                                if(currentState.items[key]){
                                     url_params.push(key)
                                }
                            }
                            location.href = "/defect/exception_handling_defect_list?" + field + "=" + url_params.join(',');

                        })
                    },
                    close: function() {
                        // 判断当前筛选是否全选，如果是则改变状态
                    }
                });
            }

            // 构建下拉菜单内容
            function buildDropdownContent(field) {
                var options = getOptionsForField(field);
                var content = [
                    '<div class="layui-form" style="padding: 10px;">',
                    '   <div class="layui-form-item" data-item="all">',
                    '       <input type="checkbox" name="all" id="all-checkbox-' + field + '" lay-filter="all-' + field + '" lay-skin="primary" title="全部">',
                    '   </div>'
                ];

                if(field === 'version_projects') {
                       Object.entries(options['version']).forEach(function([key, value]) {
                            content.push(
                                '   <div class="layui-form-item" data-item="v3-' + key + '">',
                                '       <input type="checkbox" name="item" value="v3-' + key + '" lay-filter="item-' + field + '" lay-skin="primary" title="' + value + '">',
                                '   </div>'
                            );
                    });
                    Object.entries(options['project']).forEach(function([key, value]) {
                        content.push(
                            '   <div class="layui-form-item" data-item="p3-' + key + '">',
                            '       <input type="checkbox" name="item" value="p3-' + key + '" lay-filter="item-' + field + '" lay-skin="primary" title="' + value + '">',
                            '   </div>'
                        );
                    });
                }
                else {
                    options.forEach(function (option, index) {
                        content.push(
                            '   <div class="layui-form-item" data-item="' + option+ '">',
                            '       <input type="checkbox" name="item" value="' + option + '" lay-filter="item-' + field + '" lay-skin="primary" title="' + option + '">',
                            '   </div>'
                        );
                    });
                }

                content.push('</div>');
                return content.join('');
            }

            // 根据字段获取选项
            function getOptionsForField(field) {
                // 这里需要根据实际情况返回相应字段的选项数组
                if (field === 'version_projects') {
                    return JSON.parse('{{ version_projects|safe }}'); // 动态选项
                } else if (field === 'stage_types_name') {
                    return JSON.parse('{{ stage_types_name|safe }}'); // 动态选项
                } else if (field === 'severity') {
                    return JSON.parse('{{ severity|safe }}'); // 动态选项
                } else if (field === 'reproducible') {
                    return JSON.parse('{{ reproducible|safe }}'); // 动态选项
                } else if (field === 'days') {
                    return ['今天', '昨天', '本周', '本月', '更早']; // 动态选项
                }
                // 默认返回空数组
                return [];
            }

            // 应用下拉菜单状态
            function applyDropdownState(field) {
                var state = dropdownStates[field];
                var options = getOptionsForField(field);

                // 设置"全部"复选框状态
                $('#all-checkbox-' + field).prop('checked', state.all);

                // 设置各个选项状态
                $.each(state.items, function(key, value) {
                    var $checkbox = $('input[name="item"][lay-filter="item-' + field + '"][value="' + key + '"]');
                    if ($checkbox.length) {
                        $checkbox.prop('checked', value);

                        // 获取父级layui-form-item元素
                        var $parentItem = $checkbox.closest('.layui-form-item');

                        // 根据选中状态添加或移除item-checked类
                        if (value) {
                            $parentItem.addClass('item-checked');
                        } else {
                            $parentItem.removeClass('item-checked');
                        }
                    }
                });

                // 处理"全部"选项的样式
                var $allCheckbox = $('#all-checkbox-' + field);
                var $allParentItem = $allCheckbox.closest('.layui-form-item');

                if (state.all) {
                    $allParentItem.addClass('item-checked');
                } else {
                    $allParentItem.removeClass('item-checked');
                }

                form.render('checkbox');
            }

            // 下拉菜单事件绑定
            function bindDropdownEventsSimplified(field) {
                // 全选复选框事件
                form.on('checkbox(all-' + field + ')', function(data){
                    var checkStatus = data.elem.checked;

                    // 更新所有子选项
                    $('input[name="item"][lay-filter="item-' + field + '"]').each(function(){
                        $(this).prop('checked', checkStatus);
                        // 更新父级样式
                        var $parentItem = $(this).closest('.layui-form-item');
                        if (checkStatus) {
                            $parentItem.addClass('item-checked');
                        } else {
                            $parentItem.removeClass('item-checked');
                        }
                    });

                    // 更新"全部"选项的样式
                    var $allParentItem = $('#all-checkbox-' + field).closest('.layui-form-item');
                    if (checkStatus) {
                        $allParentItem.addClass('item-checked');
                    } else {
                        $allParentItem.removeClass('item-checked');
                    }

                    form.render('checkbox');

                    // 更新状态
                    updateDropdownState(field);
                    saveDropdownState(field);
                });

                // 子选项复选框事件
                form.on('checkbox(item-' + field + ')', function(data){
                    // 更新当前选项的父级样式
                    var $parentItem = $(data.elem).closest('.layui-form-item');
                    if (data.elem.checked) {
                        $parentItem.addClass('item-checked');
                    } else {
                        $parentItem.removeClass('item-checked');
                    }

                    var allChecked = $('input[name="item"][lay-filter="item-' + field + '"]:checked').length ===
                                    $('input[name="item"][lay-filter="item-' + field + '"]').length;

                    $('#all-checkbox-' + field).prop('checked', allChecked);

                    // 更新"全部"选项的样式
                    var $allParentItem = $('#all-checkbox-' + field).closest('.layui-form-item');
                    if (allChecked) {
                        $allParentItem.addClass('item-checked');
                    } else {
                        $allParentItem.removeClass('item-checked');
                    }

                    form.render('checkbox');

                    // 更新状态
                    updateDropdownState(field);
                    saveDropdownState(field);
                });
            }

            // 更新下拉菜单状态
            function updateDropdownState(field) {
                var state = {
                    all: $('#all-checkbox-' + field).prop('checked'),
                    items: {}
                };

                // 获取所有选项
                $('input[name="item"][lay-filter="item-' + field + '"]').each(function() {
                    state.items[$(this).val()] = $(this).prop('checked');
                });

                dropdownStates[field] = state;
            }

            // 保存下拉菜单状态到localStorage
            function saveDropdownState(field) {
                localStorage.setItem('dropdown_state_' + field, JSON.stringify(dropdownStates[field]));
            }

            var levels = [{
                    name: '<span style="fonts-size:18px">•</span> 致命',
                    class: 'status-urgent'
                },
                {
                    name: '<span style="fonts-size:18px">•</span> 严重',
                    class: 'status-serious'
                },
                {
                    name: '<span style="fonts-size:18px">•</span> 一般',
                    class: 'status-normal'
                },
                {
                    name: '<span style="fonts-size:18px">•</span> 提示',
                    class: 'status-minor'
                }
            ];
            $(document).on('click', '.sort-btn', function() {
                var field = $(this).data('field');
                var order = $(this).data('order');

                location.href="./?deal_status={{filters['deal_status']}}&sort="+field+","+order

            });

            // 角色选择事件
            form.on('select(roleSelect)', function(data) {
                showToast('已选择角色：' + data.value, 'info');
            });


            // 初始化页面
            initAllDropdowns();

            // 添加表格行点击事件处理
            $('#defectTableBody').on('click', 'tr', function() {
                // 移除所有行的选中样式
                $('#defectTableBody tr').removeClass('selected');
                // 为当前点击的行添加选中样式
                $(this).addClass('selected');
            });

            // 搜索按钮点击事件
            $('#searchBtn').on('click', function() {
                var ids = checkedChildIds.join(',')
                var searchInput = $('#searchInput').val();
                location.href="/defect/exception_handling_defect_list?version_projects="+ids+"&search="+searchInput
            });
        });

        // 转处理功能相关脚本
        $(document).ready(function() {
            let selectedTransferMember = null;
            let currentDefectId = null;

            // 用户数据
            const userList = {{ company_user_list | tojson if company_user_list else '[]' }};

            // 点击"修改"链接打开模态框
            $(document).on('click', '.transfer-link', function() {
                currentDefectId = $(this).data('defect-id');
                $('#currentDefectId').val(currentDefectId);

                // 重置表单
                $('#transferSearch').val('');
                $('#transfer_to_user_id').val('');
                $('#selectedTransferName').html('通过Email账号搜索成员，此处将会自动填充姓名').css('color', '#999');
                $('#transfer_reason').val('');
                selectedTransferMember = null;

                // 显示模态框
                $('#transferModal').modal('show');
            });

            // 成员搜索功能
            $('#transferSearch').on('input', function() {
                var searchTerm = $(this).val().toLowerCase().trim();
                var $dropdown = $('#transferDropdown');

                if (searchTerm.length === 0) {
                    selectedTransferMember = null;
                    $('#selectedTransferName').html('通过Email账号搜索成员，此处将会自动填充姓名').css('color', '#999');
                    $dropdown.hide();
                    return;
                }

                // 搜索匹配的成员
                var matchedMembers = userList.filter(function(member) {
                    return member.email.toLowerCase().includes(searchTerm) ||
                           member.name.toLowerCase().includes(searchTerm);
                });

                if (matchedMembers.length > 0) {
                    // 生成下拉框内容
                    var dropdownHtml = '';
                    matchedMembers.forEach(function(member) {
                        dropdownHtml += `
                                <div class="member-dropdown-item"
                                     data-userid="${member.user_id}"
                                     data-email="${member.email}"
                                     data-name="${member.name}"
                                     data-department="${member.department}">
                                    ${member.name} / ${member.email}
                                </div>`;
                    });

                    $dropdown.html(dropdownHtml).show();
                } else {
                    selectedTransferMember = null;
                    $('#selectedTransferName').html('未找到匹配的成员').css('color', '#ff6b6b');
                    $dropdown.hide();
                }
            });

            // 下拉框选项点击事件
            $(document).on('click', '#transferDropdown .member-dropdown-item', function() {
                var $item = $(this);
                var email = $item.data('email');
                var name = $item.data('name');
                var userID = $item.data('userid');
                var department = $item.data('department');

                // 设置选中的成员
                selectedTransferMember = {
                    userID: userID,
                    email: email,
                    name: name,
                    department: department
                };

                // 填充输入框和姓名显示
                $('#transferSearch').val(email);
                $('#transfer_to_user_id').val(userID);
                $('#selectedTransferName').html(name + ' (' + department + ')').css('color', '#222');

                // 隐藏下拉框
                $('#transferDropdown').hide();
            });

            // 点击其他地方隐藏下拉框
            $(document).on('click', function(e) {
                if (!$(e.target).closest('#transferSearch, #transferDropdown').length) {
                    $('#transferDropdown').hide();
                }
            });

            // 表单提交事件 - 改为使用 fetch
            $('#transferForm').on('submit', function(e) {
                e.preventDefault();

                var defectId = $('#currentDefectId').val();
                var transferToUserId = $('#transfer_to_user_id').val();
                var reason = $('#transfer_reason').val().trim();

                // 验证输入
                if (!defectId) {
                    showToast('错误：未获取到缺陷ID', 'error');
                    return;
                }

                if (!transferToUserId) {
                    showToast('请先搜索并选择一个成员', 'warning');
                    return;
                }

                if (!reason) {
                    showToast('请输入转处理原因', 'warning');
                    return;
                }

                // 显示处理中提示
                showToast('正在转交处理...', 'info', 3000);

                // 使用 fetch 调用转处理接口
                fetch('/defect/' + defectId + '/transfer_to_other_api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transfer_to_user_id: transferToUserId,
                        reason: reason
                    })
                })
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showToast('缺陷转处理成功', 'success');
                        $('#transferModal').modal('hide');
                        // 可选：刷新页面或更新表格数据
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                    } else {
                        layer.alert('转处理失败: ' + data.message, {
                            title: '错误',
                            icon: 2
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('转处理失败：网络错误或服务器异常', 'error');
                });
            });

            // 模态框关闭时重置表单
            $('#transferModal').on('hidden.bs.modal', function () {
                $('#transferSearch').val('');
                $('#transfer_to_user_id').val('');
                $('#selectedTransferName').html('通过Email账号搜索成员，此处将会自动填充姓名').css('color', '#999');
                $('#transfer_reason').val('');
                selectedTransferMember = null;
                currentDefectId = null;
            });
        });
    </script>
</body>
</html>