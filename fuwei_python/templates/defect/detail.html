<!-- templates/defect/detail.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品缺陷管理 - 锋矢AI蓝军</title>
    {% include "defect/bases.html" %}
    <link href="/static/lib/wang-editor/style.css" rel="stylesheet" type="text/css">
    <link href="/static/css/ai-val.css" rel="stylesheet" type="text/css">
</head>
<body>
{% include "components/header.html" %}

    <!-- 顶部横幅 -->
    {% include "components/defect_banner.html" %}

    <div class="container-fluid" style="max-width: 1280px; margin-top: 20px;">
        <!-- 面包屑导航 -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-custom">
                <li class="breadcrumb-item"><a href="/user/index">首页</a></li>
                <li class="breadcrumb-item">
                    <a href="/defect/role_proxy">产品缺陷跟踪系统(DTS)-标准版</a>
                </li>
                <li class="breadcrumb-item active">
                    缺陷详情
                </li>
            </ol>
        </nav>
    </div>
    <!-- 主要内容区域 -->
    <div class="container-main">
    <!-- 显示Flash消息 -->
    {% include "defect/show_flash.html" %}
    <!-- 缺陷基本信息 -->
    <div class="defect-info-section">
        <div class="section-header">
                <div class="section-title">
                    <img src="/static/images/fengchi_tag.svg" alt="">
                    缺陷基本信息
                </div>
            </div>
        <div class="defect-info-grid">
                <div class="info-row">
                    <div class="info-item">
                        <label class="info-label">缺陷所属产品线/技术族</label>
                        <div class="info-value" id="productPlatform">{{project_version_name}}</div>
                    </div>
                    <div class="info-item">
                        <label class="info-label">缺陷影响程度</label>
                        <div class="info-value">
                            <span class="status-tag {{ defect.severity | status_class }}">• {{defect.severity}}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <label class="info-label">缺陷是否可重现</label>
                        <div class="info-value" id="reproducible">{{ defect.defect_reproducibility }}</div>
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-item">
                        <label class="info-label">当前处理人</label>
                        <div class="info-value" id="currentHandler">{{ current_stage.assignee.real_name if current_stage.assignee else '未分配' }}/{{ current_stage.assignee.email if current_stage.assignee.email else '无Email' }}</div>
                    </div>
                    <div class="info-item">
                        <label class="info-label">流程阶段</label>
                        <div class="info-value" id="processStatus">{{ current_stage_name }}</div>
                    </div>
                    <div class="info-item">
                        <label class="info-label">缺陷单号</label>
                        <div class="info-value">
                            <span id="defectNumber">{{ defect.defect_number }}</span>
                            <div class="history-link">
                                <img src="/static/images/defect/p2_01.png" alt="历史记录" style="width: 14px; height: 14px; margin-left: 4px;">
                                <span>历史记录</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-item">
                        <label class="info-label">创建人</label>
                        <div class="info-value">{{ defect.creator.real_name if defect.creator else '未知' }}/{{ defect.creator.email if defect.creator else '无Email' }}</div>
                    </div>
                    <div class="info-item">
                        <label class="info-label">创建时间</label>
                        <div class="info-value">{{ defect.created_time.strftime('%Y-%m-%d %H:%M') }}</div>
                    </div>
                    <div class="info-item">
                        <label class="info-label">更新时间</label>
                        <div class="info-value">{{ defect.updated_time.strftime('%Y-%m-%d %H:%M') }}</div>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-item">
                        <label class="info-label">缺陷标题</label>
                        <div class="info-value">{{ defect.title }}</div>
                    </div>
                </div>
            </div>
        {% if source_defect %}
        <div class="test-source">
                <span class="source-label">本测试单来自于</span>
                <br>
                <div class="flex items-center">
                    <span class="source-info">【{{ source_defect.type }}：{{ source_defect.project_version_name }}】的缺陷单 <a class="defect-link" href="/defect/{{source_defect.id}}">{{ source_defect.defect_number }}</a> </span>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- 缺陷评估 -->
    {% if defect_description_list|length > 0 %}
    <div class="defect-evaluation-section">
        <div class="section-header">
            <div class="section-title">
                <img src="/static/images/fengchi_tag.svg" alt="">
                缺陷评估
            </div>
        </div>

        <div class="evaluation-table-container">
            <table class="ai-val-detail-tb-content">
            <thead>
            <tr>
                <th style="width: 10%;">评估项</th>
                <th style="width: 40%;">
                    <div class="flex justify-content-between">
                        <span>内容</span>
                    </div>
                </th>
                <th style="width: 40%;">AI 建议 <img src="/static/images/aival/start.svg" alt="AI" class="ai-icon" style="width: 14px; height: 14px; margin-left: 4px;"></th>
                <th style="width: 10%;">评分 (满分10分)</th>
            </tr>
            </thead>
            <tbody class="ai-val-tr">
            <tr>
                <td id="content_type1">产品缺陷描述</td>
                <td id="defect_description">
                    {% for item in defect_description_list %}
                    <div class="description-item">
                         {% if item.description!='' and  item.description!=none %}
                        <div class="title-description">
                              <b>{{ item.title }}</b>:{{ item.description | safe }}
                        </div>
                        {% endif %}
                        <br>
                    </div>
                    {% endfor %}
                </td>

                <td id="AI_advice_for_description">
                        {% if current_stage.stage_type == "defect_description" and  current_stage.status=="StageStatus.EVALUATING" %}
                            评估中
                        {% else %}
                            {% if description_data|length > 0 %}
                                {{ description_data[0].ai_suggestion|default('未评估', true)|safe }}
                            {% endif %}
                        {% endif %}
                 </td>
                <td id="description_score" class="score {% if description_data and description_data[0] and description_data[0].ai_score is not none %}{% if description_data[0].ai_score >= 8 %}score-green{% elif description_data[0].ai_score >= 6 %}score-blue{% else %}score-red{% endif %}{% else %}score-red{% endif %}">
                    {% if description_data and description_data[0] and description_data[0].ai_score is not none %}
                    {{ description_data[0].ai_score}}
                    {% endif %}
                </td>
            </tr>

            {% if analysis_data_list|length > 0 %}
            <tr>
                <td id="content_type2">原因分析</td>
                <td id="cause_analysis">
                    {% for item in analysis_data_list %}
                    <div class="analysis-item-tb">
                        <div class="title-description"><b>{{ item.title| safe }}</b>: {{ item.description | safe }}</div>
                        <br>
                    </div>
                    {% endfor %}
                </td>
                <td id="AI_advice_for_analysis" >
                        {% if current_stage.stage_type == "cause_analysis" and  current_stage.status=="StageStatus.EVALUATING" %}
                            评估中
                        {% elif current_stage.stage_type == "cause_analysis" and current_stage.status!="StageStatus.COMPLETED" %}
                            未评估
                       {% else %}
                           {% if cause_analysis_ai and cause_analysis_ai.ai_suggestion != None %}
                                {{ cause_analysis_ai.ai_suggestion|safe }}
                           {% endif %}
                       {% endif %}
                </td>
                <td id="analysis_score" class="score {% if cause_analysis_ai and cause_analysis_ai.ai_score is not none %}{% if cause_analysis_ai.ai_score >= 8 %}score-green{% elif cause_analysis_ai.ai_score >= 6 %}score-blue{% else %}score-red{% endif %}{% else %}score-red{% endif %}">
                      {% if current_stage.stage_type == "cause_analysis" and  current_stage.status=="StageStatus.EVALUATING" %}

                        {% elif current_stage.stage_type == "cause_analysis" and current_stage.status!="StageStatus.COMPLETED" %}

                       {% else %}
                           {% if cause_analysis_ai and cause_analysis_ai.ai_score != None %}
                                {{ cause_analysis_ai.ai_score  }}
                           {% endif %}
                       {% endif %}
                </td>
            </tr>
            {% endif %}

            {% if solution_data_list|length > 0 %}
            <tr>
                <td id="content_type3">解决措施</td>
                <td id="solution_content">
                    {% for item in solution_data %}
                        {% if  item['content']['solutions'] |length > 0  %}
                            <div class="solution-item">
                                <div class="title-description">
                                <b>修改模块:</b>{{item['module']}}
                                <br>
                                <b>执行措施:</b>{{item['action_plan']}}
                                <br>
                                <b>解决措施：</b><br>
                                    {% for su in item['content']['solutions']%}
                                         {{ su.title|safe }}: {{ su.description|safe }}<br>
                                    {% endfor %}
                                </div>
                            </div>
                            <br>
                        {% endif %}
                    {% endfor %}

                </td>
                <td id="AI_advice_for_solution">
                       {% if current_stage.stage_type == "developer_solution" and  current_stage.status=="StageStatus.EVALUATING" %}
                            评估中
                       {% elif current_stage.stage_type == "developer_solution" and current_stage.status!="StageStatus.COMPLETED" and not solution_ai  %}
                            未评估
                       {% else %}
                            {% if solution_ai and solution_ai != None  %}
                                {{ solution_ai.ai_suggestion|safe }}
                            {% endif %}
                       {% endif %}
                </td>
                <td id="solution_score" class="score {% if solution_ai and solution_ai.ai_score is not none %}{% if solution_ai.ai_score >= 8 %}score-green{% elif solution_ai.ai_score >= 6 %}score-blue{% else %}score-red{% endif %}{% else %}score-red{% endif %}">
                       {% if current_stage.stage_type == "developer_solution" and  current_stage.status=="StageStatus.EVALUATING" %}

                       {% elif current_stage.stage_type == "developer_solution" and current_stage.status!="StageStatus.COMPLETED" and not solution_ai %}

                       {% else %}
                            {% if solution_ai and solution_ai != None  %}
                                {{ solution_ai.ai_score }}
                            {% endif %}
                       {% endif %}
                </td>
            </tr>
            {% endif %}
            {% if test_result_data|length > 0 and test_result_data[0].stage_status=='StageStatus.COMPLETED' %}
            <tr>
                <td id="content_type4">回归测试</td>
                <td id="result_content">
                    {% for item in test_result_data_list %}
                    <div class="result-item">
                        <div class="title-description"><b>{{ item.title }}:</b> {{ item.description | safe }}</div>
                        <br>
                    </div>
                    {% endfor %}
                </td>
                <td id="AI_advice_for_test_result">
                        {% if current_stage.stage_type == "tester_regression" and  current_stage.status=="StageStatus.EVALUATING" %}
                            评估中
                        {% else %}
                            {% if test_result_data|length > 0 and test_result_data[0] %}
                                {{ test_result_data[0].ai_suggestion|safe }}
                            {% else %}
                                未评估
                            {% endif %}
                        {% endif %}
                 </td>
                <td id="test_result_score" class="score {% if test_result_data and test_result_data[0] and test_result_data[0].ai_score is not none %}{% if test_result_data[0].ai_score >= 8 %}score-green{% elif test_result_data[0].ai_score >= 6 %}score-blue{% else %}score-red{% endif %}{% else %}score-red{% endif %}">
                   {% if test_result_data and test_result_data[0] and test_result_data[0].ai_score is not none %}
                   {{ test_result_data[0].ai_score }}
                   {% endif %}
                </td>
            </tr>
            {% endif %}

            </tbody>
            <!-- 张三测试经理核实页面 -->
            <tfoot>
                {% if defect_flow_histories|length > 1 %}
                <tr>
                    <td colspan="4" style="background: #e5f0fd;color: #557496;">
                        <div class="flex items-start">
                            <div class="reviewer-info">
                                <img src="/static/images/defect/p1_04.png" alt="" class="reviewer-avatar">
                                <span class="reviewer-name">{{defect_flow_histories[-2].action_time.replace("T", " ")}} 【{{ defect_flow_histories[-2].action_by_real_name }} ({{ defect_flow_histories[-2].action_by_email }})】 </span>
                            </div>
                            <div class="review-comment">{{ defect_flow_histories[-2].notes | safe}}</div>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% if defect_flow_histories|length > 0 %}
                <tr>
                    <td colspan="4" style="background: #e5f0fd;color: #557496;">
                        <div class="flex items-start">
                            <div class="reviewer-info">
                                <img src="/static/images/defect/p1_04.png" alt="" class="reviewer-avatar">
                                <span class="reviewer-name">{{defect_flow_histories[-1].action_time.replace("T", " ")}} 【{{ defect_flow_histories[-1].action_by_real_name }} ({{ defect_flow_histories[-1].action_by_email }})】 </span>
                            </div>
                            <div class="review-comment">{{ defect_flow_histories[-1].notes|safe }}</div>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tfoot>
        </table>
        </div>
    </div>
    {% endif %}

    {% if is_assignee and defect.status != 'DefectStatus.CLOSED' and defect.status !='DefectStatus.TERMINATE_TRACKING'%}
    <div class="section-header">
        <div class="section-title">
            <img src="/static/images/fengchi_tag.svg" alt="">
            您可以
        </div>
    </div>
    {% endif %}

    <!--3、test_manager_review_desc 测试经理审核描述阶段的按钮 -->
    {% if is_assignee and current_stage and current_stage.stage_type == 'test_manager_review_desc' and defect.status != 'DefectStatus.TERMINATE_TRACKING'%}
    <div class="button-group-out">
        <div class="drawer-buttons button-group-line" >
            <button class="btn-batch mr-3" data-bs-toggle="modal" data-bs-target="#terminateModal">终止跟踪</button>
            <button class="btn-batch mr-3" data-bs-toggle="modal" data-bs-target="#rejectModal">驳回</button>
            <button class="ok-btn btn-batch mr-3" id="assignTestBtn" data-bs-toggle="modal" data-bs-target="#assignTesterModal">重新指定测试人员</button>
            <button class="ok-btn" id="submitDevBtn" style="width: 144px;" data-bs-toggle="modal" data-bs-target="#inviteDeveloperModal">提交开发定位</button>
        </div>
    </div>

    {% endif %}


<!-- 4、开发人员定位 阶段 支持一个或多个邀请人 and current_stage.status != 'StageStatus.PENDING_UPDATE'  Start    -->
{% if current_stage and (current_stage.stage_type == 'cause_analysis' or current_stage.stage_type == 'dev_lead_review_analysis') %}
    <!-- cause_analysis 开发人员定位问题阶段的按钮 -->
    {% if is_assignee and cause_analysis_invitations | length == 1  or (is_assignee and cause_analysis_invitations | length > 1 and is_same_invitee)%}   <!-- 只有一个邀请人 或 同一人被指定多次-->
    {% if current_stage.stage_type != 'dev_lead_review_analysis' %}
    <div class="form-item">
        <div class="button-group" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="button" class="btn-batch" data-action="驳回" data-bs-toggle="modal" data-bs-target="#rejectModal">
                驳回
            </button>
            <button type="button" class="btn-batch" data-action="转处理" data-bs-toggle="modal" data-bs-target="#transferModal">
                转处理
            </button>
            <button type="button" class="btn-batch" data-action="邀共同定位" data-bs-toggle="modal" data-bs-target="#inviteDevelopersLocateModal">
                邀共同定位
            </button>
            <!-- 使用模仿checkcard样式的按钮 -->
            <button type="button" class="action-btn-checkcard active" data-action="自行处理">
                自行处理
            </button>
        </div>
    </div>

    <div class="card mb-4 top-margin">
        <div class="card-header">
            <h5 class="card-title">原因分析</h5>
        </div>

        {% if cause_analysis_invitations[0].invitee_id == current_user.user_id %}  <!-- 当前被邀请人是自己，才能够邀请其他人共同定位 -->
        <div class="card-body">
            <form id="analysisForm" method="post" action="{{ url_for('defect.submit_analysis', defect_id=defect.id) }}">
                <!-- 添加隐藏字段用于暂存标识 -->
                <input type="hidden" name="is_draft" id="isOnlySave" value="false">
                <!-- 隐藏字段用于存储组合后的内容 -->
                <textarea class="form-control d-none" id="analysisContent" name="analyses" rows="6"></textarea>

                <!-- 存储从服务端获取的数据 -->
                {% set current_invitation = cause_analysis_invitations[0] %}
                {% set analysis_data = cause_analysis_data | selectattr('invitee_id', 'equalto', current_invitation.invitee_id) | first %}
                {% if analysis_data and analysis_data.content and analysis_data.content.analyses %}
                <input type="hidden" id="serverAnalysisData" value='{{ analysis_data.content.analyses | tojson | safe }}'>
                {% endif %}

                <div id="analysisItems">
                    <!-- 加载提示 -->
                    <div class="analysis-item mb-3">
                        <div class="card editor-field">
                            <div class="card-body text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2">正在加载数据...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 添加原因分析按钮 -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div id="addAnalysis" class="add-solution flex items-center justify-center" data-bs-toggle="modal" data-bs-target="#analysisAddFieldModal">
                        <div class="addicon">
                            <img src="/static/images/defect/news_add.png">
                        </div>
                        <div class="add-text">添加原因分析</div>
                    </div>
                    <span class="text-muted solution-counter" id="analysisCounter">0/10</span>
                </div>

                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line" >
                        <button type="button" class="btn-batch mr-3" id="saveDraftBtn_in_cause_analysis">暂存</button>
                        <button type="button" class="ok-btn btn-batch mr-3" id="aiReviewBtn_in_cause_analysis" style="width: 180px;" >AI自评 <img src="/static/images/start-pic.svg" alt="刷新"> </button>
                        <button type="button" class="ok-btn" id="submitAnalysisBtn" style="width: 144px;" data-bs-toggle="modal">提交审核</button>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% elif cause_analysis_invitations | length > 1 %}  <!-- 多个邀请人 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title">{% if current_stage.stage_type == 'dev_lead_review_analysis' %} 审核 {% endif %}原因分析（多个被邀请人）</h5>
        </div>
        <div class="card-body">
            <!-- 多个被邀请人的原因分析表单 -->
            <form id="multiAnalysisForm" method="post" action="{{ url_for('defect.submit_analysis', defect_id=defect.id) }}">
                <!-- 添加隐藏字段用于暂存标识 -->
                <input type="hidden" name="is_draft" id="isOnlySaveMulti" value="false">
                <!-- 隐藏字段用于存储组合后的内容 -->
                <textarea class="form-control d-none" id="multiAnalysisContent" name="analyses" rows="6"></textarea>

                {% for invitation in cause_analysis_invitations %}
                    {% set user = user_list | selectattr("user_id", "equalto", invitation.invitee_id) | first %}
                    {# 查找与当前邀请相关的已提交数据 #}
                    {% set analysis_data = cause_analysis_data | selectattr('invitee_id', 'equalto', invitation.invitee_id) | first %}

                <div class="invitation-item-container">
                    {% if is_assignee and current_stage.stage_type == 'dev_lead_review_analysis' %}
                    <div class="invitation-checkbox">
                        <input type="checkbox" class="form-check-input check-box-border" id="{{ invitation.id }}">
                    </div>
                    {% endif %}
                    <div class="invitation-analysis-item mb-4 p-3 border rounded"
                         data-invitation-id="{{ invitation.id }}"
                         data-invitee-id="{{ invitation.invitee_id }}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">
                                {{ user.name if user else '未知用户' }} ({{ user.email if user else '无邮箱' }})
                            </h6>
                            {% if invitation.invitee_id == current_user.user_id %}
                                <span class="badge bg-info">自己</span>
                            {% endif %}
                            {% if analysis_data and invitation.status=='InvitationStatus.COMPLETED'%}
                                <span class="badge bg-success">已提交</span>
                            {% elif analysis_data and invitation.status=='InvitationStatus.REJECTED'%}
                                <span class="badge bg-warning">被驳回</span>
                            {% endif %}
                            {% if analysis_data and invitation.status == 'InvitationStatus.CANCELLED'%}
                                <span class="badge bg-warning">已弃用</span>
                            {% endif %}
                        </div>

                        <div class="analysis-content mb-3">
                            <label class="form-label">原因分析</label>

                            <!--无原因分析数据 或者 被驳回，都需要显示此按钮，无需对自己跟催-->
                            {% if is_assignee and (not analysis_data or analysis_data.status == 'InvitationStatus.REJECTED') and current_user.user_id!=invitation.invitee_id%}
                            <button type="button" class="small-button btn-outline-secondary mr-3" data-bs-toggle="modal" data-bs-target="#remindSingleAnalysisModal" data-invitation-id="{{ invitation.id }}">
                                跟催
                            </button>

                            {% endif %}

                            {% if is_assignee and invitation.invitee_id != current_user.user_id  and (analysis_data and invitation.status=='InvitationStatus.COMPLETED') and (current_stage.stage_type != 'dev_lead_review_analysis')%}
                            <!--驳回单个的原因分析-->
                            <button type="button" class="btn btn-batch small-button" data-bs-toggle="modal" data-bs-target="#rejectSingleAnalysisModal" data-invitation-id="{{ invitation.id }}">
                                驳回
                            </button>
                            <button type="button" class="btn btn-batch small-button" data-bs-toggle="modal" data-bs-target="#cancelSingleAnalysisModal" data-invitation-id="{{ invitation.id }}">
                                弃用
                            </button>
                            {% endif %}

                            {# 简化条件逻辑并提高可读性 #}
                            {% set is_readonly = false %}
                            {# 当前用户不是被邀请人 #}
                            {% if invitation.invitee_id != current_user.user_id %}
                                {% set is_readonly = true %}
                            {% endif %}
                            {# 有分析数据，但是分析已经完成 #}
                            {% if analysis_data and invitation.status == 'InvitationStatus.COMPLETED'%}
                                {% set is_readonly = true %}
                            {% endif %}

                            <div class="editor-field">
                                {% if is_readonly %}
                                    <!-- 只读模式 -->
                                    <div class="view-mode-content">
                                        {% if analysis_data and analysis_data.content and analysis_data.content.analyses%}
                                            {% for analysis in analysis_data.content.analyses %}
                                                {% if analysis and analysis.title and analysis.description %}
                                                    {% if not analysis.description.strip() == '<p>&nbsp;</p>' and not analysis.description.strip() == '<p><br></p>' and not analysis.description.strip() == '<p></p>' %}
                                                        <div class="analysis-item-readonly mb-3">
                                                            <h6 class="text-primary">{{ analysis.title }}</h6>
                                                            <div class="analysis-content-readonly">
                                                                {{ analysis.description | safe }}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% elif analysis and analysis.description %}
                                                    {# 兼容旧格式：只有description字段的情况 #}
                                                    {% if not analysis.description.strip() == '<p>&nbsp;</p>' and not analysis.description.strip() == '<p><br></p>' and not analysis.description.strip() == '<p></p>' %}
                                                        <div class="analysis-item-readonly mb-3">
                                                            <div class="analysis-content-readonly">
                                                                {{ analysis.description | safe }}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <div class="text-muted">暂无内容</div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <!-- 编辑模式 -->
                                    <div class="analysis-items-container" data-invitation-id="{{ invitation.id }}">
                                        <!-- 加载提示 -->
                                        <div class="analysis-item mb-3">
                                            <div class="card editor-field">
                                                <div class="card-body text-center">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">加载中...</span>
                                                    </div>
                                                    <p class="mt-2">正在加载数据...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 存储服务端分析数据 -->
                                    {% if analysis_data and analysis_data.content and analysis_data.content.analyses %}
                                    <input type="hidden" class="server-analysis-data"
                                           data-invitation-id="{{ invitation.id }}"
                                           value='{{ analysis_data.content.analyses | tojson | safe }}'>
                                    {% endif %}

                                    <!-- 添加原因分析按钮（仅对当前用户可见） -->
                                    {% if invitation.invitee_id == current_user.user_id %}
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div class="add-analysis-multi add-solution flex items-center justify-center" data-invitation-id="{{ invitation.id }}" data-bs-toggle="modal" data-bs-target="#analysisAddFieldModal">
                                            <div class="addicon">
                                                <img src="/static/images/defect/news_add.png">
                                            </div>
                                            <div class="add-text">添加原因分析</div>
                                        </div>
                                        <span class="text-muted solution-counter analysis-counter-multi" data-invitation-id="{{ invitation.id }}">0/10</span>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>

                        <div class="analysis-actions">
                            {% if not is_assignee and current_user.user_id != cause_analysis_invitations[0].invitee_id and not analysis_data and invitation.invitee_id == current_user.user_id%}  <!-- 非主处理人且分析未提交（无分析数据）才能驳回邀请 -->
                            <button type="button" class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#rejectInviteModal" data-invitation-id="{{ invitation.id }}">
                                驳回邀请
                            </button>
                            {% endif %}
                            {% if invitation.invitee_id == current_user.user_id %}
                                {% if not analysis_data or invitation.status=='InvitationStatus.REJECTED' or invitation.status=='InvitationStatus.PENDING'%}
                                <div class="button-group-out">
                                    <div class="drawer-buttons button-group-line" >
                                        <button type="button" class="btn-batch mr-3 save-draft-multi" data-invitation-id="{{ invitation.id }}">暂存</button>
                                        <button type="button" class="ok-btn btn-outline-dark me-2 ai-review-multi" data-invitation-id="{{ invitation.id }}" style="width: 180px;" >AI自评 <img src="/static/images/start-pic.svg" alt="刷新"> </button>
                                        <button type="button" class="ok-btn submit-analysis" style="width: 180px;" data-invitation-id="{{ invitation.id }}" data-bs-toggle="modal">提交分析结果</button>
                                    </div>
                                </div>
                                {% endif %}
                            {% endif %}

                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- 隐藏字段用于存储当前提交的邀请ID -->
                <input type="hidden" name="invitation_id" id="currentInvitationId">
            </form>
        </div>
    </div>
    {% endif %}
{% endif %}
<!-- 开发人员定位 阶段 支持一个或多个邀请人 End-->

<!-- 添加原因分析字段的模态框 -->
<div class="modal fade" id="analysisAddFieldModal" tabindex="-1" aria-labelledby="analysisAddFieldModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="analysisAddFieldModalLabel">添加原因分析字段</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="analysisNewFieldTitle" class="form-label">字段标题</label>
                    <input type="text" class="form-control" id="analysisNewFieldTitle" placeholder="请输入字段标题">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="analysisConfirmAddField">确认添加</button>
            </div>
        </div>
    </div>
</div>

    <!-- 5、dev_lead_review_analysis 开发主管审核原因分析 阶段 - 同意并制定解决计划 -->
    {% if is_assignee and current_stage and current_stage.stage_type == 'dev_lead_review_analysis' %}
    <!-- 操作按钮组 -->
    <div class="form-item">
        <div class="button-group" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px">
            <button id="rejectAnalysisButton" class="btn-batch" data-action="驳回原因分析" data-bs-toggle="modal" >驳回</button>
            <button class="action-btn-checkcard" id="showDivisionForm" data-action="同意并制定解决计划">同意并制定解决计划</button>
        </div>
    </div>

    <!-- 解决措施分工表单 (默认隐藏) -->
    <div class="defect-info-section" id="divisionForm" style="display: none;">
        <div class="section-header">
            <div class="section-title">
                <img src="/static/images/fengchi_tag.svg" alt="">
                设置解决措施及分工
            </div>
        </div>

        <div class="defect-info-grid">
            <!-- 设置解决措施及分工1 -->
            <form method="post" action="{{ url_for('defect.assign_for_solution', defect_id=defect.id) }}" class="form-section solution-item" id="divisionSubmitForm">
                <div id="divisionContainer">
                    <div class="division-card" data-index="1">
                        <div class="flex items-center justify-between" style="padding: 20px;">
                            <h6 class="section-title color1">
                                解决措施分工 1
                            </h6>
                            <button type="button" class="remove-tag remove-division" style="display: none;">移除</button>
                        </div>
                        <div class="division-item">
                            <div class="edit-container-body">
                            <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                                <div class="form-group" style="flex: 1; margin-right: 20px;">
                                    <label class="label-style"><span style="color: red;">*</span> 修改模块 </label>
                                    <div class="layui-form">
                                        <input name="division-1-module" required class="input-class">
                                    </div>
                                </div>

                                <div class="form-group" style="width: 25%;margin-right: 20px;">
                                    <label class="label-style"><span style="color: red;">*</span> 完成时间</label>
                                    <div style="position: relative;">
                                        <input name="division-1-due_date" required type="date" class="solution-datetime" id="ID-laydate-type-datetime-1" placeholder="请选择" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;" lay-key="1" lay-laydate-id="ID-laydate-type-datetime-1">
                                    </div>
                                </div>
                                <div class="form-group" style="width: 25%;margin-right: 20px;">
                                    <label class="label-style"><span style="color: red;">*</span> 请选择处理人的 Email 账号</label>
                                    <div style="position: relative;">
                                        <input type="text" class="form-control solution-assignee-search" placeholder="搜索邮箱地址或姓名" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                                        <img src="/static/images/defect/ss.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                                        <div class="autocomplete-menu assignee-autocomplete" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;"></div>
                                    </div>
                                </div>
                                <div class="form-group" style="width: 25%;">
                                    <label class="label-style"><span style="color: red;">*</span> 处理人的姓名</label>
                                    <div style="position: relative;">
                                        <input name="division-1-name" type="text" class="form-control solution-assignee-name" placeholder="自动填充" readonly style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;color: #999;">
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" class="division-assignee-id" name="division-1-assignee">
                            <input type="hidden" class="division-assignee-email" name="division-1-email">
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label class="label-style"><span style="color: red;">*</span> 执行措施</label>
                                <textarea name="division-1-action_plan" required class="solution-measure text-area-border" placeholder="请输入"></textarea>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
                 <!-- 添加补充区域 -->
                <div class="add-section flex items-center justify-center" id="addDivision">
                    <!-- <div class="add-icon layui-icon layui-icon-add-circle"></div> -->
                    <div class="addicon">
                        <img src="/static/images/defect/news_add.png">
                    </div>
                    <div class="add-text">添加解决措施及分工</div>
                </div>
                <div>
                    <div class="defect-info-grid" style="color: #557496;margin-bottom: 10px;">
                        <span style="color: red;">*</span> 如果为共性问题，需要向其他产品或项目同步复制此缺陷单
                    </div>
                    <!-- 操作按钮组 -->
                    <div class="layui-form flex">
                        <div id="notCommonIssueRadio">
                            <input type="radio" name="radio1" value="非共性问题" lay-skin="none" checked="" lay-filter="form-demo-skin"><div class="layui-unselect layui-form-radio layui-form-radioed" lay-skin="none"><i class="layui-anim layui-icon layui-icon-radio"></i><div class="lay-skin-checkcard lay-check-dot-2" style="height: 40px">
                                <div class="lay-skin-checkcard-detail">
                                    <div class="lay-skin-checkcard-header">非共性问题</div>
                                </div>
                            </div></div>
                            <div lay-radio="" class="lay-skin-checkcard lay-check-dot-2" style="height: 40px">
                                <div class="lay-skin-checkcard-detail">
                                    <div class="lay-skin-checkcard-header">非共性问题</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-left: 10px;" id="commonIssueRadio">
                            <input type="radio" name="radio1" value="是共性问题" lay-skin="none" lay-filter="form-demo-skin" ><div class="layui-unselect layui-form-radio" lay-skin="none"><i class="layui-anim layui-icon layui-icon-circle"></i><div class="lay-skin-checkcard lay-check-dot-2" style="height: 40px">
                                <div class="lay-skin-checkcard-detail">
                                    <div class="lay-skin-checkcard-header">是共性问题</div>
                                </div>
                            </div></div>
                            <div lay-radio="" class="lay-skin-checkcard lay-check-dot-2" style="height: 40px">
                                <div class="lay-skin-checkcard-detail">
                                    <div class="lay-skin-checkcard-header">是共性问题</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="copyDefectInfoSection" class="copy-defect-info-section" style="display:none">
                    <div class="info-value">
                        <span id="duplicate_defects_infos_length">本缺陷单已被复制至以下项目（{{ duplicate_defects_infos|length }}）：</span>
                         <div id='toCopyDefect' class="addxm flex items-center" data-action="复制缺陷单">
                            <span>复制缺陷单</span>
                            <img src="/static/images/defect/right.svg" style="width: 12px; height: 12px; margin-left: 4px;">
                        </div>
                    </div>

                    <div id="duplicateDefectsContainer" class="defect-list">
                        {% if duplicate_defects_infos %}
                            {% for item in duplicate_defects_infos %}
                            <div class="defect-item">
                                <p>
                                    <span>{{ loop.index }}、{{ item.type }}：{{ item.project_version_name }}&nbsp;&nbsp;&nbsp;&nbsp;缺陷单号：<a class="defect-link" href="/defect/{{ item.id }}">{{ item.defect_number }}</a></span>
                                </p>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-data">
                                暂未复制到其他项目
                            </div>
                        {% endif %}
                    </div>
                </div>
                <!-- 底部操作按钮 -->
                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line" >
                        <button type="button" class="ok-btn" style="width: 160px;" id="submitReviewBtn">提交</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

<!-- 6、developer_solution 开发人员解决措施阶段的表单 Start-->
{% if current_stage and (current_stage.stage_type == 'developer_solution' or current_stage.stage_type == 'dev_lead_review_solution') %}
<div class="section-header">
    <div class="section-title">
        <img src="/static/images/fengchi_tag.svg" alt="">
        {% if current_stage.stage_type == 'dev_lead_review_solution' %} 审核 {% endif %}解决措施 {% if current_stage.stage_type == 'developer_solution' %} 分工 {% endif %}
    </div>
    <span class="badge bg-info">所有用户可查看</span>
</div>
<div class="card mb-4">
    <div id="allSolutionDivisions" class="card-body">
        <!-- 显示所有分工信息 -->
        {% if solution_divisions %}
            <div class="mb-4">
                <div class="solutions-count">
                    共有 {{ solution_divisions|length }} 个分工及对应解决措施
                </div>
                {% for division in solution_divisions %}
                <div class="division-card mb-3 ">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="section-title color1">分工 {{ loop.index }}</h6>
                        {% if division.assignee_id == current_user.user_id %}
                            <span class="badge bg-primary">您的分工</span>
                        {% endif %}
                    </div>
                    <div class="division-item">
                        <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                            <div class="form-group" style="flex: 1; margin-right: 20px;">
                                <label class="label-style">修改模块:</label>
                                <div class="col-md-3">{{ division.module }}</div>
                            </div>
                            <div class="form-group" style="flex: 1; margin-right: 20px;">
                                <label class="label-style">完成时间:</label>
                                <div class="col-md-3">{{ division.due_date.strftime('%Y-%m-%d') if division.due_date else '未设置' }}</div>
                            </div>
                            <div class="form-group" style="flex: 1; margin-right: 20px;">
                                <label class="label-style">执行人员:</label>
                                <div class="col-md-12">
                                    {{ division.assignee.real_name if division.assignee else '未分配' }}/{{ division.assignee.email if division.assignee else '未分配' }}
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="flex: 1; margin-right: 20px;">
                            <label class="label-style">执行措施:</label>
                            <p class="p-2 bg-light rounded">{{ division.action_plan }}</p>
                        </div>

                       <!-- 显示该分工对应的解决措施 -->
                        {% set division_solutions = solution_data | selectattr('solution_division_id', 'equalto', division.id) | list %}
                        {% if division_solutions %}
                            <div class="mt-3">
                                <h6 class="mb-2">已提交的解决措施:</h6>
                                {% for solution_data in division_solutions %}
                                    {# 判断是否同时满足两个条件：当前用户提交的 + 被驳回 #}
                                    {% set is_current_user = division.assignee_id == current_user.user_id %}
                                    {% set is_rejected = division.status == 'InvitationStatus.REJECTED' %}

                                    {% if not (is_current_user and is_rejected) %}
                                        <div class="solution-item-container">
                                            {% if is_assignee and current_stage.stage_type == 'dev_lead_review_solution' and solution_divisions|length > 1 %}
                                                <div class="solution-checkbox">
                                                    <input type="checkbox" class="form-check-input check-box-border" id="{{ division.id }}">
                                                </div>
                                            {% endif %}

                                            <div class="card mb-2 solution-checkbox-item">
                                                <div class="card-header py-1 d-flex justify-content-between align-items-center">
                                                    <span class="small">提交于 {{ solution_data.created_time.replace('T', ' ') if solution_data.created_time else '未知时间' }}</span>

                                                    {% if division.assignee_id == current_user.user_id %}
                                                        <span class="badge bg-success">您提交的</span>
                                                    {% endif %}

                                                    {% if division.status == 'InvitationStatus.REJECTED' %}
                                                        <span class="badge bg-warning">被驳回</span>
                                                    {% endif %}

                                                    {% if division.status == 'InvitationStatus.PENDING' %}
                                                        <span class="badge bg-warning">暂存</span>
                                                    {% endif %}

                                                    {% if is_dev_manager and division.assignee_id != current_user.user_id and division.status == 'InvitationStatus.COMPLETED' %}
                                                        <button style="display:none" type="button" class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#rejectSingleSolutionModal" data-division-id="{{ division.id }}">
                                                            驳回
                                                        </button>
                                                    {% endif %}
                                                </div>
                                                <div class="card-body py-2">
                                                    {% for solution in solution_data.content.solutions %}
                                                        <div class="mb-2">
                                                            <div class="d-flex">
                                                                <span class="badge bg-secondary ms-2 me-2">{{ loop.index }}</span>
                                                                <div class="flex-grow-1">
                                                                    <h6 class="mb-1">{{ solution.title }}</h6>
                                                                    <div class="solution-content-show">{{ solution.description | safe }}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% else %}
                            <!--尚未提交解决措施-->
                            <div class="mt-3">
                                <p class="text-muted">尚未提交解决措施</p>
                                {% if is_dev_manager and  division.assignee_id != current_user.user_id%}
                                    <button type="button" class="small-button btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#remindSingleSolutionModal" data-division-id="{{ division.id }}">
                                    跟催
                                    </button>
                                {% endif %}
                            </div>
                        {% endif %}
                        <!-- 如果是当前用户的分工且(未提交解决措施或被驳回或暂存)，显示表单 -->
                        {% if division.assignee_id == current_user.user_id and (not division_solutions or division.status == 'InvitationStatus.REJECTED' or division.status == 'InvitationStatus.PENDING') %}
                            <!-- 修改：添加表单容器，用于存储暂存数据 -->
                            <div class="mt-3 p-3 border rounded bg-light solution-form-container"
                                 id="solution-form-container-{{ division.id }}"
                                 data-division-status="{{ division.status }}">
                                <h6 class="h6-bottom">
                                    {% if division.status == 'InvitationStatus.REJECTED' %}
                                        <span class="badge bg-warning">被驳回</span>修改并重新提交解决措施
                                    {% elif division.status == 'InvitationStatus.PENDING' %}
                                        编辑并提交解决措施
                                    {% else %}
                                        提交解决措施
                                    {% endif %}
                                </h6>
                                <form class="solution-form" method="post" action="{{ url_for('defect.submit_solution', defect_id=defect.id) }}">
                                    <input type="hidden" name="division_id" value="{{ division.id }}">
                                    <input type="hidden" name="is_draft" id="isOnlySaveSolution-{{ division.id }}" value="false">
                                    <!-- 隐藏的solutions字段，用于存储组合后的JSON数据 -->
                                    <textarea class="form-control d-none" id="solutionCombined-{{ division.id }}" name="solutions" rows="6"></textarea>

                                    <!-- 关键修改：存储服务端返回的solution_data，优先使用最新的一条 -->
                                    {% if division_solutions and (division.status == 'InvitationStatus.REJECTED' or division.status == 'InvitationStatus.PENDING') %}
                                        {% set latest_solution = division_solutions|last %}
                                        <div id="solution-data-storage-{{ division.id }}"
                                             class="d-none"
                                             data-solutions='{{ latest_solution.content.solutions|tojson|safe }}'>
                                        </div>
                                    {% else %}
                                        <div id="solution-data-storage-{{ division.id }}"
                                             class="d-none"
                                             data-solutions="">
                                        </div>
                                    {% endif %}

                                    <div class="solution-items" id="solutionItems-{{ division.id }}">
                                        <!-- 加载提示 -->
                                        <div class="description-item mb-3">
                                            <div class="card editor-field">
                                                <div class="card-body text-center">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">加载中...</span>
                                                    </div>
                                                    <p class="mt-2">正在加载解决措施数据...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div class="add-solution flex items-center justify-center" id="addSolutionBtn-{{ division.id }}" data-bs-toggle="modal" data-bs-target="#solutionAddFieldModal">
                                            <div class="addicon">
                                                <img src="/static/images/defect/news_add.png">
                                            </div>
                                            <div class="add-text">添加解决措施</div>
                                        </div>
                                        <span class="text-muted solution-counter" id="solutionCounter-{{ division.id }}">0/10</span>
                                    </div>

                                    <div class="button-group-out">
                                        <div class="drawer-buttons button-group-line" >
                                            <button type="button" class="btn-batch mr-3" data-division-id="{{ division.id }}" id="saveSolutionDraft-{{ division.id }}">暂存</button>
                                            <button type="button" class="ok-btn btn-batch mr-3" style="width: 180px;" id="aiSolution-{{ division.id }}" >AI自评 <img src="/static/images/start-pic.svg" alt="刷新"> </button>
                                            <button type="button" class="ok-btn" style="width: 180px;" id="saveSolution-{{ division.id }}">{% if division.status == 'InvitationStatus.REJECTED' %}重新提交审核{% else %}提交审核{% endif %}</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> 暂无分工信息
            </div>
        {% endif %}
    </div>
</div>
{% endif %}
<!-- developer_solution 开发人员解决措施阶段的表单 End-->

<!-- 解决措施添加字段模态框 -->
<div class="modal fade" id="solutionAddFieldModal" tabindex="-1" aria-labelledby="solutionAddFieldModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="solutionAddFieldModalLabel">添加解决措施</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="solutionNewFieldTitle">解决措施标题</label>
                    <input type="text" class="form-control" id="solutionNewFieldTitle" placeholder="请输入解决措施标题">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="solutionConfirmAddField">确认添加</button>
            </div>
        </div>
    </div>
</div>

    <!--7、 dev_lead_review_solution 开发主管审核解决措施阶段 -->
    {% if is_assignee and current_stage and current_stage.stage_type == 'dev_lead_review_solution' %}
    <div class="mb-4">
        <div class="py-2 px-4">
                <!-- 操作按钮 -->
                 <div class="button-group-out">
                     <div class="drawer-buttons button-group-line" >
                        <button id="rejectSolutionsButton" class="btn-batch" data-action="驳回原因分析" data-bs-toggle="modal" >驳回</button>
                        <button type="button" class="ok-btn" style="width: 220px;" data-bs-toggle="modal" data-bs-target="#approveSolutionModal">同意并提交至回归测试</button>
                    </div>
                </div>

                <!-- 隐藏字段用于存储审核结果 -->
                <input type="hidden" id="approved_in_review_solution" name="approved" value="false">

        </div>
    </div>
    {% endif %}

    <!--8、 tester_regression 回归测试阶段 -->
    {% if current_stage and current_stage.stage_type == 'tester_regression' and current_stage.status == 'StageStatus.PENDING_UPDATE' %}
        {% set tester_regression_mode = "update" %}
    {% endif %}

    {% if current_stage and current_stage.stage_type == 'tester_regression' and is_assignee and current_stage.status != 'StageStatus.COMPLETED'%}
    <div class="division-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-3">回归测试</h5>
        </div>
        <div class="card-body">
            <form id="regressionTestForm" method="post" action="{{ url_for('defect.submit_regression_test', defect_id=defect.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                <input type="hidden" name="is_draft" id="isOnlySaveRegressionTest" value="false">
                <!-- 隐藏的description字段，用于存储组合后的内容 -->
                <textarea class="form-control d-none" id="regressionDescription" name="description" rows="6"></textarea>
                <!-- 缺陷描述容器 -->
                <div id="descriptionItems">
                    <!-- 加载提示 -->
                    <div class="description-item mb-3">
                        <div class="card editor-field">
                            <div class="card-body text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2">正在加载模板数据...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 添加缺陷描述按钮 -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div id="addDescription" class="add-solution flex items-center justify-center" data-bs-toggle="modal" data-bs-target="#regressionAddDescriptionModal">
                        <div class="addicon">
                            <img src="/static/images/defect/news_add.png">
                        </div>
                        <div class="add-text">添加缺陷描述</div>
                    </div>
                    <span class="text-muted solution-counter" id="descriptionCounter">0/10</span>
                </div>

                <!-- 操作按钮 -->
                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line">
                        <button type="button" class="btn-batch mr-3" data-bs-toggle="modal" data-bs-target="#rejectModal">驳回</button>
                        <button type="button" class="btn-batch mr-3" id="saveDraftRegressionTestBtn">暂存</button>
                        <button type="button" class="ok-btn btn-batch mr-3" style="width: 180px;"  id="aiRegressionTest">AI自评 <img src="/static/images/start-pic.svg" alt="刷新"> </button>
                        <button type="submit" class="ok-btn" style="width: 180px;" id="submitRegressionTestBtn">提交测试审核</button>
                    </div>
                </div>

            </form>
        </div>
    </div>
    {% endif %}

    <!-- 9、test_manager_review_regression 测试经理审核回归测试阶段 -->
    {% if is_assignee and current_stage and current_stage.stage_type == 'test_manager_review_regression' %}
    <div class="division-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-3">审核回归测试结果</h5>
        </div>
        <div class="card-body">
            <form id="reviewRegressionForm" method="POST" action="{{ url_for('defect.test_manager_review_regression', defect_id=defect.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">

                <!-- 审核意见 -->
                <div class="mb-4">
                    <label class="form-label fw-bold">审核意见</label>
                    <textarea class="text-area-border" id="review_notes_in_review_regression" name="review_notes" rows="4"
                              placeholder="请输入审核意见..." required></textarea>
                    <div class="form-text">请详细说明审核意见，特别是驳回时需要说明具体原因。</div>
                </div>

                <!-- 操作按钮 -->
                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line" >
                        <button type="button" class="btn-batch mr-3" style="width: 180px;" onclick="submitRegressionReview(false)">驳回给测试人员</button>
                        <button type="button" class="ok-btn" style="width: 144px;" onclick="submitRegressionReview(true)">审核通过</button>
                    </div>
                </div>


                <!-- 隐藏字段用于存储审核结果 -->
                <input type="hidden" id="approved_in_review_regression" name="approved" value="false">
            </form>
        </div>
    </div>
    {% endif %}

    <!--10、 requester_confirm 提出人确认阶段 -->
    {% if current_stage and current_stage.stage_type == 'requester_confirm' and is_assignee and defect.status != 'DefectStatus.CLOSED'%}
    <div class="division-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-3">确认缺陷解决</h5>
        </div>
        <div class="card-body">
            <form id="requesterConfirmForm" method="POST" action="{{ url_for('defect.requester_confirm', defect_id=defect.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">

                <!-- 确认意见 -->
                <div class="mb-4">
                    <label for="confirm_notes" class="form-label fw-bold">确认意见</label>
                    <textarea class="text-area-border" id="confirm_notes" name="confirm_notes" rows="4"
                              placeholder="请输入确认意见..." required></textarea>
                    <div class="form-text">请详细说明确认意见，特别是驳回时需要说明具体原因。</div>
                </div>

                <!-- 操作按钮 -->
                <div class="button-group-out">
                    <div class="drawer-buttons" style="width: 60%;height: 100px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;" onclick="submitRequesterConfirm(false)">驳回</button>
                        <button type="button" class="ok-btn" style="width: 120px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;" onclick="submitRequesterConfirm(true)">确认解决</button>
                    </div>
                </div>

                <!-- 隐藏字段用于存储确认结果 -->
                <input type="hidden" id="confirmed" name="confirmed" value="false">
            </form>
        </div>
    </div>
    {% endif %}

    {% if not is_assignee or defect.status == 'DefectStatus.CLOSED' or defect.status == 'DefectStatus.TERMINATE_TRACKING'%}
    <div style="width: 100%;height: 100px;display: flex;justify-content: center;align-items: center;">
        <div class="button-group">
            <a href="{{ url_for('defect.defect_list') }}" class="ok-btn" style="width: 120px;" >返回列表</a>
        </div>
    </div>
    {% endif %}

</div>


<!-- 同意并提交至回归测试模态框 -->
<div class="modal fade" id="approveSolutionModal" tabindex="-1" aria-labelledby="approveSolutionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                    <div class="flex items-center justify-center">
                        <img src="/static/images/defect/p2_03.png" alt="测试图标" class="test-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;">
                        <span style="margin-top: 2px;">指定回归测试人员</span>
                    </div>
                </div>
            </div>
            <form id="reviewSolutionForm" method="POST" action="{{ url_for('defect.dev_lead_review_solution', defect_id=defect.id) }}">
            <div style="padding: 0 40px;margin-top: 24px;">
                    <!-- 人员搜索区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#666;margin-bottom: 12px;">
                            请选择测试人员的 Email 账号，平台将会通知他
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="regressionMemberSearch" class="form-control" placeholder="搜索测试人员" style="width: 100%;height: 40px;border: 1px solid #D5E8FF;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                            <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                            <!-- 下拉框 -->
                            <div id="regressionMemberDropdown" class="member-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;margin-top: 10px;">
                                <!-- 动态生成搜索结果 -->
                            </div>
                        </div>
                    </div>

                    <input type="hidden" class="form-control" id="regressionMember_id" name="tester_id" required>

                    <!-- 隐藏字段用于存储审核结果 -->
                    <input type="hidden" id="approved_in_review_solution_dialog" name="approved" value="false">

                    <!-- 姓名显示区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label-style">姓名</label>
                        <div id="selectedRegressionMemberName" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F8F9FA;color: #999;display: flex;align-items: center;">通过Email账号搜索测试人员，此处将会自动填充姓名</div>
                    </div>

                    <!-- 审核意见 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label-style">审核意见</label>
                        <textarea class="text-area-border" id="review_notes_in_review_solution_dialog" name="review_notes" rows="4"
                        placeholder="请输入审核意见..." style ="display:block" required></textarea>
                    </div>

                </div>

                <div class="button-group-out">
                    <div class="drawer-buttons" style="width: 60%;height: 100px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="button" class="ok-btn" style="width: 120px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;" onclick="submitSolutionReview(true)">提交</button>
                    </div>
                </div>
        </form>
        </div>
    </div>
</div>

<!-- 审核确认模态框 -->
<div class="modal fade" id="confirmReviewModal" tabindex="-1" aria-labelledby="confirmReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                    <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                        <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                            <img src="/static/images/defect/p2_02.png" alt="驳回图标" class="reject-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;"> 确认审核
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">确认要执行此操作吗？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" style="min-width:80px;border-radius:8px;background:linear-gradient(90deg,#9767FF 0%,#217EFD 100%);border:none;" id="confirmSubmit">确认</button>
            </div>
        </div>
    </div>
</div>

<!-- 提出人确认 模态框 -->
<div class="modal fade" id="confirmRequesterModal" tabindex="-1" aria-labelledby="confirmRequesterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
             <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                    <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                        <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                            <img src="/static/images/defect/p2_02.png" alt="驳回图标" class="reject-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;"> 确认操作
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>
            <div class="modal-body">
                <p id="confirmRequesterMessage">确认要执行此操作吗？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" style="min-width:80px;border-radius:8px;background:linear-gradient(90deg,#9767FF 0%,#217EFD 100%);border:none;" id="confirmRequesterSubmit">确认</button>
            </div>
        </div>
    </div>
</div>

<!-- 标记为重复的模态框 -->
<div class="modal fade" id="duplicateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">标记为重复问题</h5>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('defect.mark_as_duplicate', defect_id=defect.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="source_defect_id" class="form-label">源缺陷ID</label>
                        <input type="number" class="form-control" id="source_defect_id" name="source_defect_id" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning">标记为重复</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 终止跟踪模态框 -->
<div class="modal fade" id="terminateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                    <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                        <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                            <img src="/static/images/defect/p2_02.png" alt="驳回图标" class="reject-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;"> 终止跟踪
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>
            <form method="post" action="{{ url_for('defect.terminate_defect', defect_id=defect.id) }}">
                <div style="padding: 0 40px;margin-top: 24px;">
                    <div class="form-group">
                        <label class="label-style">
                            <span style="color: red;">*</span>终止原因
                        </label>
                        <textarea class="text-area-border" id="terminate_reason" name="reason" placeholder="请输入" required></textarea>
                    </div>
                </div>
                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line-dialog">
                        <button type="button" class="cance-button btn-batch mr-3 " data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="confirm-button ok-btn">确定终止</button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- 驳回模态框（通用） -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                    <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                        <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                            <img src="/static/images/defect/p2_02.png" alt="驳回图标" class="reject-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;"> 驳回
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>
            <form method="post" id="rejectForm" action="{{ url_for('defect.reject_defect', defect_id=defect.id) }}">
                <div style="padding: 0 40px;margin-top: 24px;">
                    <div class="form-group">
                        <label class="label-style">
                            <span style="color: red;">*</span>驳回原因
                        </label>
                        <input type="hidden" name="selected_invitation_ids" id="selectedInvitationIds" value="">
                        <input type="hidden" name="selected_division_ids" id="selectedDivisionIds" value="">
                        <textarea id="rejectReason" name="reason" class="text-area-border" placeholder="请输入" ></textarea>
                    </div>
                </div>

                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line-dialog">
                        <button type="button" class="cance-button btn-batch mr-3 " data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="confirm-button ok-btn" id="confirmReject">确定驳回</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- 驳回模态框（驳回定位的邀请） -->
<div class="modal fade" id="rejectInviteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                    <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                        <img src="/static/images/defect/p2_02.png" alt="驳回图标" class="reject-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;"> 驳回邀请
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>

            <form id="rejectInviteForm" method="post" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">

                <div style="padding: 0 40px;margin-top: 24px;">
                    <div class="form-group">
                        <label class="label-style">
                            <span style="color: red;">*</span>驳回原因
                        </label>
                        <textarea id="reject_reason_of_invitation" name="reason" class="text-area-border" placeholder="请输入"></textarea>
                    </div>
                </div>

                 <div class="button-group-out">
                     <div class="drawer-buttons button-group-line" >
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="submit" class="ok-btn"  style="width: 120px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">确定驳回</button>
                     </div>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- 驳回模态框（驳回单个的原因分析） -->
<div class="modal fade" id="rejectSingleAnalysisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">驳回邀请</h5>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="rejectSingleAnalysisForm" method="post" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="reject_reason_of_invitation" class="form-label">驳回原因</label>
                        <textarea class="text-area-border" id="reject_reason_of_analysis" name="reason" rows="3" required></textarea>
                    </div>
                </div>

                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line-dialog">
                        <button type="button" class="cance-button btn-batch mr-3 " data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="confirm-button ok-btn">确定驳回</button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- 跟催模态框（跟催单个的原因分析） -->
<div class="modal fade" id="remindSingleAnalysisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                    <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                        <img src="/static/images/defect/p2_02.png" alt="驳回图标" class="reject-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;"> 跟催
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>

            <form id="remindSingleAnalysisForm" method="post" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">

                <div style="padding: 0 40px;margin-top: 12px;">
                    <div class="form-group">
                        <label class="label-style">
                            <span style="color: red;">*</span>跟催原因
                        </label>
                        <textarea id="remind_reason_of_analysis" name="reason" class="text-area-border" placeholder="请输入" ></textarea>
                    </div>
                </div>

                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line" >
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="submit" class="ok-btn"  style="width: 120px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">确定发送</button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>


<!-- 弃用模态框（弃用单个的原因分析） -->
<div class="modal fade" id="cancelSingleAnalysisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">弃用原因分析</h5>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cancelSingleAnalysisForm" method="post" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                <div style="padding: 0 40px;margin-top: 12px;">
                    <div class="form-group">
                        <label class="label-style">
                            <span style="color: red;">*</span>弃用原因
                        </label>
                        <textarea id="cancel_reason_of_analysis" name="reason" class="text-area-border" placeholder="请输入" ></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                    <button type="submit" class="ok-btn"  style="width: 120px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">确认弃用</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- 驳回单个解决措施模态框 -->
<div class="modal fade" id="rejectSingleSolutionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">驳回解决措施</h5>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="rejectSingleSolutionForm" method="post" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="reject_reason_of_solution" class="form-label">驳回原因</label>
                        <textarea class="text-area-border" id="reject_reason_of_solution" name="reason" rows="3" required></textarea>
                    </div>
                </div>

                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line" >
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="submit" class="ok-btn"  style="width: 120px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">确定驳回</button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- 跟催单个解决措施模态框 -->
<div class="modal fade" id="remindSingleSolutionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">跟催解决措施</h5>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>
            <form id="remindSingleSolutionForm" method="post" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">

                <div style="padding: 0 40px;margin-top: 24px;">
                    <div class="form-group">
                        <label class="label-style">
                            <span style="color: red;">*</span>跟催原因
                        </label>
                        <textarea id="remind_reason_of_solution" name="reason" class="text-area-border" placeholder="请输入" ></textarea>
                    </div>
                </div>

                <div class="button-group-out">
                    <div class="drawer-buttons button-group-line" >
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="submit" id="remind_of_solution_submit" class="ok-btn"  style="width: 120px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">确定发送</button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>


<!-- 指定测试人员模态框 -->
<div class="modal fade" id="assignTesterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                    <div class="flex items-center justify-center">
                        <img src="/static/images/defect/p2_03.png" alt="测试图标" class="test-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;">
                        <span style="margin-top: 2px;">指定测试人员再测试</span>
                    </div>
                </div>
            </div>
            <form method="post" action="{{ url_for('defect.assign_tester', defect_id=defect.id) }}">
                <div style="padding: 0 40px;margin-top: 24px;">
                    <!-- 人员搜索区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#666;margin-bottom: 12px;">
                            请选择测试人员的 Email 账号，平台将会通知他
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="testMemberSearch" class="form-control" placeholder="搜索测试人员" style="width: 100%;height: 40px;border: 1px solid #D5E8FF;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                            <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                            <!-- 下拉框 -->
                            <div id="testMemberDropdown" class="member-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;margin-top: 10px;">
                                <!-- 动态生成搜索结果 -->
                            </div>
                        </div>
                    </div>

                    <input type="hidden" class="form-control" id="tester_id" name="tester_id" required>

                    <!-- 姓名显示区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label-style">姓名</label>
                        <div id="selectedTestMemberName" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F8F9FA;color: #999;display: flex;align-items: center;">通过Email账号搜索测试人员，此处将会自动填充姓名</div>
                    </div>

                    <!-- 测试说明区域 -->
                    <div class="form-group">
                        <label class="label-style">测试说明</label>
                        <textarea id="testComment" name="reason" class="text-area-border" placeholder="请输入测试说明和注意事项"></textarea>
                    </div>
                </div>
                <div class="button-group-out">
                    <div class="drawer-buttons" style="width: 60%;height: 100px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button class="ok-btn" id="confirmAssignTest" style="width: 120px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">提交</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 提交开发定位模态框 -->
<div class="modal fade" id="inviteDeveloperModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
              <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                    <div class="flex items-center justify-center">
                        <img src="/static/images/defect/p2_03.png" alt="测试图标" class="test-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;">
                        <span style="margin-top: 2px;">指定开发人员定位</span>
                    </div>
                </div>
            </div>
            <form method="post" action="{{ url_for('defect.invite_developers', defect_id=defect.id) }}">
                <div style="padding: 0 40px;margin-top: 24px;">
                    <!-- 人员搜索区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#666;margin-bottom: 12px;">
                            请选择处理人的 Email 账号，平台将会通知他
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="memberSearch" class="form-control" placeholder="搜索成员" style="width: 100%;height: 40px;border: 1px solid #D5E8FF;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                            <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                            <!-- 下拉框 -->
                            <div id="memberDropdown" class="member-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;">
                                <!-- 动态生成搜索结果 -->
                            </div>
                        </div>
                    </div>
                    <input type="hidden" class="form-control" id="invitee_id" name="invitee_id" required>
                    <!-- 姓名显示区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label-style">姓名</label>
                        <div id="selectedMemberName" style="width: 100%; height: 40px; border: 1px solid rgb(233, 239, 248); border-radius: 6px; padding: 12px; font-size: 14px; background-color: rgb(248, 249, 250); color: rgb(153, 153, 153); display: flex; align-items: center;">通过Email账号搜索成员，此处将会自动填充姓名</div>
                    </div>

                    <!-- 评审意见区域 -->
                    <div class="form-group">
                        <label class="label-style">评审意见</label>
                        <textarea id="reviewComment" name="review_notes" class="text-area-border" placeholder="请输入" ></textarea>
                    </div>
                </div>

                <div class="button-group-out">
                    <div class="drawer-buttons" style="width: 60%;height: 100px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="submit" class="ok-btn" id="confirmAssignDev" style="width: 120px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">提交</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- 转处理模态框 -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
              <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                    <div class="flex items-center justify-center">
                        <img src="/static/images/defect/p2_03.png" alt="测试图标" class="test-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;">
                        <span style="margin-top: 2px;">转开发人员解决</span>
                    </div>
                </div>
            </div>
            <form id="transferForm" method="post" action="{{ url_for('defect.transfer_to_other', defect_id=defect.id) }}">
                <div style="padding: 0 40px;margin-top: 24px;">
                    <!-- 人员搜索区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#666;margin-bottom: 12px;">
                            请选择处理人的 Email 账号，平台将会通知他
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="transferSearch" class="form-control" placeholder="搜索成员" style="width: 100%;height: 40px;border: 1px solid #D5E8FF;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                            <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                            <!-- 下拉框 -->
                            <div id="transferDropdown" class="member-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;">
                                <!-- 动态生成搜索结果 -->
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="transfer_to_user_id" id="transfer_to_user_id">
                    <!-- 姓名显示区域 -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label-style">姓名</label>
                        <div id="selectedTransferName" style="width: 100%; height: 40px; border: 1px solid rgb(233, 239, 248); border-radius: 6px; padding: 12px; font-size: 14px; background-color: rgb(248, 249, 250); color: rgb(153, 153, 153); display: flex; align-items: center;">通过Email账号搜索成员，此处将会自动填充姓名</div>
                    </div>

                    <!-- 转处理原因 -->
                    <div class="form-group">
                        <label class="label-style">转处理原因</label>
                        <textarea id="transfer_reason" name="reason" class="text-area-border" placeholder="请输入"></textarea>
                    </div>
                </div>

                <div class="button-group-out">
                    <div class="drawer-buttons" style="width: 60%;height: 100px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="submit" class="ok-btn"  style="width: 120px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">确定</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 复制缺陷单模态框 -->
<div class="modal fade" id="copyDefectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                    <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                        <div class="flex items-center justify-center">
                            <img src="/static/images/defect/pp.png" alt="笔" class="invite-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;">
                            <span style="margin-top: 2px;">向以下产品或项目同步复制此缺陷单 #{{ defect.defect_number }}</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>

            <form id="copyDefectForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">

                <div class="modal-body">
                    <div id="projectsContainer">
                        <!-- 项目表单将动态添加到这里 -->
                        <div class="project-form mb-10 border p-3 rounded">
                            <div class="row mb-10">
                                <!--缺陷所属产品线/技术族 -->
                                {% include "components/product_line_selector.html" %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group-out">
                    <div class="drawer-buttons" style="width: 60%;height: 40px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="submit" class="ok-btn" style="width: 140px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">提交复制</button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- 邀共同定位模态框 - 优化版 -->
<div class="modal fade" id="inviteDevelopersLocateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:16px;">
            <div class="d-flex justify-content-between align-items-center" style="border-radius:16px;text-align: center;">
                <div style="font-size:20px;font-weight:600;color:#222;width: 100%;height: 80px;background-image: url(/static/images/user-management/batch_header.png);background-size: 100% 100%;background-repeat: no-repeat;">
                    <div style="margin-top: 30px;text-align: center;width: 100%;height: 100%;">
                        <div class="flex items-center justify-center">
                            <img src="/static/images/defect/p2_03.png" alt="邀请图标" class="invite-icon" style="width: 24px;height: 24px;margin-right: 8px;vertical-align: middle;">
                            <span style="margin-top: 2px;">批量邀请共同定位</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close" style="font-size:20px;"></button>
            </div>

            <form id="inviteDevelopersForm" method="post" action="{{ url_for('defect.invite_developers', defect_id=defect.id) }}">
                <input type="hidden" name="invitees_data" id="inviteesData">

                <div class="modal-body" style="padding: 0 40px;margin-top: 24px;">
                    <!-- 邀请人员列表容器 -->
                    <div id="inviteeMembersContainer">
                        <div class="invitee-item" data-item-index="1">
                            <!-- 人员搜索区域和姓名显示区域（同一行） -->
                            <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                                <div class="form-group" style="flex: 1; margin-right: 20px;">
                                    <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">
                                        <span style="color: red;">*</span> 请选择处理人的 Email 账号，平台将会通知他
                                        <button type="button" class="remove-invitee-btn" style="float: right;color: #FE6380;border: 1px solid #FE6380;background: #fff;border-radius: 4px;padding: 2px 8px;font-size: 12px;cursor: pointer;display: none;">移除</button>
                                    </label>
                                    <div style="position: relative;">
                                        <input type="text" class="form-control invitee-search" placeholder="搜索成员" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                                        <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                                        <!-- 下拉框 -->
                                        <div class="invitee-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;">
                                            <!-- 动态生成搜索结果 -->
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group" style="width: 50%;">
                                    <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">姓名</label>
                                    <div class="selected-invitee-name" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;color: #999;display: flex;align-items: center;">
                                        通过Email账号搜索成员，此处将会自动填充姓名
                                    </div>
                                </div>
                            </div>

                            <!-- 原因输入区域 -->
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label class="label-style"><span style="color: red;">*</span> 原因</label>
                                <textarea class="invitee-reason text-area-border" placeholder="请输入"></textarea>
                            </div>
                            <input type="hidden" class="invitee-id">
                            <input type="hidden" class="invitee-email">
                            <input type="hidden" class="invitee-name">
                        </div>
                    </div>

                    <!-- 添加被邀请人按钮 -->
                    <div id="addInvitee" class="add-invitee-section flex items-center justify-center" style="border: 1px dashed #217efd;border-radius: 8px;padding:6px 15px;text-align: center;margin: 20px 0;cursor: pointer;transition: all 0.3s;">
                        <div class="addicon">
                            <img src="/static/images/defect/news_add.png">
                        </div>
                        <div class="add-text">添加被邀请人</div>
                </div>
                </div>
                <div class="modal-footer" style="width: 100%;height: 100px;display: flex;justify-content: center;align-items: center;">
                    <div class="drawer-buttons" style="width: 60%;height: 40px;display: flex;justify-content: center;align-items: center;gap: 20px;">
                        <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                        <button type="submit" class="ok-btn" style="width: 140px;background: linear-gradient(90deg, #9767FF 0%, #217EFD 100%);border: none;">发送邀请 (<span id="inviteeCount">1</span>)</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 添加描述模态框 回归测试使用-->
<div class="modal fade" id="regressionAddDescriptionModal" tabindex="-1" aria-labelledby="regressionAddDescriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="regressionAddDescriptionModalLabel">添加描述字段</h5>
                <button type="button" class="btn-close btn-close-custom-md" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="regressionNewFieldTitle" class="form-label">字段标题</label>
                    <input type="text" class="input-border" id="regressionNewFieldTitle" placeholder="请输入字段标题">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-batch" data-bs-dismiss="modal">取消</button>
                <button type="button" class="ok-btn"  style="width: 120px;" id="regressionConfirmAddField">确认添加</button>
            </div>
        </div>
    </div>
</div>




<!-- 确认提交审核弹窗 模块 -->
<div class="modal fade" id="submitConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:400px;">
        <div class="modal-content" style="border-radius:16px;width: 80%;background: linear-gradient(180deg, #E1DEFF 1.97%, #FFFFFF 27.61%);padding: 0 20px 24px;">
            <div style="position: absolute;right: 42%;top:-12%"><img src="/static/images/logo-icon.svg" alt="锥矢科技" class="logo-icon"></div>
            <div class="text-center">
                <div style="font-size:20px;font-weight:600;color:#222;margin-bottom:8px;margin-top: 50px;" class="del-text1">确定提交审核吗？</div>
                <div class="d-flex justify-content-center gap-3" style="margin-top: 40px;">
                    <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmSubmitBtn" style="min-width:123px;border-radius:8px;background:linear-gradient(90deg,#9767FF 0%,#217EFD 100%);border:none;">
                        确定提交
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- 确认提交分工弹窗 模块 -->
<div class="modal fade" id="submitDivisionConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:400px;">
        <div class="modal-content" style="border-radius:16px;width: 80%;background: linear-gradient(180deg, #E1DEFF 1.97%, #FFFFFF 27.61%);padding: 0 20px 24px;">
            <div style="position: absolute;right: 42%;top:-12%"><img src="/static/images/logo-icon.svg" alt="锥矢科技" class="logo-icon"></div>
            <div class="text-center">
                <div style="font-size:20px;font-weight:600;color:#222;margin-bottom:8px;margin-top: 50px;" class="del-text1">确定提交吗？</div>
                <div class="d-flex justify-content-center gap-3" style="margin-top: 40px;">
                    <button type="button" class="btn-batch mr-3" data-bs-dismiss="modal" style="min-width:123px;border-radius:8px;">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDivisionSubmitBtn" style="min-width:123px;border-radius:8px;background:linear-gradient(90deg,#9767FF 0%,#217EFD 100%);border:none;">
                        确定提交
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 20px;
}
.timeline-item {
    position: relative;
    margin-bottom: 20px;
}
.timeline-item-marker {
    position: absolute;
    left: -20px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #6c757d;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #6c757d;
}
.timeline-item-active .timeline-item-marker {
    background-color: #0d6efd;
    box-shadow: 0 0 0 2px #0d6efd;
}
.timeline-item-content {
    padding: 10px;
    border-left: 2px solid #dee2e6;
    margin-left: 10px;
}
.timeline-item:last-child .timeline-item-content {
    border-left: 2px solid transparent;
}
</style>


<!-- 姓名 邮箱 下拉列表CSS样式 -->
<style>
.autocomplete-dropdown {
  position: relative;
}

.autocomplete-menu {
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 1000;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ced4da;
  border-radius: 0.375rem;
  display: none;
}

.autocomplete-item {
  padding: 0.5rem 1rem;
  cursor: pointer;
}

.autocomplete-item:hover {
  background-color: #f8f9fa;
}

.autocomplete-item small {
  color: #6c757d;
}
</style>

<!-- 底部区域 -->
{% include "user/footer.html" %}

<!-- JavaScript 引入 -->
{% include "defect/base_js.html" %}
<script src="{{ url_for('static', filename='lib/wang-editor/index.js')}}"></script>

<!-- 2、test_manager_review_desc 提交开发定位 js-->
<script>
// 用户数据
    const userList = {{ user_list | tojson }};

    let selectedMember = null;

    // 成员搜索功能
    $('#memberSearch').on('input', function() {
        var searchTerm = $(this).val().toLowerCase().trim();
        var $dropdown = $('#memberDropdown');

        if (searchTerm.length === 0) {
            selectedMember = null;
            $('#selectedMemberName').html('通过Email账号搜索成员，此处将会自动填充姓名').css('color', '#999');
            $dropdown.hide();
            return;
        }

        // 搜索匹配的成员
        var matchedMembers = userList.filter(function(member) {
            return member.email.toLowerCase().includes(searchTerm) ||
                   member.name.includes(searchTerm);
        });

        if (matchedMembers.length > 0) {
            // 生成下拉框内容
            var dropdownHtml = '';
            matchedMembers.forEach(function(member) {
                dropdownHtml += `
                        <div class="member-dropdown-item"
                             data-userid="${member.user_id}"
                             data-email="${member.email}"
                             data-name="${member.name}"
                             data-department="${member.department}">
                            ${member.name} / ${member.email}
                        </div>`;
            });

            $dropdown.html(dropdownHtml).show();
        } else {
            selectedMember = null;
            $('#selectedMemberName').html('未找到匹配的成员').css('color', '#ff6b6b');
            $dropdown.hide();
        }
    });

    // 下拉框选项点击事件
    $(document).on('click', '.member-dropdown-item', function() {
        var $item = $(this);
        var email = $item.data('email');
        var name = $item.data('name');
        var userID = $item.data('userid');
        var department = $item.data('department');

        // 设置选中的成员
        selectedMember = {
            userID: userID,
            email: email,
            name: name,
            department: department
        };

        // 填充输入框和姓名显示
        $('#memberSearch').val(email);
        $('#invitee_id').val(userID);
        $('#selectedMemberName').html(name + ' (' + department + ')').css('color', '#222');

        // 隐藏下拉框
        $('#memberDropdown').hide();
    });

    // 点击其他地方隐藏下拉框
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#memberSearch, #memberDropdown').length) {
            $('#memberDropdown').hide();
        }
    });

   // 表单提交事件
    document.querySelector('#inviteDeveloperModal').addEventListener('submit', function(e) {
        var reviewComment = $('#reviewComment').val().trim();

        if (!selectedMember) {
            e.preventDefault();
            showToast('warning', '请先搜索并选择一个成员');
            return;
        }

        if (!reviewComment) {
            e.preventDefault();
            showToast('warning', '请输入评审意见');
            return;
        }

        // 显示处理中提示
        showToast('info', '正在指定开发人员...', 3000);
    });

</script>

<!-- 4、cause_analysis 开发人员定位问题 阶段 js-->
<script>
// 存储编辑器实例的对象
const analysisEditorInstances = {};
let analysisCount = 0; // 初始分析项数量
const maxAnalysis = 10;
let nextIndex = 0; // 用于生成唯一索引

// 修复模态框关闭不彻底的问题
function cleanupModalBackdrop() {
    // 移除所有模态框背景遮罩层
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => {
        backdrop.parentNode.removeChild(backdrop);
    });

    // 恢复页面滚动功能
    document.body.style.overflow = 'auto';
    document.body.style.paddingRight = '0';

    // 移除modal-open类
    document.body.classList.remove('modal-open');
}

// 判断富文本内容是否为空（包括默认的<p><br></p>情况）
function isEditorContentEmpty(htmlContent) {
    if (!htmlContent) return true;

    // 替换所有&nbsp;为空格，移除所有HTML标签
    const plainText = htmlContent
        .replace(/&nbsp;/gi, ' ')
        .replace(/<[^>]*>/g, '');

    // 检查是否只包含空白字符
    return /^\s*$/.test(plainText);
}

// 清理编辑器内容 - 移除空段落和冗余空格
function cleanEditorContent(content) {
    if (!content) return '';

    // 移除空段落和只有&nbsp;的段落
    let cleanedContent = content
        .replace(/<p>\s*(&nbsp;|\s)*\s*<\/p>/gi, '')  // 移除空段落
        .replace(/<p>(\s|&nbsp;)*<\/p>/gi, '')        // 移除只包含空格或&nbsp;的段落
        .replace(/(<p><br><\/p>)+/gi, '')             // 移除多个连续的<p><br></p>
        .replace(/<p>\s*<br>\s*<\/p>/gi, '')          // 移除<p><br></p>
        .trim();

    // 如果清理后内容为空，返回空字符串
    if (isEditorContentEmpty(cleanedContent)) {
        return '';
    }

    return cleanedContent;
}

// 初始化wangEditor
function initAnalysisEditor(editorId, textareaName, initialContent = '') {
    if (!document.getElementById(`editor-${editorId}`)) {
        return false;
    }

    const { createEditor, createToolbar } = window.wangEditor;

    const editorConfig = {
        placeholder: '请输入原因分析内容...',
        onChange: (editor) => {
            // 内容变化时更新对应的隐藏textarea
            const textarea = $(`textarea[name="${textareaName}"]`);
            if (textarea.length) {
                textarea.val(editor.getHtml());
            }
            // 组合所有分析字段
            combineAnalysisFields();
        },
        MENU_CONF: {}
    };

    // 配置上传图片
    editorConfig.MENU_CONF['uploadImage'] = {
        server: '/user/aiVal/upload_pic', // 替换为你的图片上传接口地址
        fieldName: 'file', // 上传文件的字段名（与后端一致）
        maxFileSize: 5 * 1024 * 1024, // 5MB
        maxNumberOfFiles: 1, // 最多上传 5 张图片
        async customInsert(res, insertFn) { // 添加 async 关键字
            if (res.code == 1) {
                // 先插入图片到编辑器
                const imgNode = insertFn(res.url);

                try {
                    // 调用评估接口将图片URL存入数据库
                    const response = await fetch('/user/aiVal/create_evaluate_image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            url: res.url
                        })
                    });

                    const result = await response.json();

                    if (result.success && result.id) {
                        // 将返回的ID存储到图片元素的data-id属性中
                        console.log('保存图片信息成功:', result.id);
                    } else {
                        console.error('保存图片信息失败:', result.message);
                    }
                } catch (error) {
                    console.error('调用评估接口失败:', error);
                }
            } else {
                showToast('error', '上传失败');
            }
        }
    };

    // 清理初始内容
    const cleanedInitialContent = cleanEditorContent(initialContent);

    const editor = createEditor({
        selector: `#editor-${editorId}`,
        config: editorConfig,
        html: cleanedInitialContent || ''
    });

    // 创建工具栏
    createToolbar({
        editor,
        selector: `#toolbar-${editorId}`,
        config: {
            toolbarKeys: ['uploadImage'], // 只保留上传图片按钮
            excludeKeys: [
                'insertVideo', // 排除视频
                'group-video',   // 排除视频组
                'codeBlock'
            ]
        }
    });

    // 存储实例
    analysisEditorInstances[editorId] = editor;
    return editor;
}

// 显示无分析警告
function showNoAnalysisWarning(containerId = null) {
    const container = containerId ? $(`#${containerId}`) : $('#analysisItems');
    container.html(`
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>没有可编辑的分析内容
        </div>
    `);
}

// 生成分析字段
function generateAnalysisFields(items, containerSelector, invitationId = null) {
    const container = containerSelector ? $(containerSelector) : $('#analysisItems');
    container.empty();

    // 重置计数器
    if (!invitationId) {
        analysisCount = 0;
        nextIndex = 0;
    }

    if (items && items.length > 0) {
        // 检查items格式：如果是字符串数组（旧格式）还是对象数组（新格式）
        if (typeof items[0] === 'string' || !items[0].title) {
            // 旧格式：转换为新格式
            items.forEach((item, index) => {
                let title = `原因分析 ${index + 1}`;
                let description = item;
                if (invitationId) {
                    addAnalysisFieldMulti(title, description, invitationId);
                } else {
                    addAnalysisField(title, description);
                }
            });
        } else {
            // 新格式：对象数组
            items.forEach((item) => {
                if (invitationId) {
                    addAnalysisFieldMulti(item.title, item.description, invitationId);
                } else {
                    addAnalysisField(item.title, item.description);
                }
            });
        }
        updateAnalysisCounter(invitationId);
    } else {
        // 如果没有数据，显示提示信息
        container.html(`
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>暂无原因分析内容，请添加分析项
            </div>
        `);
    }
}

// 从API获取模板数据并初始化分析字段（单人分析）- 修改为：优先加载数据，没有数据时才加载模板
function initAnalysisFromDataOrTemplate(savedData = null) {
    const analysisForm = document.getElementById('analysisForm');
    if (!analysisForm) return;

    $('#analysisItems').empty();
    analysisCount = 0;
    nextIndex = 0;

    // 优先检查是否有从HTML中传递的服务端数据
    const serverDataEl = document.getElementById('serverAnalysisData');
    let serverAnalyses = null;

    if (serverDataEl && serverDataEl.value) {
        try {
            serverAnalyses = JSON.parse(serverDataEl.value);
            console.log('从服务端加载的分析数据:', serverAnalyses);
        } catch (e) {
            console.error('解析服务端数据失败:', e);
            serverAnalyses = null;
        }
    }

    // 如果有服务端数据，优先使用
    if (serverAnalyses && serverAnalyses.length > 0) {
        generateAnalysisFields(serverAnalyses, '#analysisItems');
        return;
    }

    // 如果没有服务端数据，尝试从模板加载
    fetch('/template/原因分析')
        .then(response => {
            if (!response.ok) {
                throw new Error('获取模板失败: ' + response.statusText);
            }
            return response.json();
        })
        .then(templateData => {
            if (templateData.items && templateData.items.length > 0) {
                // 处理模板数据为新格式
                const templateFields = templateData.items.map(item => ({
                    title: item.content.title,
                    description: ""
                }));
                generateAnalysisFields(templateFields, '#analysisItems');
            } else {
                addDefaultAnalysisFields();
            }
            updateAnalysisCounter();
        })
        .catch(error => {
            console.error('获取模板失败:', error);
            addDefaultAnalysisFields();
            updateAnalysisCounter();
            showToast('warning', '模板加载失败，已使用默认字段');
        });
}

// 从API获取模板数据并初始化分析字段（多人分析）- 修改为：优先加载数据，没有数据时才加载模板
function initAnalysisFromDataOrTemplateMulti(invitationId) {
    const containerSelector = `.analysis-items-container[data-invitation-id="${invitationId}"]`;

    // 优先检查是否有从HTML中传递的服务端数据
    const serverDataEl = $(`.server-analysis-data[data-invitation-id="${invitationId}"]`);
    let serverAnalyses = null;

    if (serverDataEl.length && serverDataEl.val()) {
        try {
            serverAnalyses = JSON.parse(serverDataEl.val());
            console.log('从服务端加载的多人分析数据:', serverAnalyses);
        } catch (e) {
            console.error('解析服务端数据失败:', e);
            serverAnalyses = null;
        }
    }

    // 如果有服务端数据，优先使用
    if (serverAnalyses && serverAnalyses.length > 0) {
        generateAnalysisFields(serverAnalyses, containerSelector, invitationId);
        return;
    }

    // 如果没有服务端数据，则尝试从模板加载
    fetch('/template/原因分析')
        .then(response => {
            if (!response.ok) {
                throw new Error('获取模板失败: ' + response.statusText);
            }
            return response.json();
        })
        .then(templateData => {
            $(containerSelector).empty();

            if (templateData.items && templateData.items.length > 0) {
                // 处理模板数据为新格式
                const templateFields = templateData.items.map(item => ({
                    title: item.content.title,
                    description: ""
                }));
                generateAnalysisFields(templateFields, containerSelector, invitationId);
            } else {
                addDefaultAnalysisFieldsMulti(invitationId);
            }
            updateAnalysisCounter(invitationId);
        })
        .catch(error => {
            console.error('获取模板失败:', error);
            $(containerSelector).empty();
            addDefaultAnalysisFieldsMulti(invitationId);
            updateAnalysisCounter(invitationId);
            showToast('warning', '模板加载失败，已使用默认字段');
        });
}

// 添加默认的分析字段（单人）
function addDefaultAnalysisFields() {
    const defaultFields = [
        { title: "根本原因分析", description: "请分析导致缺陷的根本原因" },
        { title: "影响因素", description: "请列举影响缺陷的相关因素" },
        { title: "复现步骤", description: "请描述缺陷的复现步骤" }
    ];

    defaultFields.forEach((field) => {
        addAnalysisField(field.title, field.description);
    });
}

// 添加默认的分析字段（多人）
function addDefaultAnalysisFieldsMulti(invitationId) {
    const defaultFields = [
        { title: "根本原因分析", description: "请分析导致缺陷的根本原因" },
        { title: "影响因素", description: "请列举影响缺陷的相关因素" },
        { title: "复现步骤", description: "请描述缺陷的复现步骤" }
    ];

    defaultFields.forEach((field) => {
        addAnalysisFieldMulti(field.title, field.description, invitationId);
    });
}

// 添加分析字段（单人）
function addAnalysisField(title, description) {
    const index = nextIndex++;
    const newItem = `
        <div class="analysis-item mb-3" data-index="${index}">
            <div class="card editor-field">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">${title}</h6>
                    <button type="button" class="remove-tag remove-analysis" data-index="${index}">
                        移除
                    </button>
                </div>
                <div class="card-body">
                    <div class="editor-container">
                        <div id="toolbar-${index}" class="editor-toolbar"></div>
                        <div id="editor-${index}" class="editor-content"></div>
                    </div>
                    <textarea class="d-none analysis-content" name="analysis-${index}">${description || ''}</textarea>
                </div>
            </div>
        </div>
    `;

    $('#analysisItems').append(newItem);

    // 初始化编辑器
    setTimeout(() => {
        initAnalysisEditor(index, `analysis-${index}`, description);
    }, 100);

    analysisCount++;
    updateRemoveButtons();
    updateAnalysisCounter();
}

// 添加分析字段（多人）
function addAnalysisFieldMulti(title, description, invitationId) {
    const container = $(`.analysis-items-container[data-invitation-id="${invitationId}"]`);
    const items = container.find('.analysis-item:not(.spinner-item)');
    const index = items.length;

    const newItem = `
        <div class="analysis-item mb-3" data-index="${index}" data-invitation-id="${invitationId}">
            <div class="card editor-field">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">${title}</h6>
                    <button type="button" class="remove-tag remove-analysis-multi" data-index="${index}" data-invitation-id="${invitationId}">
                        移除
                    </button>
                </div>
                <div class="card-body">
                    <div class="editor-container">
                        <div id="toolbar-${invitationId}-${index}" class="editor-toolbar"></div>
                        <div id="editor-${invitationId}-${index}" class="editor-content"></div>
                    </div>
                    <textarea class="d-none analysis-content-multi" name="analysis-${invitationId}-${index}">${description || ''}</textarea>
                </div>
            </div>
        </div>
    `;

    container.append(newItem);

    // 初始化编辑器
    setTimeout(() => {
        initAnalysisEditor(`${invitationId}-${index}`, `analysis-${invitationId}-${index}`, description);
    }, 100);

    updateAnalysisCounter(invitationId);
}

// 组合分析字段（单人）- 修改为新格式
function combineAnalysisFields() {
    const analysisData = [];

    $('.analysis-item').each(function() {
        const index = $(this).data('index');
        const $titleEl = $(this).find('.card-header h6');
        const $contentEl = $(this).find(`textarea[name="analysis-${index}"]`);

        if ($titleEl.length && $contentEl.length) {
            const title = $titleEl.text().trim();
            const description = $contentEl.val() || '';

            // 新格式：每个分析项是一个对象，包含title和description
            analysisData.push({
                title: title,
                description: description
            });
        }
    });

    // 将数据转换为JSON字符串并设置到隐藏的analyses字段
    document.getElementById('analysisContent').value = JSON.stringify(analysisData);
    return analysisData;
}

// 组合分析字段（多人）- 修改为新格式
function combineAnalysisFieldsMulti(invitationId) {
    const analysisData = [];
    const container = $(`.analysis-items-container[data-invitation-id="${invitationId}"]`);

    container.find('.analysis-item').each(function() {
        const index = $(this).data('index');
        const $titleEl = $(this).find('.card-header h6');
        const $contentEl = $(this).find(`textarea[name="analysis-${invitationId}-${index}"]`);

        if ($titleEl.length && $contentEl.length) {
            const title = $titleEl.text().trim();
            const description = $contentEl.val() || '';

            // 新格式：每个分析项是一个对象，包含title和description
            analysisData.push({
                title: title,
                description: description
            });
        }
    });

    // 将数据转换为JSON字符串并设置到隐藏的analyses字段
    document.getElementById('multiAnalysisContent').value = JSON.stringify(analysisData);
    return analysisData;
}

// 更新删除按钮状态
function updateRemoveButtons() {
    if (analysisCount === 1) {
        $('.remove-analysis').prop('disabled', true);
    } else {
        $('.remove-analysis').prop('disabled', false);
    }
}

// 更新分析计数器
function updateAnalysisCounter(invitationId = null) {
    if (invitationId) {
        const container = $(`.analysis-items-container[data-invitation-id="${invitationId}"]`);
        const count = container.find('.analysis-item').length;
        $(`.analysis-counter-multi[data-invitation-id="${invitationId}"]`).text(`${count}/${maxAnalysis}`);

        if (count >= maxAnalysis) {
            $(`.add-analysis-multi[data-invitation-id="${invitationId}"]`).prop('disabled', true);
        } else {
            $(`.add-analysis-multi[data-invitation-id="${invitationId}"]`).prop('disabled', false);
        }
    } else {
        $('#analysisCounter').text(`${analysisCount}/${maxAnalysis}`);

        if (analysisCount >= maxAnalysis) {
            $('#addAnalysis').prop('disabled', true);
        } else {
            $('#addAnalysis').prop('disabled', false);
        }
    }
}

// 移除分析项（单人）
$(document).on('click', '.remove-analysis', function() {
    if (analysisCount > 1) {
        const index = $(this).data('index');

        // 销毁编辑器实例
        if (analysisEditorInstances[index]) {
            analysisEditorInstances[index].destroy();
            delete analysisEditorInstances[index];
        }

        $(this).closest('.analysis-item').remove();
        analysisCount--;

        updateRemoveButtons();
        updateAnalysisCounter();
        combineAnalysisFields();
    }
});

// 移除分析项（多人）
$(document).on('click', '.remove-analysis-multi', function() {
    const index = $(this).data('index');
    const invitationId = $(this).data('invitation-id');
    const container = $(`.analysis-items-container[data-invitation-id="${invitationId}"]`);
    const items = container.find('.analysis-item');

    if (items.length > 1) {
        // 销毁编辑器实例
        const editorId = `${invitationId}-${index}`;
        if (analysisEditorInstances[editorId]) {
            analysisEditorInstances[editorId].destroy();
            delete analysisEditorInstances[editorId];
        }

        $(this).closest('.analysis-item').remove();
        updateAnalysisCounter(invitationId);
        combineAnalysisFieldsMulti(invitationId);
    }
});

// 模态框确认按钮点击事件（单人）
$('#analysisConfirmAddField').click(function() {
    const title = $('#analysisNewFieldTitle').val().trim();

    if (!title) {
        showToast('warning', '请输入字段标题');
        return;
    }

    if (analysisCount >= maxAnalysis) {
        showToast('warning', `最多只能添加${maxAnalysis}个原因分析`);
        $('#analysisAddFieldModal').modal('hide');
        return;
    }

    // 添加新字段
    addAnalysisField(title, '');
    combineAnalysisFields();

    // 清空模态框输入并关闭
    $('#analysisNewFieldTitle').val('');
    $('#analysisAddFieldModal').modal('hide');
    cleanupModalBackdrop();
});

// 添加分析字段按钮点击事件（多人）
$(document).on('click', '.add-analysis-multi', function() {
    const invitationId = $(this).data('invitation-id');
    const container = $(`.analysis-items-container[data-invitation-id="${invitationId}"]`);
    const count = container.find('.analysis-item').length;

    if (count >= maxAnalysis) {
        showToast('warning', `最多只能添加${maxAnalysis}个原因分析`);
        return;
    }

    // 存储当前邀请ID到模态框
    $('#analysisAddFieldModal').data('invitation-id', invitationId);
});

// 模态框确认按钮点击事件（多人）
$(document).on('click', '#analysisConfirmAddField', function() {
    const title = $('#analysisNewFieldTitle').val().trim();
    const invitationId = $('#analysisAddFieldModal').data('invitation-id');

    if (!title) {
        showToast('warning', '请输入字段标题');
        return;
    }

    if (invitationId) {
        const container = $(`.analysis-items-container[data-invitation-id="${invitationId}"]`);
        const count = container.find('.analysis-item').length;

        if (count >= maxAnalysis) {
            showToast('warning', `最多只能添加${maxAnalysis}个原因分析`);
            $('#analysisAddFieldModal').modal('hide');
            return;
        }

        // 添加新字段
        addAnalysisFieldMulti(title, '', invitationId);
        combineAnalysisFieldsMulti(invitationId);
    } else {
        // 单人分析
        if (analysisCount >= maxAnalysis) {
            showToast('warning', `最多只能添加${maxAnalysis}个原因分析`);
            $('#analysisAddFieldModal').modal('hide');
            return;
        }

        addAnalysisField(title, '');
        combineAnalysisFields();
    }

    // 清空模态框输入并关闭
    $('#analysisNewFieldTitle').val('');
    $('#analysisAddFieldModal').removeData('invitation-id');
    $('#analysisAddFieldModal').modal('hide');
    cleanupModalBackdrop();
});

$(document).ready(function() {
    // 初始化单人分析：优先使用服务端数据，没有数据时才使用模板
    initAnalysisFromDataOrTemplate();

    // 初始化多人分析表单
    $('.invitation-analysis-item').each(function() {
        const invitationId = $(this).data('invitation-id');
        const inviteeId = $(this).data('invitee-id');

        // 检查是否处于编辑模式
        const isReadonly = $(this).find('.view-mode-content').length > 0;
        if (isReadonly) {
            return; // 跳过只读模式的项目
        }

        // 检查当前用户是否是被邀请人
        const current_user_id = {{ current_user.user_id if current_user else 'null' }};
        if (inviteeId == current_user_id) { // 假设currentUserId是当前用户的ID
            // 优先使用服务端数据，没有数据时才使用模板
            initAnalysisFromDataOrTemplateMulti(invitationId);
        }
    });

    // 保存草稿（单人分析）
    $('#saveDraftBtn_in_cause_analysis').click(function() {
        combineAnalysisFields();
        // 设置暂存标识
        $('#isOnlySave').val('true');
        // 提交表单
        $('#analysisForm').submit();
    });

    // 保存草稿（多人分析）
    $(document).on('click', '.save-draft-multi', function() {
        const invitationId = $(this).data('invitation-id');
        // 组合分析字段
        combineAnalysisFieldsMulti(invitationId);

        // 设置当前邀请ID
        $('#currentInvitationId').val(invitationId);
        // 设置暂存标识
        $('#isOnlySaveMulti').val('true');
        // 提交表单
        $('#multiAnalysisForm').submit();
    });

    // AI自评（单人分析）
    $('#aiReviewBtn_in_cause_analysis').click(function() {
        combineAnalysisFields();
        // 这里可以实现AI自评的逻辑
        $('#analysisForm').append(`<input type="hidden" value="self" name="ai_done_act" />`);
        $('#saveDraftBtn_in_cause_analysis').click();
    });

    // AI自评（多人分析）
    $(document).on('click', '.ai-review-multi', function() {
        const invitationId = $(this).data('invitation-id');
        combineAnalysisFieldsMulti(invitationId);

        $('#multiAnalysisForm').append(`<input type="hidden" value="self" name="ai_done_act" />`);
        $(`.save-draft-multi[data-invitation-id="${invitationId}"]`).click();
    });

    // 表单提交验证（单人分析）
    function validateAnalysisForm() {
        combineAnalysisFields();

        const analysisContent = document.getElementById('analysisContent').value;
        if (!analysisContent || analysisContent === '[]') {
            showToast('warning', '请填写原因分析内容');
            return false;
        }

        try {
            const analyses = JSON.parse(analysisContent);
            let emptyItems = [];
            analyses.forEach((item, index) => {
                if (isEditorContentEmpty(item.description)) {
                    emptyItems.push(index + 1);
                }
            });

            if (emptyItems.length > 0) {
                showToast('warning', '请填写第 ' + emptyItems.join(', ') + ' 个原因分析的内容');
                return false;
            }
        } catch (e) {
            showToast('warning', '数据格式错误，请重新填写');
            return false;
        }

        return true;
    }

    // 表单提交验证（多人分析）
    function validateAnalysisFormMulti(invitationId) {
        combineAnalysisFieldsMulti(invitationId);

        const analysisContent = document.getElementById('multiAnalysisContent').value;
        if (!analysisContent || analysisContent === '[]') {
            showToast('warning', '请填写原因分析内容');
            return false;
        }

        try {
            const analyses = JSON.parse(analysisContent);
            let emptyItems = [];
            analyses.forEach((item, index) => {
                if (isEditorContentEmpty(item.description)) {
                    emptyItems.push(index + 1);
                }
            });

            if (emptyItems.length > 0) {
                showToast('warning', '请填写第 ' + emptyItems.join(', ') + ' 个原因分析的内容');
                return false;
            }
        } catch (e) {
            showToast('warning', '数据格式错误，请重新填写');
            return false;
        }

        return true;
    }

    // 单人分析提交按钮点击事件
    $('#submitAnalysisBtn').click(function() {
        // 设置非暂存标识
        $('#isOnlySave').val('false');

        if (validateAnalysisForm()) {
            // 验证通过，显示确认对话框
            $('#submitConfirmModal').modal('show');
        }
    });

    // 提交单个分析结果（多人分析）
    $(document).on('click', '.submit-analysis', function() {
        const invitationId = $(this).data('invitation-id');

        // 验证内容是否为空
        if (!validateAnalysisFormMulti(invitationId)) {
            return false;
        }

        // 设置当前邀请ID
        $('#currentInvitationId').val(invitationId);
        // 设置非暂存标识
        $('#isOnlySaveMulti').val('false');

        // 验证通过，显示确认对话框
        $('#submitConfirmModal').data('invitation-id', invitationId);
        $('#submitConfirmModal').modal('show');
    });

    // 确认提交按钮点击事件
    $('#confirmSubmitBtn').click(function() {
        // 提交单人分析表单
        if ($('#analysisForm').length) {
            $('#analysisForm').submit();
        }

        // 提交多人分析表单
        if ($('#multiAnalysisForm').length) {
            const invitationId = $('#submitConfirmModal').data('invitation-id');
            if (invitationId) {
                $('#currentInvitationId').val(invitationId);
                $('#multiAnalysisForm').submit();
            }
        }

        // 隐藏模态框
        $('#submitConfirmModal').modal('hide');
    });

    // 模态框关闭时清空输入
    $('#analysisAddFieldModal').on('hidden.bs.modal', function () {
        $('#analysisNewFieldTitle').val('');
        $(this).removeData('invitation-id');
        cleanupModalBackdrop();
    });
});
</script>

<!-- 5、dev_lead_review_analysis 开发主管审核原因分析 阶段 js-->
<script>
$(document).ready(function() {
    // 项目/版本 树——直接在模板中获取数据
    const treeData = {{ get_all_version_project() | safe }};
    // 设置选中的值（编辑模式下）
    let selectedValue = '';  // 存储当前选中的值
    let selectedText = '';   // 存储显示的文本

    // 初始化产品线选择器组件
    initProductLineSelector({
        treeData: treeData,
        selectedValue: selectedValue,
        selectedText: selectedText,
        onChange: function(value, text) {
            console.log('产品线选择变更:', value, text);
            // 可以在这里添加选择变更后的回调逻辑
        }
    });

    let divisionCount = 1;
    let formValid = false;
    let divisionsData = null;

    // 显示分工表单
    $('#showDivisionForm').click(function() {
        $('#divisionForm').show();
    });

    // 为分工表单设置自动完成功能
    function setupDivisionAutocomplete() {
        // 为所有现有的分工项设置自动完成
        document.querySelectorAll('.division-card').forEach(setupAutocompleteForDivision);

        // 监听新增分工事件
        document.addEventListener('divisionAdded', function(e) {
            setupAutocompleteForDivision(e.detail.divisionCard);
        });
    }

    // 监听操作按钮点击 （同意并制定解决计划）
    $(document).on('click', '.action-btn, .action-btn-checkcard', function(){
        var currentAction = $(this).data('action');
        var isCurrentlyActive = $(this).hasClass('active');
        var selectedAction;

        // 记录之前选中的按钮
        var previouslySelected = $('.action-btn.active, .action-btn-checkcard.active').data('action');

        // 移除所有按钮的激活状态
        $('.action-btn, .action-btn-checkcard').removeClass('active');

        var $selfAnalysisSection = $('#self-analysis-section');

        if (isCurrentlyActive) {
            // 如果当前按钮已激活，再次点击取消激活
            $(this).removeClass('active');
            $selfAnalysisSection.hide()
            selectedAction = null;
        } else {
            // 激活当前按钮
            $(this).addClass('active');
            $selfAnalysisSection.show()
            selectedAction = currentAction;
        }
        console.log('选择的操作：', selectedAction);
    });

    // 为单个分工项设置自动完成
    function setupAutocompleteForDivision(divisionCard) {
        const searchInput = divisionCard.querySelector('.solution-assignee-search');
        const nameInput = divisionCard.querySelector('.solution-assignee-name');
        const assigneeIdInput = divisionCard.querySelector('.division-assignee-id');
        const assigneeEmailInput = divisionCard.querySelector('.division-assignee-email');
        const autocompleteMenu = divisionCard.querySelector('.assignee-autocomplete');

        // 为搜索框设置自动完成
        setupAssigneeAutocomplete(searchInput, autocompleteMenu, assigneeIdInput, assigneeEmailInput, nameInput);
    }

    // 设置处理人自动完成功能
    function setupAssigneeAutocomplete(inputElement, menuElement, idElement, emailElement, nameElement) {
        if (!inputElement) return;

        inputElement.addEventListener('input', function() {
            const value = this.value.toLowerCase().trim();
            menuElement.innerHTML = '';

            if (value.length < 1) {
                menuElement.style.display = 'none';
                return;
            }

            // 过滤匹配的用户
            const matches = userList.filter(user =>
                (user.email && user.email.toLowerCase().includes(value)) ||
                (user.name && user.name.toLowerCase().includes(value))
            );

            if (matches.length === 0) {
                menuElement.innerHTML = '<div style="padding: 8px 12px; color: #999;">未找到匹配的用户</div>';
                menuElement.style.display = 'block';
                return;
            }

            // 显示匹配结果
            matches.forEach(user => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.style.padding = '8px 12px';
                item.style.cursor = 'pointer';
                item.style.borderBottom = '1px solid #f0f0f0';

                item.innerHTML = `
                    <div style="font-weight: 500;">${user.name || ''}</div>
                    <small style="color: #666;">${user.email || ''}</small>
                `;

                item.addEventListener('click', function() {
                    inputElement.value = user.email;
                    nameElement.value = user.name;
                    nameElement.style.color = '#222';
                    idElement.value = user.user_id;
                    emailElement.value = user.email;
                    menuElement.style.display = 'none';

                    // 显示成功消息
                    showToast('success', `已选择: ${user.name}`);
                });

                menuElement.appendChild(item);
            });

            menuElement.style.display = 'block';
        });

        // 点击外部时隐藏菜单
        document.addEventListener('click', function(e) {
            if (!inputElement.contains(e.target) && !menuElement.contains(e.target)) {
                menuElement.style.display = 'none';
            }
        });

        // 输入框失去焦点时短暂延迟后隐藏菜单
        inputElement.addEventListener('blur', function() {
            setTimeout(() => {
                menuElement.style.display = 'none';
            }, 200);
        });

        // 清空选择
        inputElement.addEventListener('input', function() {
            if (this.value === '') {
                nameElement.value = '';
                nameElement.style.color = '#999';
                idElement.value = '';
                emailElement.value = '';
            }
        });
    }

    // 初始化分工表单的自动完成
    setupDivisionAutocomplete();

    // 添加分工 - 修复后的代码
    $('#addDivision').click(function() {
        const divisionCount = $('.division-card').length + 1;
        const newDivision = `
          <div class="division-card" data-index="${divisionCount}">
            <div class="flex items-center justify-between" style="padding: 20px;">
                <h6 class="section-title color1">
                    解决措施分工 ${divisionCount}
                </h6>
                <button type="button" class="remove-tag remove-division">移除</button>
            </div>
            <div class="division-item">
                <div class="edit-container-body">
                    <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1; margin-right: 20px;">
                            <label class="label-style"><span style="color: red;">*</span> 修改模块</label>
                            <div class="layui-form">
                                <input name="division-${divisionCount}-module" required class="input-class">
                            </div>
                        </div>

                        <div class="form-group" style="width: 25%;margin-right: 20px;">
                            <label class="label-style"><span style="color: red;">*</span> 完成时间</label>
                            <div style="position: relative;">
                                <input name="division-${divisionCount}-due_date" required type="date" class="solution-datetime" id="ID-laydate-type-datetime-${divisionCount}" placeholder="请选择" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;" lay-key="${divisionCount}" lay-laydate-id="ID-laydate-type-datetime-${divisionCount}">
                            </div>
                        </div>
                        <div class="form-group" style="width: 25%;margin-right: 20px;">
                            <label class="label-style"><span style="color: red;">*</span> 请选择处理人的 Email 账号</label>
                            <div style="position: relative;">
                                <input type="text" class="form-control solution-assignee-search" placeholder="搜索邮箱地址或姓名" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                                <img src="/static/images/defect/ss.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                                <div class="autocomplete-menu assignee-autocomplete" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;"></div>
                            </div>
                        </div>
                        <div class="form-group" style="width: 25%;">
                            <label class="label-style"><span style="color: red;">*</span> 处理人的姓名</label>
                            <div style="position: relative;">
                                <input name="division-${divisionCount}-name" type="text" class="form-control solution-assignee-name" placeholder="自动填充" readonly style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;color: #999;">
                            </div>
                        </div>
                    </div>
                    <input type="hidden" class="division-assignee-id" name="division-${divisionCount}-assignee">
                    <input type="hidden" class="division-assignee-email" name="division-${divisionCount}-email">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label-style"><span style="color: red;">*</span> 执行措施</label>
                        <textarea name="division-${divisionCount}-action_plan" required class="text-area-border solution-measure" placeholder="请输入"></textarea>
                    </div>
                </div>
            </div>
        </div>

        `;
        $('#divisionContainer').append(newDivision);

        // 触发自定义事件，通知有新分工项添加
        const newDivisionCard = $('#divisionContainer .division-card').last()[0];
        const event = new CustomEvent('divisionAdded', { detail: { divisionCard: newDivisionCard } });
        document.dispatchEvent(event);
    });

    // 删除分工
    $(document).on('click', '.remove-division', function() {
        if ($('.division-card').length > 1) {
            $(this).closest('.division-card').remove();
            // 重新编号所有分工卡片
            $('.division-card').each(function(index) {
                $(this).attr('data-index', index + 1);
                $(this).find('h6').text(`解决措施分工 ${index + 1}`);
                // 更新表单字段名称
                $(this).find('input, select, textarea').each(function() {
                    const name = $(this).attr('name').replace(/division-\d+/, `division-${index+1}`);
                    $(this).attr('name', name);
                });
            });
        } else {
            showToast('warning', '至少需要保留一个解决措施分工');
        }
    });

    // 表单验证处理
    function validateForm() {
        // 收集所有分工数据
        const divisions = [];
        let isValid = true;

        $('.division-card').each(function(index) {
            const module = $(this).find('[name^="division-"][name$="-module"]').val().trim();
            const due_date = $(this).find('[name^="division-"][name$="-due_date"]').val();
            const assignee = $(this).find('.division-assignee-id').val();
            const action_plan = $(this).find('[name^="division-"][name$="-action_plan"]').val().trim();
            const email = $(this).find('.division-assignee-email').val();
            const name = $(this).find('[name^="division-"][name$="-name"]').val().trim();

            // 验证必填字段
            if (!module || !due_date || !action_plan || !email || !name || !assignee) {
                isValid = false;
                showToast('warning', `请填写第${index + 1}个分工的所有必填字段`);
                return false; // 退出循环
            }

            divisions.push({
                module: module,
                due_date: due_date,
                assignee: assignee,
                action_plan: action_plan
            });
        });

        return isValid ? divisions : null;
    }

    // 提交按钮点击事件
    $('#submitReviewBtn').click(function() {
        // 验证表单
        const divisions = validateForm();

        if (divisions) {
            // 存储验证通过的数据
            divisionsData = JSON.stringify(divisions);
            formValid = true;

            // 显示确认对话框
            $('#submitDivisionConfirmModal').modal('show');
        }
    });

    // 确认提交按钮点击事件
    $('#confirmDivisionSubmitBtn').click(function() {
        if (formValid && divisionsData) {
            // 将分工数据序列化并存入隐藏字段
            $('<input>').attr({
                type: 'hidden',
                name: 'divisions_data',
                value: divisionsData
            }).appendTo('#divisionSubmitForm');

            // 提交表单
            $('#divisionSubmitForm').submit();

            // 关闭模态框
            $('#submitDivisionConfirmModal').modal('hide');
        }
    });

    // 监听共性问题radio按钮点击事件
    $('#notCommonIssueRadio').click(function() {
        // 隐藏复制缺陷单信息
        $('#copyDefectInfoSection').hide();
    });

    $('#commonIssueRadio').click(function() {
        // 显示复制缺陷单信息
        $('#copyDefectInfoSection').show();
    });

    $('#toCopyDefect').click(function() {
        // 显示复制缺陷单模态框
        $('#copyDefectModal').modal('show');
        });
    });
</script>

// 6、developer_solution 开发人员解决措施 阶段 js
<script>
    // 存储编辑器实例的映射
    let solutionEditors = {};
    let currentDivisionId = null; // 当前操作的divisionId

    // 修复模态框关闭不彻底的问题
    function cleanupModalBackdrop() {
        // 移除所有模态框背景遮罩层
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.parentNode.removeChild(backdrop);
        });

        // 恢复页面滚动功能
        document.body.style.overflow = 'auto';
        document.body.style.paddingRight = '0';

        // 移除modal-open类
        document.body.classList.remove('modal-open');
    }

    // 初始化解决措施富媒体编辑器
    function initSolutionEditor(divisionId, index, initialContent = '') {
        const { createEditor, createToolbar } = window.wangEditor;

        const editorConfig = {
            placeholder: '请输入解决措施内容...',
            onChange: (editor) => {
                // 内容变化时更新隐藏字段
                combineSolutionFields(divisionId);
            },
            scroll: true,
            autoFocus: false,
            MENU_CONF: {}
        };

        // 配置上传图片
        editorConfig.MENU_CONF['uploadImage'] = {
            server: '/user/aiVal/upload_pic',
            fieldName: 'file',
            maxFileSize: 5 * 1024 * 1024,
            maxNumberOfFiles: 1,
            async customInsert(res, insertFn) {
                if (res.code == 1) {
                    const imgNode = insertFn(res.url);

                    try {
                        const response = await fetch('/user/aiVal/create_evaluate_image', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                url: res.url
                            })
                        });

                        const result = await response.json();

                        if (result.success && result.id) {
                            console.log('保存图片信息成功:', result.id);
                        } else {
                            console.error('保存图片信息失败:', result.message);
                        }
                    } catch (error) {
                        console.error('调用评估接口失败:', error);
                    }
                } else {
                    alert(res.msg || '上传失败');
                }
            }
        };

        const editorElement = document.querySelector(`#solution-content-${divisionId}-${index}`);

        if (!editorElement) {
            console.error(`未找到编辑器容器元素 #solution-content-${divisionId}-${index}`);
            return null;
        }

        const editor = createEditor({
            selector: `#solution-content-${divisionId}-${index}`,
            config: editorConfig
        });

        // 设置初始内容
        if (initialContent && initialContent.trim() !== '') {
            editor.setHtml(initialContent);
        }

        // 创建工具栏
        createToolbar({
            editor,
            selector: `#solution-toolbar-${divisionId}-${index}`,
            config: {
                toolbarKeys: ['uploadImage'],
                excludeKeys: [
                    'insertVideo',
                    'codeBlock',
                ],
                maxToolbarLength: 10
            }
        });

        // 存储编辑器实例
        const editorKey = `${divisionId}-${index}`;
        solutionEditors[editorKey] = editor;

        return editor;
    }

    // 显示无解决措施警告
    function showNoSolutionWarning(divisionId) {
        $(`#solutionItems-${divisionId}`).html(`
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>没有可编辑的解决措施内容
            </div>
        `);
    }

    // 添加解决措施项
    function addSolutionItem(divisionId, title = '', content = '') {
        const container = $(`#solutionItems-${divisionId}`);
        const itemCount = container.find('.solution-item').length;
        const index = itemCount + 1;

        const newItem = `
            <div class="solution-item mb-3" data-index="${index}">
                <div class="card editor-field">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">${title || `解决措施 ${index}`}</h6>
                        <button type="button" class="remove-tag remove-solution" data-division-id="${divisionId}" data-index="${index}">
                            移除
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="editor-container">
                            <div id="solution-toolbar-${divisionId}-${index}" class="editor-toolbar"></div>
                            <div id="solution-content-${divisionId}-${index}" class="editor-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        container.append(newItem);

        // 初始化编辑器 - 注意：需要等待DOM完全渲染后再初始化
        setTimeout(() => {
            initSolutionEditor(divisionId, index, content || '');
        }, 50);

        // 更新计数器
        updateSolutionCounter(divisionId);
        updateRemoveButtons(divisionId);
        combineSolutionFields(divisionId);
    }

    // 组合解决措施字段
    function combineSolutionFields(divisionId) {
        const solutionData = [];
        const container = $(`#solutionItems-${divisionId}`);

        container.find('.solution-item').each(function() {
            const index = $(this).data('index');
            const $titleEl = $(this).find('.card-header h6');
            const editorKey = `${divisionId}-${index}`;

            if ($titleEl.length && solutionEditors[editorKey]) {
                const title = $titleEl.text().trim();
                const description = solutionEditors[editorKey].getHtml();

                solutionData.push({
                    title: title,
                    description: description
                });
            }
        });

        // 将数据转换为JSON字符串并设置到隐藏的solutions字段
        $(`#solutionCombined-${divisionId}`).val(JSON.stringify(solutionData));
        return solutionData;
    }

    // 更新删除按钮状态
    function updateRemoveButtons(divisionId) {
        const container = $(`#solutionItems-${divisionId}`);
        const itemCount = container.find('.solution-item').length;

        if (itemCount <= 1) {
            container.find('.remove-solution').prop('disabled', true);
        } else {
            container.find('.remove-solution').prop('disabled', false);
        }
    }

    // 更新解决措施计数器
    function updateSolutionCounter(divisionId) {
        const container = $(`#solutionItems-${divisionId}`);
        const itemCount = container.find('.solution-item').length;
        const maxSolutions = 10;

        $(`#solutionCounter-${divisionId}`).text(`${itemCount}/${maxSolutions}`);

        if (itemCount >= maxSolutions) {
            $(`#addSolutionBtn-${divisionId}`).prop('disabled', true);
        } else {
            $(`#addSolutionBtn-${divisionId}`).prop('disabled', false);
        }
    }

    // 从服务端数据或模板初始化解决措施字段
    function initSolutionFromServerDataOrTemplate(divisionId, divisionStatus) {
        const container = $(`#solutionItems-${divisionId}`);
        const $storageElement = $(`#solution-data-storage-${divisionId}`);

        console.log('正在初始化解决措施编辑器，divisionId:', divisionId);
        console.log('storageElement:', $storageElement);

        // 清空容器
        container.empty();

        // 首先尝试从服务端返回的solution_data中获取数据
        let solutionsFromServer = [];
        try {
            // 关键修改：使用 attr() 获取原始属性值，而不是 data()
            const solutionsData = $storageElement.attr('data-solutions');
            console.log('从storage获取的原始数据:', solutionsData);

            if (solutionsData && solutionsData.trim() !== '' && solutionsData !== 'null') {
                // 尝试直接解析JSON
                try {
                    const parsedData = JSON.parse(solutionsData);
                    console.log('直接解析JSON成功:', parsedData);

                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        solutionsFromServer = parsedData;
                    }
                } catch (jsonError) {
                    console.log('直接解析失败，尝试处理HTML实体转义:', jsonError);

                    // 处理 HTML 实体转义
                    const decodedData = solutionsData
                        .replace(/&quot;/g, '"')
                        .replace(/&#39;/g, "'")
                        .replace(/&lt;/g, '<')
                        .replace(/&gt;/g, '>')
                        .replace(/&amp;/g, '&');

                    console.log('解码后的数据:', decodedData);

                    const parsedData = JSON.parse(decodedData);
                    console.log('解码后解析成功:', parsedData);

                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        solutionsFromServer = parsedData;
                    }
                }
            }
        } catch (e) {
            console.error('解析服务端解决措施数据失败:', e);
            console.error('原始数据:', $storageElement.attr('data-solutions'));
        }

        // 优先使用服务端返回的数据
        if (solutionsFromServer.length > 0) {
            console.log('使用服务端返回的解决措施数据，数量:', solutionsFromServer.length);

            // 使用服务端数据初始化编辑器
            solutionsFromServer.forEach((solution, index) => {
                // 确保solution是对象且有title和description属性
                let title = `解决措施 ${index + 1}`;
                let content = '';

                if (typeof solution === 'object' && solution !== null) {
                    title = solution.title || title;
                    content = solution.description || content;
                    console.log(`添加解决措施 ${index + 1}:`, {title, content});
                }

                addSolutionItem(divisionId, title, content);
            });

            // 更新UI状态
            updateSolutionCounter(divisionId);
            updateRemoveButtons(divisionId);
            combineSolutionFields(divisionId);

            return true;
        }

        // 如果没有数据，则加载模板
        return false;
    }

    // 加载解决措施模板
    function loadSolutionTemplate(divisionId) {
        console.log('加载解决措施模板，divisionId:', divisionId);

        fetch('/template/解决措施')
            .then(response => {
                if (!response.ok) {
                    throw new Error('获取解决措施模板失败: ' + response.statusText);
                }
                return response.json();
            })
            .then(templateData => {
                const container = $(`#solutionItems-${divisionId}`);
                container.empty();

                if (templateData.items && templateData.items.length > 0) {
                    templateData.items.forEach((item, index) => {
                        const title = item.content?.title || `解决措施 ${index + 1}`;
                        const description = item.content?.description || '';
                        addSolutionItem(divisionId, title, description);
                    });
                } else {
                    // 如果模板没有数据，添加一个默认的解决措施项
                    addSolutionItem(divisionId, '解决措施 1', '');
                }
            })
            .catch(error => {
                console.error('获取解决措施模板失败:', error);
                const container = $(`#solutionItems-${divisionId}`);
                container.empty();
                // 模板加载失败，添加一个默认的解决措施项
                addSolutionItem(divisionId, '解决措施 1', '');
                showToast('warning', '模板加载失败，已使用默认字段');
            });
    }

    // 初始化解决措施表单
    $(document).ready(function() {
        console.log('初始化解决措施表单...');

        // 初始化所有解决措施表单
        $('.solution-form').each(function() {
            const $form = $(this);
            const divisionId = $form.find('input[name="division_id"]').val();

            console.log('处理divisionId:', divisionId);

            // 获取表单容器
            const $formContainer = $(`#solution-form-container-${divisionId}`);
            const divisionStatus = $formContainer.data('division-status') || '';

            // 尝试使用服务端数据初始化
            const hasServerData = initSolutionFromServerDataOrTemplate(divisionId, divisionStatus);

            // 如果没有数据，则加载模板
            if (!hasServerData) {
                console.log('没有服务端数据，加载模板，divisionId:', divisionId);
                loadSolutionTemplate(divisionId);
            }

            // 添加解决措施按钮点击事件
            $(`#addSolutionBtn-${divisionId}`).click(function() {
                currentDivisionId = divisionId;
                $('#solutionAddFieldModal').modal('show');
            });

            // 移除解决措施项
            $(document).on('click', '.remove-solution', function() {
                const targetDivisionId = $(this).data('division-id');
                const targetIndex = $(this).data('index');

                if (targetDivisionId !== parseInt(divisionId)) return;

                const container = $(`#solutionItems-${divisionId}`);
                const itemCount = container.find('.solution-item').length;

                if (itemCount > 1) {
                    // 销毁编辑器实例
                    const editorKey = `${divisionId}-${targetIndex}`;
                    if (solutionEditors[editorKey]) {
                        solutionEditors[editorKey].destroy();
                        delete solutionEditors[editorKey];
                    }

                    // 移除对应的DOM元素
                    $(this).closest('.solution-item').remove();

                    // 注意：这里移除了重新编号的逻辑，保持剩余项的原有标题
                    // 只更新删除按钮的data-index（如果需要的话，可以保持原样）

                    // 更新UI
                    updateSolutionCounter(divisionId);
                    updateRemoveButtons(divisionId);
                    combineSolutionFields(divisionId);
                }
            });

            // 保存草稿（暂存）
            $(`#saveSolutionDraft-${divisionId}`).click(function() {
                combineSolutionFields(divisionId);
                $(`#isOnlySaveSolution-${divisionId}`).val('true');
                $form.submit();
            });

            // AI自评
            $(`#aiSolution-${divisionId}`).click(function() {
                combineSolutionFields(divisionId);
                $form.append('<input type="hidden" value="self" name="ai_done_act" />');
                $(`#saveSolutionDraft-${divisionId}`).click();
            });

            // 提交审核
            $(`#saveSolution-${divisionId}`).click(function() {
                combineSolutionFields(divisionId);
                $(`#isOnlySaveSolution-${divisionId}`).val('false');

                // 验证所有字段是否已填写
                let hasEmptyField = false;
                const container = $(`#solutionItems-${divisionId}`);
                container.find('.solution-item').each(function() {
                    const index = $(this).data('index');
                    const editorKey = `${divisionId}-${index}`;
                    if (solutionEditors[editorKey]) {
                        if (solutionEditors[editorKey].getText().trim() === '') {
                            hasEmptyField = true;
                        }
                    }
                });

                if (hasEmptyField) {
                    showToast('warning', '请填写所有解决措施内容');
                    return false;
                }

                $form.append('<input type="hidden" value="audit" name="ai_done_act" />');
                $form.submit();
                return true;
            });
        });

        // 模态框确认按钮点击事件
        $('#solutionConfirmAddField').click(function() {
            const title = $('#solutionNewFieldTitle').val().trim();

            if (!title) {
                showToast('warning', '请输入解决措施标题');
                return;
            }

            if (!currentDivisionId) return;

            const container = $(`#solutionItems-${currentDivisionId}`);
            const itemCount = container.find('.solution-item').length;
            const maxSolutions = 10;

            if (itemCount >= maxSolutions) {
                showToast('warning', `最多只能添加${maxSolutions}个解决措施`);
                $('#solutionAddFieldModal').modal('hide');
                return;
            }

            // 添加新字段
            addSolutionItem(currentDivisionId, title, '');

            // 清空模态框输入并关闭
            $('#solutionNewFieldTitle').val('');
            $('#solutionAddFieldModal').modal('hide');
            cleanupModalBackdrop();
        });

        // 模态框关闭时清空输入
        $('#solutionAddFieldModal').on('hidden.bs.modal', function () {
            $('#solutionNewFieldTitle').val('');
            currentDivisionId = null;
            cleanupModalBackdrop();
        });
    });
</script>

<!-- 7、dev_lead_review_solution 阶段的JavaScript代码 -->
<script>
        let selectedRegressionMember = null;
        // 提交审核函数
        function submitSolutionReview(isApproved) {
            // 验证审核意见是否填写
            const reviewNotes = document.getElementById('review_notes_in_review_solution_dialog').value.trim();
            if (!reviewNotes) {
                showToast('warning', '请填写审核意见');
                return;
            }

            if (isApproved) {
                // 如果是同意，需要验证是否选择了测试人员
                if (!selectedRegressionMember) {
                    showToast('warning', '请先搜索并选择一个测试人员');
                    document.getElementById('regressionMemberSearch').focus();
                    return;
                }

                // 设置审核结果和审核意见
                document.getElementById('approved_in_review_solution_dialog').value = "true";
                //document.getElementById('review_notes_in_review_solution_dialog').value = reviewNotes;

                // 提交表单
                document.getElementById('reviewSolutionForm').submit();
                showToast('info', '正在提交审核...', 2000);
            } else {
                // 设置审核结果
                $('#approved_in_review_solution_dialog').val("false");
                // 验证审核意见是否填写
                const reviewNotes = document.getElementById('review_notes_in_review_solution').value.trim();
                if (!reviewNotes) {
                    showToast('warning', '请填写审核意见');
                    return;
                }
                $('#review_notes_in_review_solution_dialog').val(reviewNotes);

                // 提交表单
                document.getElementById('reviewSolutionForm').submit();
            }
        }

        // 成员搜索功能
        document.getElementById('regressionMemberSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const dropdown = document.getElementById('regressionMemberDropdown');

            if (searchTerm.length === 0) {
                selectedRegressionMember = null;
                document.getElementById('selectedRegressionMemberName').innerHTML = '通过Email账号搜索测试人员，此处将会自动填充姓名';
                document.getElementById('selectedRegressionMemberName').classList.remove('has-selection');
                document.getElementById('selectedRegressionMemberName').style.color = '#999';
                dropdown.style.display = 'none';
                return;
            }

            // 搜索匹配的成员
            const matchedMembers = userList.filter(function(member) {
                return member.email.toLowerCase().includes(searchTerm) ||
                       member.name.toLowerCase().includes(searchTerm);
            });

            if (matchedMembers.length > 0) {
                // 生成下拉框内容
                let dropdownHtml = '';
                matchedMembers.forEach(function(member) {
                    dropdownHtml += `
                        <div class="member-dropdown-item"
                             data-userid="${member.user_id}"
                             data-email="${member.email}"
                             data-name="${member.name}"
                             data-department="${member.department}">
                            <div><strong>${member.name}</strong> / ${member.email}</div>
                            <small class="text-muted">${member.department}</small>
                        </div>`;
                });

                dropdown.innerHTML = dropdownHtml;
                dropdown.style.display = 'block';
            } else {
                selectedRegressionMember = null;
                document.getElementById('selectedRegressionMemberName').innerHTML = '未找到匹配的测试人员';
                document.getElementById('selectedRegressionMemberName').classList.remove('has-selection');
                document.getElementById('selectedRegressionMemberName').style.color = '#ff6b6b';
                dropdown.style.display = 'none';
            }
        });

        // 下拉框选项点击事件
        document.addEventListener('click', function(e) {
            if (e.target.closest('.member-dropdown-item')) {
                const item = e.target.closest('.member-dropdown-item');
                const email = item.getAttribute('data-email');
                const name = item.getAttribute('data-name');
                const userID = item.getAttribute('data-userid');
                const department = item.getAttribute('data-department');

                // 设置选中的成员
                selectedRegressionMember = {
                    userID: userID,
                    email: email,
                    name: name,
                    department: department
                };

                // 填充输入框和姓名显示
                document.getElementById('regressionMemberSearch').value = email;
                document.getElementById('regressionMember_id').value = userID;
                const nameElement = document.getElementById('selectedRegressionMemberName');
                nameElement.innerHTML = `${name} (${department})`;
                nameElement.classList.add('has-selection');
                nameElement.style.color = '#222';

                // 隐藏下拉框
                document.getElementById('regressionMemberDropdown').style.display = 'none';

                // 显示成功消息
                showToast('success', `已选择人员: ${name}`);
            }

            // 点击其他地方隐藏下拉框
            if (!e.target.closest('#regressionMemberSearch') && !e.target.closest('#regressionMemberDropdown')) {
                document.getElementById('regressionMemberDropdown').style.display = 'none';
            }
        });

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 添加一些示例交互
            document.getElementById('regressionMemberSearch').addEventListener('focus', function() {
                if (this.value.length > 0) {
                    document.getElementById('regressionMemberDropdown').style.display = 'block';
                }
            });
        });
    </script>


<!-- 8、tester_regression 测试人员回归测试 阶段（提交回归结果）的JavaScript代码 -->
<script>
    $(document).ready(function() {
        const TESTER_REGRESSION_MODE = "{{ tester_regression_mode }}";
        let descriptionCount = 0; // 初始描述项数量
        const maxDescriptions = 10;
        // 存储编辑器实例的对象
        const editorInstances = {};
        let nextIndex = 0; // 用于生成唯一索引

        // 修复模态框关闭不彻底的问题
        function cleanupModalBackdrop() {
            // 移除所有模态框背景遮罩层
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                backdrop.parentNode.removeChild(backdrop);
            });

            // 恢复页面滚动功能
            document.body.style.overflow = 'auto';
            document.body.style.paddingRight = '0';

            // 移除modal-open类
            document.body.classList.remove('modal-open');
        }

        // 初始化wangEditor
        function initEditor(editorId, initialContent = '') {
             if (!document.getElementById( `editor-${editorId}`)) {
                 return  false
             }
            const { createEditor, createToolbar } = window.wangEditor;

            const editorConfig = {
                placeholder: '请输入内容...',
                onChange: (editor) => {
                    // 内容变化时更新隐藏字段
                    combineDescriptionFields();
                },
                MENU_CONF: {}
            };

            // 配置上传图片
            editorConfig.MENU_CONF['uploadImage'] = {
                server: '/user/aiVal/upload_pic', // 替换为你的图片上传接口地址
                fieldName: 'file', // 上传文件的字段名（与后端一致）
                maxFileSize: 5 * 1024 * 1024, // 5MB
                maxNumberOfFiles: 1, // 最多上传 5 张图片
                async customInsert(res, insertFn) { // 添加 async 关键字
                    if (res.code == 1) {
                        // 先插入图片到编辑器
                        const imgNode = insertFn(res.url);

                        try {
                            // 调用评估接口将图片URL存入数据库
                            const response = await fetch('/user/aiVal/create_evaluate_image', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    url: res.url
                                })
                            });

                            const result = await response.json();

                            if (result.success && result.id) {
                                // 将返回的ID存储到图片元素的data-id属性中
                                console.log('保存图片信息成功:', result.id);

                                // 如果需要设置图片元素的data-id属性，可以这样操作：
                                // imgNode.setAttribute('data-id', result.id);
                            } else {
                                console.error('保存图片信息失败:', result.message);
                            }
                        } catch (error) {
                            console.error('调用评估接口失败:', error);
                        }
                    } else {
                        showToast('error', '上传失败');
                    }
                }
            };

            const editor = createEditor({
                selector: `#editor-${editorId}`,
                config: editorConfig,
                html: initialContent || ''
            });

            // 创建工具栏
            createToolbar({
                editor,
                selector: `#toolbar-${editorId}`,
                config: {
                    toolbarKeys: ['uploadImage'],
                    excludeKeys: [
                        'insertVideo',
                        'codeBlock',
                    ]
                }
            });

            return editor;
        }

        // 显示无描述警告
        function showNoDescriptionWarning() {
            document.getElementById('descriptionItems').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>没有可编辑的描述内容
                </div>
            `;
        }

        function generateDescriptionFields(items) {
            $('#descriptionItems').empty();
            descriptionCount = 0;
            nextIndex = 0; // 重置索引计数器

            if (items && items.length > 0) {
                items.forEach((item) => {
                    addDescriptionField(item.title, item.description);
                });
                updateDescriptionCounter();
            } else {
                showNoDescriptionWarning();
            }
        }

        // 从API获取模板数据并初始化描述字段
        function initDescriptionFromTemplate() {
            if (TESTER_REGRESSION_MODE === "update") {
                const TEST_RESULT_DATA = {{ test_result_data | tojson | safe if test_result_data else 'null' }};
                let descriptionItems = [];
                try {
                    if (TEST_RESULT_DATA && TEST_RESULT_DATA[0].content && TEST_RESULT_DATA[0].content.description) {
                        descriptionItems = JSON.parse(TEST_RESULT_DATA[0].content.description);
                        generateDescriptionFields(descriptionItems);
                    } else {
                        showNoDescriptionWarning();
                    }
                } catch (e) {
                    console.error('解析描述数据失败:', e);
                    showNoDescriptionWarning();
                }
            } else {
                fetch('/template/回归测试')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('获取模板失败: ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(templateData => {
                        $('#descriptionItems').empty();
                        descriptionCount = 0;
                        nextIndex = 0;

                        if (templateData.items && templateData.items.length > 0) {
                            templateData.items.forEach((item) => {
                                addDescriptionField(item.content.title, "");
                            });
                        } else {
                            addDefaultDescriptionFields();
                        }

                        updateDescriptionCounter();


                    })
                    .catch(error => {
                        console.error('获取模板失败:', error);
                        $('#descriptionItems').empty();
                        descriptionCount = 0;
                        nextIndex = 0;
                        addDefaultDescriptionFields();
                        updateDescriptionCounter();
                        showToast('warning', '模板加载失败，已使用默认字段');
                    });
            }
        }

        // 添加默认的描述字段
        function addDefaultDescriptionFields() {
            const defaultFields = [
                { title: "测试环境", placeholder: "请描述发现缺陷的具体环境，和软硬件等具体的测试版本" },
                { title: "操作步骤和预期结果", placeholder: "触发缺陷产生的操作步骤和预期结果" },
                { title: "实际测试结果与结论", placeholder: "实际测试结果与结论" }
            ];

            defaultFields.forEach((field) => {
                addDescriptionField(field.title, field.placeholder);
            });
        }

        // 添加描述字段
        function addDescriptionField(title, description) {
            const index = nextIndex++;
            const newItem = `
                <div class="description-item mb-3" data-index="${index}">
                    <div class="card editor-field">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">${title}</h6>
                            <button type="button" class="remove-tag remove-description" data-index="${index}">
                                移除
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="editor-container">
                                <div id="toolbar-${index}" class="editor-toolbar"></div>
                                <div id="editor-${index}" class="editor-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#descriptionItems').append(newItem);

            // 初始化编辑器
            setTimeout(() => {
                editorInstances[index] = initEditor(index, description);
            }, 100);

            descriptionCount++;
            updateRemoveButtons();
            updateDescriptionCounter();
        }

        // 组合描述字段
        function combineDescriptionFields() {
            const descriptionData = [];

            $('.description-item').each(function() {
                const index = $(this).data('index');
                const $titleEl = $(this).find('.card-header h6');

                if ($titleEl.length && editorInstances[index]) {
                    const title = $titleEl.text().trim();
                    const description = editorInstances[index].getHtml();

                    descriptionData.push({
                        title: title,
                        description: description
                    });
                }
            });

            // 将数据转换为JSON字符串并设置到隐藏的description字段
            document.getElementById('regressionDescription').value = JSON.stringify(descriptionData);
            return descriptionData;
        }

        // 更新删除按钮状态
        function updateRemoveButtons() {
            if (descriptionCount === 1) {
                $('.remove-description').prop('disabled', true);
            } else {
                $('.remove-description').prop('disabled', false);
            }
        }

        // 更新描述计数器
        function updateDescriptionCounter() {
            $('#descriptionCounter').text(`${descriptionCount}/${maxDescriptions}`);

            if (descriptionCount >= maxDescriptions) {
                $('#addDescription').prop('disabled', true);
            } else {
                $('#addDescription').prop('disabled', false);
            }
        }

        // 移除缺陷描述项
        $(document).on('click', '.remove-description', function() {
            if (descriptionCount > 1) {
                const index = $(this).data('index');

                // 销毁编辑器实例
                if (editorInstances[index]) {
                    editorInstances[index].destroy();
                    delete editorInstances[index];
                }

                $(this).closest('.description-item').remove();
                descriptionCount--;

                updateRemoveButtons();
                updateDescriptionCounter();
                combineDescriptionFields();
            }
        });

        // 模态框确认按钮点击事件
        $('#regressionConfirmAddField').click(function() {
            const title = $('#regressionNewFieldTitle').val().trim();

            if (!title) {
                showToast('warning', '请输入字段标题');
                return;
            }

            if (descriptionCount >= maxDescriptions) {
                showToast('warning', `最多只能添加${maxDescriptions}个缺陷描述`);
                $('#regressionAddDescriptionModal').modal('hide');
                return;
            }

            // 添加新字段
            addDescriptionField(title, '');
            combineDescriptionFields();

            // 清空模态框输入并关闭
            $('#regressionNewFieldTitle').val('');
            $('#regressionAddDescriptionModal').modal('hide');
            cleanupModalBackdrop();
        });



        // 在表单提交前组合所有模板字段内容
        const form = document.getElementById('regressionTestForm');
        if (form){
                // 保存草稿
                $('#saveDraftRegressionTestBtn').click(function() {
                    // 设置暂存标识
                    $('#isOnlySaveRegressionTest').val('true');
                    combineDescriptionFields();
                    // 这里可以实现保存草稿的逻辑
                    form.submit();
                });
                $('#aiRegressionTest').click(function() {
                    $('#regressionTestForm').append('<input type="hidden" value="self" name="ai_done_act" />')
                    $('#saveDraftRegressionTestBtn').click()
                })

            // 提交审核
            $('#submitRegressionTestBtn').click(function() {
                // 组合所有模板字段内容
                combineDescriptionFields();

                // 验证所有字段是否已填写
                let hasEmptyField = false;
                Object.values(editorInstances).forEach(editor => {
                    if (editor.getText().trim() === '') {
                        hasEmptyField = true;
                    }
                });

                if (hasEmptyField) {
                    e.preventDefault();
                    showToast('warning', '请填写所有描述字段内容');
                    return false;
                }
                form.submit();
            });
        }

        // 初始化描述字段
        initDescriptionFromTemplate();

        // 模态框关闭时清空输入
        $('#regressionAddDescriptionModal').on('hidden.bs.modal', function () {
            $('#regressionNewFieldTitle').val('');
            cleanupModalBackdrop();
        });
    });
</script>

<!-- 9、test_manager_review_regression 阶段的JavaScript代码 -->
<script>
function submitRegressionReview(isApproved) {
    // 验证审核意见是否填写
    const reviewNotes = document.getElementById('review_notes_in_review_regression').value.trim();
    if (!reviewNotes) {
        showToast('warning', '请填写审核意见');
        return;
    }

    // 设置审核结果
    document.getElementById('approved_in_review_regression').value = isApproved;

    // 设置确认消息
    const confirmMessage = isApproved
        ? '确认要通过回归测试结果吗？'
        : '确认要驳回回归测试结果给测试人员吗？';

    document.getElementById('confirmMessage').textContent = confirmMessage;

    // 显示确认模态框
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmReviewModal'));
    confirmModal.show();

    // 设置确认按钮的点击事件
    document.getElementById('confirmSubmit').onclick = function() {
        document.getElementById('reviewRegressionForm').submit();
    };
}
</script>

<!-- 10、requester_confirm 阶段的JavaScript代码 -->
<script>
function submitRequesterConfirm(isConfirmed) {
    // 验证确认意见是否填写
    const confirmNotes = document.getElementById('confirm_notes').value.trim();
    if (!confirmNotes) {
        showToast('warning', '请填写确认意见');
        return;
    }

    // 设置确认结果
    document.getElementById('confirmed').value = isConfirmed;

    // 设置确认消息
    const confirmMessage = isConfirmed
        ? '确认要标记此缺陷为已解决吗？'
        : '确认要驳回此缺陷解决结果吗？';

    document.getElementById('confirmRequesterMessage').textContent = confirmMessage;

    // 显示确认模态框
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmRequesterModal'));
    confirmModal.show();

    // 设置确认按钮的点击事件
    document.getElementById('confirmRequesterSubmit').onclick = function() {
        document.getElementById('requesterConfirmForm').submit();
    };
}
</script>

<!-- 转处理功能的JavaScript代码 -->
<script>
$(document).ready(function() {
    // 当选择用户时自动填充邮箱
    $('#transfer_user').change(function() {
        const selectedOption = $(this).find('option:selected');
        const email = selectedOption.data('email');
        $('#transfer_email').val(email || '');
    });

});

</script>


<!--复制缺陷单的处理脚本-->
<script>
// 复制缺陷单的处理脚本
$(document).ready(function() {
    let projectCount = 1;

    // 移除项目表单
    $(document).on('click', '.remove-project', function() {
        if ($('.project-form').length > 1) {
            $(this).closest('.project-form').remove();
            projectCount--;
            updateRemoveButtons();
        }
    });

    // 更新移除按钮状态
    function updateRemoveButtons() {
        if ($('.project-form').length === 1) {
            $('.remove-project').prop('disabled', true);
        } else {
            $('.remove-project').prop('disabled', false);
        }
    }

    // 验证是否已选择项目
    function validateProjectSelection() {
        if (!$('#project_version_id').val()) {
            showToast('warning', '请选择缺陷所属产品线/技术族');
            // 滚动到树形选择器
            $('#tree-selector').get(0).scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
            return false;
        }
        return true;
    }

    // 表单提交处理 - 使用fetch调用API
    $('#copyDefectForm').submit(async function(e) {
        e.preventDefault();

        // 验证产品线选择
        if (!validateProjectSelection()) {
            return;
        }

        const project_version_id = $('#project_version_id').val();
        const csrf_token = $('input[name="csrf_token"]').val();
        const source_defect_id = {{ defect.id }}; // 从模板变量获取源缺陷ID

        // 显示加载状态
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.text();
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 提交中...');

        try {
            // 构建请求数据
            const requestData = {
                project_version_id: project_version_id
            };

            // 使用fetch调用API
            const response = await fetch(`/defect/api/${source_defect_id}/copy`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrf_token,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            // 解析响应数据
            const data = await response.json();

            if (response.ok && data.success) {
                showToast('success', data.message);
                // 关闭模态框
                $('#copyDefectModal').modal('hide');

                // 可选：刷新页面或更新缺陷列表
                // window.location.reload();
                // 或者调用其他更新函数

                // 显示复制成功的信息，包含新缺陷ID
                setTimeout(() => {
                    showToast('success', `复制成功！新缺陷单单号: ${data.data.new_defect_num}`);
                    loadDuplicateDefects(); // 局部刷新显示信息
                }, 500);
            } else {
                // 处理业务逻辑错误
                let errorMessage = data.message || '复制失败';

                // 根据错误代码显示特定消息
                if (data.error_code === 'MISSING_PROJECT_VERSION') {
                    errorMessage = '请选择项目版本';
                } else if (data.error_code === 'INVALID_PROJECT_VERSION_FORMAT') {
                    errorMessage = '项目版本格式错误';
                } else if (data.error_code === 'COPY_FAILED') {
                    errorMessage = '复制操作失败，请稍后重试';
                }

                showToast('error', errorMessage);
                // 恢复按钮状态
                submitBtn.prop('disabled', false).text(originalText);
            }

        } catch (error) {
            // 处理网络错误
            console.error('复制缺陷单时发生错误:', error);
            let errorMessage = '网络错误，请检查网络连接后重试';

            showToast('error', errorMessage);
            // 恢复按钮状态
            submitBtn.prop('disabled', false).text(originalText);
        }
    });

    // 动态加载重复缺陷信息
    function loadDuplicateDefects() {
        const defectId = {{defect.id}}
        if (!defectId) {
            console.error('无法获取缺陷ID');
            return;
        }

        // 显示加载状态
        const container = document.getElementById('duplicateDefectsContainer');
        container.innerHTML = '<div class="loading">加载中...</div>';

        // 发送AJAX请求
        fetch(`/defect/api/${defectId}/duplicates`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateDuplicateDefectsList(data.data);
                } else {
                    throw new Error('获取数据失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                container.innerHTML = '<div class="error">加载失败，请刷新页面重试</div>';
            });
    }


    // 更新重复缺陷列表
    function updateDuplicateDefectsList(duplicateInfos) {
        // 同时更新数量
        $('#duplicate_defects_infos_length').text('本缺陷单已被复制至以下项目（' + duplicateInfos.length + '）：');
        const container = document.getElementById('duplicateDefectsContainer');

        if (!duplicateInfos || duplicateInfos.length === 0) {
            container.innerHTML = '<div class="no-data">暂未复制到其他项目</div>';
            return;
        }

        let html = '';
        duplicateInfos.forEach((item, index) => {
            html += `
                <div class="defect-item">
                    <p>
                        <span>${index + 1}、${item.type}：${item.project_version_name}&nbsp;&nbsp;&nbsp;&nbsp;缺陷单号：<a class="defect-link" href="/defect/${item.id}">${item.defect_number}</a></span>
                    </p>
                </div>
            `;
        });

        container.innerHTML = html;
    }


    // 模态框关闭时重置表单
    $('#copyDefectModal').on('hidden.bs.modal', function () {
        $('#copyDefectForm')[0].reset();
        const submitBtn = $('#copyDefectForm').find('button[type="submit"]');
        submitBtn.prop('disabled', false).text('提交复制');
    });
});
</script>

<!--邀共同定位功能处理脚本-->
<script>
// 用户数据
<!--let userList = {{ user_list | tojson }};-->

// 获取所有已选择的用户ID
function getSelectedUserIds() {
    const selectedIds = [];
    document.querySelectorAll('.invitee-item').forEach(item => {
        const idInput = item.querySelector('.invitee-id');
        if (idInput && idInput.value) {
            selectedIds.push(idInput.value);
        }
    });
    return selectedIds;
}

// 为邀请共同定位模态框设置自动完成功能
function setupAutocompleteForInviteeItem(inviteeItem) {
    const searchInput = inviteeItem.querySelector('.invitee-search');
    const dropdown = inviteeItem.querySelector('.invitee-dropdown');
    const nameDisplay = inviteeItem.querySelector('.selected-invitee-name');
    const idInput = inviteeItem.querySelector('.invitee-id');
    const emailInput = inviteeItem.querySelector('.invitee-email');
    const nameInput = inviteeItem.querySelector('.invitee-name');
    const removeBtn = inviteeItem.querySelector('.remove-invitee-btn');
    const currentSelectedId = idInput.value;

    // 为搜索框添加自动完成功能
    searchInput.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        dropdown.innerHTML = '';

        if (value.length < 1) {
            dropdown.style.display = 'none';
            return;
        }

        // 获取已选择的用户ID（排除当前项已选择的用户和当前登录用户——自己）
        const current_user_id = {{ current_user.user_id if current_user else 'null' }};
        const selectedIds = getSelectedUserIds();
        const currentIndex = selectedIds.indexOf(currentSelectedId);
        if (currentIndex > -1) {
            selectedIds.splice(currentIndex, 1);
        }

        // 过滤匹配的用户（排除已选择的用户和当前用户）
        const matches = userList.filter(user =>
            !selectedIds.includes(user.user_id.toString()) &&
            user.user_id.toString() !== current_user_id.toString() && (
                (user.email && user.email.toLowerCase().includes(value)) ||
                (user.name && user.name.toLowerCase().includes(value))
            )
        );

        if (matches.length === 0) {
            dropdown.innerHTML = '<div style="padding: 8px 12px; color: #999;">未找到匹配的用户</div>';
            dropdown.style.display = 'block';
            return;
        }

        // 显示匹配结果
        matches.forEach(user => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.style.padding = '8px 12px';
            item.style.cursor = 'pointer';
            item.style.borderBottom = '1px solid #f0f0f0';

            item.innerHTML = `
                <div style="font-weight: 500;">${user.name || ''}</div>
                <small style="color: #666;">${user.email || ''}</small>
            `;

            item.addEventListener('click', function() {
                searchInput.value = user.email;
                nameDisplay.textContent = user.name;
                nameDisplay.style.color = '#222';
                idInput.value = user.user_id;
                emailInput.value = user.email;
                nameInput.value = user.name;
                dropdown.style.display = 'none';

                // 更新所有下拉列表，排除已选择的用户
                updateAllDropdowns();
            });

            dropdown.appendChild(item);
        });

        dropdown.style.display = 'block';
    });

    // 点击外部时隐藏下拉框
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    // 搜索框失去焦点时短暂延迟后隐藏下拉框
    searchInput.addEventListener('blur', function() {
        setTimeout(() => {
            dropdown.style.display = 'none';
        }, 200);
    });
}

// 更新所有下拉列表，排除已选择的用户
function updateAllDropdowns() {
    document.querySelectorAll('.invitee-item').forEach(item => {
        const searchInput = item.querySelector('.invitee-search');
        if (searchInput) {
            // 触发输入事件以刷新下拉列表
            const event = new Event('input', { bubbles: true });
            searchInput.dispatchEvent(event);
        }
    });
}

// DOM加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    // 初始化已有的被邀请人项的自动完成
    document.querySelectorAll('.invitee-item').forEach(setupAutocompleteForInviteeItem);

    let inviteeCount = 1;

    // 添加被邀请人
    $('#addInvitee').click(function() {
        inviteeCount++;
        const newItem = $(`
            <div class="invitee-item" data-item-index="${inviteeCount}">
                <!-- 人员搜索区域和姓名显示区域（同一行） -->
                <div style="text-align: right; margin-bottom: 10px;">
                   <button type="button" class="remove-tag1 remove-invitee-btn">移除</button>
                </div>
                <div class="d-flex justify-content-between" style="margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1; margin-right: 20px;">
                        <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">
                            <span style="color: red;">*</span> 请选择处理人的 Email 账号，平台将会通知他
                        </label>
                        <div style="position: relative;">
                            <input type="text" class="form-control invitee-search" placeholder="搜索成员" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px 40px 12px 12px;font-size: 14px;background-color: #F6FAFF;">
                            <img src="/static/images/search-icon.svg" alt="搜索" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);width: 16px;height: 16px;">
                            <!-- 下拉框 -->
                            <div class="invitee-dropdown" style="display: none;position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #E9EFF8;border-top: none;border-radius: 0 0 6px 6px;box-shadow: 0 4px 8px rgba(0,0,0,0.1);z-index: 1000;max-height: 200px;overflow-y: auto;">
                                <!-- 动态生成搜索结果 -->
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="width: 50%;">
                        <label style="font-family: PingFang SC;font-weight: 400;font-size: 14px;line-height: 20px;color:#557496;margin-bottom: 12px;">姓名</label>
                        <div class="selected-invitee-name" style="width: 100%;height: 40px;border: 1px solid #E9EFF8;border-radius: 6px;padding: 12px;font-size: 14px;background-color: #F6FAFF;color: #999;display: flex;align-items: center;">
                            通过Email账号搜索成员，此处将会自动填充姓名
                        </div>
                    </div>
                </div>

                <!-- 原因输入区域 -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="label-style"><span style="color: red;">*</span> 原因</label>
                    <textarea class="invitee-reason text-area-border" placeholder="请输入"></textarea>
                </div>
                <input type="hidden" class="invitee-id">
                <input type="hidden" class="invitee-email">
                <input type="hidden" class="invitee-name">
            </div>
        `);

        $('#inviteeMembersContainer').append(newItem);

        // 为新添加的项目设置自动完成
        setupAutocompleteForInviteeItem(newItem[0]);

        // 更新计数
        $('#inviteeCount').text(inviteeCount);
        updateRemoveButtons();
    });

    // 移除被邀请人
    $(document).on('click', '.remove-invitee-btn', function() {
        if ($('.invitee-item').length > 1) {
            $(this).closest('.invitee-item').remove();
            inviteeCount--;
            $('#inviteeCount').text(inviteeCount);
            updateRemoveButtons();

            // 更新所有下拉列表，因为已选择的用户减少了
            updateAllDropdowns();
        }
    });

    // 更新移除按钮状态
    function updateRemoveButtons() {
        if ($('.invitee-item').length === 1) {
            $('.remove-invitee-btn').hide();
        } else {
            $('.remove-invitee-btn').show();
        }
    }

    // 初始化移除按钮状态
    updateRemoveButtons();

    // 表单提交处理
    $('#inviteDevelopersForm').submit(function(e) {
        e.preventDefault();

        const invitees = [];
        let isValid = true;
        const selectedIds = new Set(); // 用于检查重复

        $('.invitee-item').each(function(index) {
            const inviteeId = $(this).find('.invitee-id').val();
            const inviteeName = $(this).find('.invitee-name').val();
            const inviteeEmail = $(this).find('.invitee-email').val();
            const reviewNotes = $(this).find('.invitee-reason').val();

            if (!inviteeId || !inviteeName || !inviteeEmail) {
                isValid = false;
                showToast('warning', `请为第${index + 1}个被邀请人选择有效的开发人员`);
                return false; // 退出循环
            }

            // 检查重复邀请
            if (selectedIds.has(inviteeId)) {
                isValid = false;
                showToast('warning', `用户 ${inviteeName} (${inviteeEmail}) 已被重复邀请，请检查`);
                return false; // 退出循环
            }
            selectedIds.add(inviteeId);

            if (!reviewNotes) {
                isValid = false;
                showToast('warning', `请为第${index + 1}个被邀请人填写邀请原因`);
                return false; // 退出循环
            }

            invitees.push({
                invitee_id: inviteeId,
                review_notes: reviewNotes
            });
        });

        if (!isValid) return false;

        // 设置隐藏字段值
        $('#inviteesData').val(JSON.stringify(invitees));

        // 提交表单
        this.submit();
    });
});
</script>

<!-- 驳回流程（通用）表单验证脚本 -->
<script>
    // 获取被勾选的邀请ID列表
    function getSelectedInvitationIds() {
        const selectedInvitations = [];

        // 获取所有checkbox元素
        const checkboxes = document.querySelectorAll('#multiAnalysisForm .form-check-input');

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                // 获取checkbox的id，即invitation id
                selectedInvitations.push(checkbox.id);
            }
        });

        return selectedInvitations;
    }

    // 获取被勾选的解决措施分工ID列表
    function getSelectedDivisionIds() {
        const selectedDivisionIds = [];

        // 获取所有checkbox元素
        const checkboxes = document.querySelectorAll('#allSolutionDivisions .form-check-input');

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                // 获取checkbox的id，即invitation id
                selectedDivisionIds.push(checkbox.id);
            }
        });

        return selectedDivisionIds;
    }

    // 多人原因分析驳回，根据所勾选的项进行驳回
    const currentStageType = {{ current_stage.stage_type | tojson if current_stage else 'null' }};
    const invitationItems = document.getElementsByClassName('invitation-analysis-item');
    const itemCount = invitationItems ? invitationItems.length : 0;

    // 多人解决措施的驳回，根据所勾选的项进行驳回
    const divisionItems = document.getElementsByClassName('division-card');
    const divisionItemCount = divisionItems ? divisionItems.length : 0;

    var modalElement = document.getElementById('rejectModal');
    var modal = new bootstrap.Modal(modalElement);
    document.addEventListener('DOMContentLoaded', function() {
        // 获取驳回按钮元素
        var rejectAnalysisButton = document.getElementById('rejectAnalysisButton');
        var rejectSolutionsButton = document.getElementById('rejectSolutionsButton');

        // 为原因分析驳回按钮添加点击事件监听器
        if (rejectAnalysisButton && currentStageType === "dev_lead_review_analysis") {
            rejectAnalysisButton.addEventListener('click', function(event) {
                // 多人分析的驳回 - 在打开模态框前检查
                if (itemCount > 1) {
                    const selectedIds = getSelectedInvitationIds();
                    if (selectedIds.length === 0){
                        // 直接显示提示，不显示模态框
                        showToast('warning', '请选择需要驳回的原因分析项！' );
                        return;
                    }
                    console.log("选中的邀请ID列表:", selectedIds);

                    // 设置选中的ID到隐藏字段中
                    document.getElementById('selectedInvitationIds').value = selectedIds.join(',');
                }

                // 验证通过，手动显示模态框
                modal.show();
            });
        }

        // 为解决措施驳回按钮添加点击事件监听器
        if (rejectSolutionsButton && currentStageType === "dev_lead_review_solution") {
            rejectSolutionsButton.addEventListener('click', function(event) {
                // 多人解决措施的驳回 - 在打开模态框前检查
                if (divisionItemCount > 1) {
                    const selectedIds = getSelectedDivisionIds();
                    if (selectedIds.length === 0){
                        // 直接显示提示，不显示模态框
                        showToast('warning', '请选择需要驳回的解决措施！' );
                        return;
                    }
                    console.log("选中的分工ID列表:", selectedIds);

                    // 设置选中的ID到隐藏字段中
                    document.getElementById('selectedDivisionIds').value = selectedIds.join(',');
                }

                // 验证通过，手动显示模态框
                modal.show();
            });
        }

        // 获取表单元素
        var rejectForm = document.getElementById('rejectForm');

        // 添加提交事件监听器
        rejectForm.addEventListener('submit', function(event) {
            // 获取驳回原因输入值
            var rejectReason = document.getElementById('rejectReason').value.trim();
            console.log("当前阶段类型: ", currentStageType);

            // 多人分析的驳回 - 表单提交时再次检查（作为安全备份）
            if (currentStageType === "dev_lead_review_analysis" && itemCount > 1) {
                const selectedIds = getSelectedInvitationIds();
                if (selectedIds.length === 0){
                    // 阻止表单提交
                    event.preventDefault();
                    showToast('warning', '请选择需要驳回的原因分析项！' );
                    return;
                }
                console.log("选中的邀请ID列表:", selectedIds);

                // 设置选中的ID到隐藏字段中
                document.getElementById('selectedInvitationIds').value = selectedIds.join(',');
            }

            // 检查驳回原因是否为空
            if (!rejectReason) {
                // 阻止表单提交
                event.preventDefault();
                // 显示警告
                showToast('warning', '驳回原因不能为空，请填写驳回原因后再提交！' );
                // 焦点定位到文本域
                document.getElementById('rejectReason').focus();
            } else {
                // 表单正常提交
                showToast('success', '驳回操作已经执行！' );
                // 隐藏模态框
                modal.hide();
            }
        });
    });
</script>

<!--驳回(原因分析)邀请模态框处理 的处理脚本-->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const rejectInviteModal = document.getElementById('rejectInviteModal');

    // 监听模态框显示事件
    rejectInviteModal.addEventListener('show.bs.modal', function (event) {
        // 获取触发模态框的按钮
        const button = event.relatedTarget;
        // 从按钮获取邀请ID
        const invitationId = button.getAttribute('data-invitation-id');

        // 设置表单的action
        const form = document.getElementById('rejectInviteForm');
        form.action = "{{ url_for('defect.reject_locale_invitation', invitation_id=0) }}".replace('0', invitationId);
    });
});


// 驳回单个原因分析模态框处理
document.addEventListener('DOMContentLoaded', function() {
    const rejectSingleAnalysisModal = document.getElementById('rejectSingleAnalysisModal');

    // 监听模态框显示事件
    rejectSingleAnalysisModal.addEventListener('show.bs.modal', function (event) {
        // 获取触发模态框的按钮
        const button = event.relatedTarget;
        // 从按钮获取邀请ID
        const invitationId = button.getAttribute('data-invitation-id');

        // 设置表单的action
        const form = document.getElementById('rejectSingleAnalysisForm');
        form.action = "{{ url_for('defect.reject_single_analysis', invitation_id=0) }}".replace('0', invitationId);
    });
});

// 弃用单个原因分析模态框处理
document.addEventListener('DOMContentLoaded', function() {
    const cancelSingleAnalysisModal = document.getElementById('cancelSingleAnalysisModal');

    // 监听模态框显示事件
    cancelSingleAnalysisModal.addEventListener('show.bs.modal', function (event) {
        // 获取触发模态框的按钮
        const button = event.relatedTarget;
        // 从按钮获取邀请ID
        const invitationId = button.getAttribute('data-invitation-id');

        // 设置表单的action
        const form = document.getElementById('cancelSingleAnalysisForm');
        form.action = "{{ url_for('defect.cancel_single_analysis', invitation_id=0) }}".replace('0', invitationId);
    });
});

// 跟催单个原因分析模态框处理
document.addEventListener('DOMContentLoaded', function() {
    const remindSingleAnalysisModal = document.getElementById('remindSingleAnalysisModal');
    const form = document.getElementById('remindSingleAnalysisForm');
    const reasonTextarea = document.getElementById('remind_reason_of_analysis');
    const reasonError = document.getElementById('reason-error');
    const warningToast = new bootstrap.Toast(document.getElementById('warningToast'), { delay: 4000 });

    // 监听模态框显示事件
    remindSingleAnalysisModal.addEventListener('show.bs.modal', function (event) {
        // 获取触发模态框的按钮
        const button = event.relatedTarget;
        // 从按钮获取邀请ID
        const invitationId = button.getAttribute('data-invitation-id');

        // 设置表单的action
        form.action = "{{ url_for('defect.send_invitation_reminder', invitation_id=0) }}".replace('0', invitationId);

        // 重置表单和错误状态
        form.reset();
        reasonTextarea.classList.remove('error');
    });

    // 监听输入框输入事件，实时移除错误状态
    reasonTextarea.addEventListener('input', function() {
        if (this.value.trim()) {
            this.classList.remove('error');
        }
    });

    // 表单提交事件
    form.addEventListener('submit', function(event) {
        // 阻止表单默认提交行为
        event.preventDefault();

        // 验证跟催原因
        if (!reasonTextarea.value.trim()) {
            // 显示错误样式
            reasonTextarea.classList.add('error');

            // 显示警告提示
            showToast('warning', '跟催原因不能为空，请输入后再提交');
            return false;
        }
        // 如果验证通过，提交表单
        form.submit();

        // 模拟成功提交
        showToast('info', '跟催邮件和跟催消息已发送...', 3000);
        bootstrap.Modal.getInstance(remindSingleAnalysisModal).hide();
    });


});


// 驳回单个解决措施模态框处理
document.addEventListener('DOMContentLoaded', function() {
    const rejectSingleSolutionModal = document.getElementById('rejectSingleSolutionModal');

    // 监听模态框显示事件
    rejectSingleSolutionModal.addEventListener('show.bs.modal', function (event) {
        // 获取触发模态框的按钮
        const button = event.relatedTarget;
        // 从按钮获取邀请ID
        const divisionId = button.getAttribute('data-division-id');

        // 设置表单的action
        const form = document.getElementById('rejectSingleSolutionForm');
        form.action = "{{ url_for('defect.reject_single_solution', division_id=0) }}".replace('0', divisionId);
    });
});

// 跟催单个解决措施模态框处理
document.addEventListener('DOMContentLoaded', function() {
    const remindSingleSolutionModal = document.getElementById('remindSingleSolutionModal');
    const form = document.getElementById('remindSingleSolutionForm');
    const reasonTextarea = document.getElementById('remind_reason_of_solution');
    const submitButton = document.getElementById('remind_of_solution_submit');

    // 监听模态框显示事件
    remindSingleSolutionModal.addEventListener('show.bs.modal', function (event) {
        // 获取触发模态框的按钮
        const button = event.relatedTarget;
        // 从按钮获取邀请ID
        const divisionId = button.getAttribute('data-division-id');

        // 设置表单的action
        form.action = "{{ url_for('defect.send_division_reminder', division_id=0) }}".replace('0', divisionId);

        // 清空文本区域
        reasonTextarea.value = '';
    });

    // 为提交按钮添加点击事件监听
    submitButton.addEventListener('click', function(event) {
        // 阻止默认的表单提交行为
        event.preventDefault();

        // 检查跟催原因是否已输入
        if (!reasonTextarea.value.trim()) {
            // 显示警告提示
            showToast('warning','跟催原因不能为空，请输入后再提交');
            return false;
        }

        // 如果已输入，提交表单
        form.submit();
        showToast('info','跟催邮件和跟催消息已发送...');
    });
});
</script>

<!--转处理模态框处理脚本-->
<script>
// 用户数据 - 使用全局变量避免重复声明

$(document).ready(function() {
    let selectedTransferMember = null;

    // 成员搜索功能 - 转处理模态框
    $('#transferSearch').on('input', function() {
        var searchTerm = $(this).val().toLowerCase().trim();
        var $dropdown = $('#transferDropdown');

        if (searchTerm.length === 0) {
            selectedTransferMember = null;
            $('#selectedTransferName').html('通过Email账号搜索成员，此处将会自动填充姓名').css('color', '#999');
            $dropdown.hide();
            return;
        }

        // 搜索匹配的成员
        var matchedMembers = userList.filter(function(member) {
            return member.email.toLowerCase().includes(searchTerm) ||
                   member.name.includes(searchTerm);
        });

        if (matchedMembers.length > 0) {
            // 生成下拉框内容
            var dropdownHtml = '';
            matchedMembers.forEach(function(member) {
                dropdownHtml += `
                        <div class="member-dropdown-item"
                             data-userid="${member.user_id}"
                             data-email="${member.email}"
                             data-name="${member.name}"
                             data-department="${member.department}">
                            ${member.name} / ${member.email}
                        </div>`;
            });

            $dropdown.html(dropdownHtml).show();
        } else {
            selectedTransferMember = null;
            $('#selectedTransferName').html('未找到匹配的成员').css('color', '#ff6b6b');
            $dropdown.hide();
        }
    });

    // 下拉框选项点击事件 - 转处理模态框
    $(document).on('click', '#transferDropdown .member-dropdown-item', function() {
        var $item = $(this);
        var email = $item.data('email');
        var name = $item.data('name');
        var userID = $item.data('userid');
        var department = $item.data('department');

        // 设置选中的成员
        selectedTransferMember = {
            userID: userID,
            email: email,
            name: name,
            department: department
        };

        // 填充输入框和姓名显示
        $('#transferSearch').val(email);
        $('#transfer_to_user_id').val(userID);
        $('#selectedTransferName').html(name + ' (' + department + ')').css('color', '#222');

        // 隐藏下拉框
        $('#transferDropdown').hide();
    });

    // 点击其他地方隐藏下拉框 - 转处理模态框
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#transferSearch, #transferDropdown').length) {
            $('#transferDropdown').hide();
        }
    });

   // 表单提交事件 - 转处理模态框
    $('#transferForm').on('submit', function(e) {
        var transferReason = $('#transfer_reason').val().trim();

        if (!selectedTransferMember) {
            e.preventDefault();
            showToast('warning', '请先搜索并选择一个成员');
            return;
        }

        if (!transferReason) {
            e.preventDefault();
            showToast('warning', '请输入转处理原因');
            return;
        }

        // 显示处理中提示
        showToast('info', '正在转交处理...', 3000);
    });

    // 模态框关闭时重置表单
    $('#transferModal').on('hidden.bs.modal', function () {
        $('#transferSearch').val('');
        $('#transfer_to_user_id').val('');
        $('#selectedTransferName').html('通过Email账号搜索成员，此处将会自动填充姓名').css('color', '#999');
        $('#transfer_reason').val('');
        selectedTransferMember = null;
    });
});
</script>


<!--指定测试人员按钮点击事件-->
<script>
    // 指定测试人员按钮点击事件
    var assignTestBtn = document.getElementById('assignTestBtn');
    if (assignTestBtn) {
        assignTestBtn.addEventListener('click', function() {
            // 清空填充数据
            document.getElementById('testMemberSearch').value = '';
            document.getElementById('testComment').value = '';
            document.getElementById('selectedTestMemberName').textContent = '通过Email账号搜索测试人员，此处将会自动填充姓名';
            document.getElementById('selectedTestMemberName').style.color = '#999';
            document.getElementById('testMemberDropdown').style.display = 'none';
            selectedTestMember = null;
        });
    };

        let selectedTestMember = null;

        // 测试人员搜索功能
        document.getElementById('testMemberSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const dropdown = document.getElementById('testMemberDropdown');

            if (searchTerm.length === 0) {
                selectedTestMember = null;
                document.getElementById('selectedTestMemberName').textContent = '通过Email账号搜索测试人员，此处将会自动填充姓名';
                document.getElementById('selectedTestMemberName').style.color = '#999';
                dropdown.style.display = 'none';
                return;
            }

            // 搜索匹配的成员
            const matchedMembers = userList.filter(function(member) {
                return member.email.toLowerCase().includes(searchTerm) ||
                       member.name.includes(searchTerm);
            });

            if (matchedMembers.length > 0) {
                // 生成下拉框内容
                let dropdownHtml = '';
                matchedMembers.forEach(function(member) {
                    dropdownHtml += `
                        <div class="test-member-dropdown-item member-dropdown-item"
                             data-userID="${member.user_id}"
                             data-email="${member.email}"
                             data-name="${member.name}"
                             data-department="${member.department}">
                            ${member.name} / ${member.email}
                        </div>`;
                });

                dropdown.innerHTML = dropdownHtml;
                dropdown.style.display = 'block';
            } else {
                selectedTestMember = null;
                document.getElementById('selectedTestMemberName').textContent = '未找到匹配的测试人员';
                document.getElementById('selectedTestMemberName').style.color = '#ff6b6b';
                dropdown.style.display = 'none';
            }
        });

        // 测试人员下拉框选项点击事件
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('test-member-dropdown-item')) {
                const item = e.target;
                const email = item.getAttribute('data-email');
                const name = item.getAttribute('data-name');
                const userID = item.getAttribute('data-userID');
                const department = item.getAttribute('data-department');

                // 设置选中的测试人员
                selectedTestMember = {
                    userID: userID,
                    email: email,
                    name: name,
                    department: department
                };

                // 填充输入框和姓名显示
                document.getElementById('tester_id').value = userID;
                document.getElementById('testMemberSearch').value = email;
                document.getElementById('selectedTestMemberName').textContent = `${name} (${department})`;
                document.getElementById('selectedTestMemberName').style.color = '#222';

                // 隐藏下拉框
                document.getElementById('testMemberDropdown').style.display = 'none';
            }
        });

        // 点击其他地方隐藏测试人员下拉框
        document.addEventListener('click', function(e) {
            const search = document.getElementById('testMemberSearch');
            const dropdown = document.getElementById('testMemberDropdown');

            if (e.target !== search && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // 表单提交事件
        document.querySelector('#assignTesterModal').addEventListener('submit', function(e) {
            const testComment = document.getElementById('testComment').value.trim();

            if (!selectedTestMember) {
                e.preventDefault();
                showToast('warning', '请先搜索并选择一个测试人员');
                return;
            }

            if (!testComment) {
                e.preventDefault();
                showToast('warning', '请输入测试说明');
                return;
            }

            showToast('success', '测试人员指定成功！');
            // 在实际应用中，这里会提交表单，此处仅做演示
        });
    </script>

<!--图片放大 效果-->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 创建图片放大所需的DOM元素
            const overlay = document.createElement('div');
            overlay.className = 'image-modal-overlay';

            const content = document.createElement('div');
            content.className = 'image-modal-content';

            const img = document.createElement('img');
            img.className = 'image-modal-img';

            const closeBtn = document.createElement('div');
            closeBtn.className = 'image-modal-close';
            closeBtn.innerHTML = '&times;';

            const caption = document.createElement('div');
            caption.className = 'image-modal-caption';

            // 组装元素
            content.appendChild(img);
            content.appendChild(closeBtn);
            content.appendChild(caption);
            overlay.appendChild(content);

            // 添加到body
            document.body.appendChild(overlay);

            // 获取所有需要放大的图片
            const images = document.querySelectorAll('#defect_description img, #cause_analysis img, #solution_content img, #result_content img, .view-mode-content img, .solution-content-show img');

            // 为图片添加点击事件
            images.forEach(function(image) {
                image.addEventListener('click', function() {
                    // 设置放大图片的src和alt
                    img.src = this.src;
                    caption.textContent = this.alt || '图片预览';

                    // 显示模态框
                    overlay.classList.add('active');

                    // 阻止事件冒泡
                    event.stopPropagation();
                });
            });

            // 关闭模态框的事件
            closeBtn.addEventListener('click', function() {
                overlay.classList.remove('active');
                event.stopPropagation();
            });

            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    overlay.classList.remove('active');
                }
            });

            // 支持ESC键关闭
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && overlay.classList.contains('active')) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>

{% include "components/defect_flow_histories.html" %}
{% include  "components/ai_done.html" %}
</body>
</html>